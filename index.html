<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>卡牌肉鸽冒险</title>
    <style>
        /* 移动设备响应式设计 - 全面优化 */
        @media screen and (max-width: 768px) {
            /* 基础布局调整 */
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .screen {
                padding: 8px;
                min-height: calc(100vh - 20px);
                display: flex;
                flex-direction: column;
            }
            
            /* 游戏标题优化 */
            .game-title {
                font-size: 2rem;
                margin-bottom: 15px;
            }
            
            h2 {
                font-size: 1.4rem;
                margin-bottom: 15px;
                text-align: center;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            /* 首页菜单优化 */
            .home-menu {
                padding: 30px 15px;
            }
            
            .home-menu h1 {
                font-size: 2.2rem;
                margin-bottom: 30px;
            }
            
            .home-buttons {
                gap: 15px;
                max-width: 280px;
            }
            
            .home-btn {
                padding: 18px 25px;
                font-size: 1.1rem;
                border-radius: 12px;
                letter-spacing: 0.5px;
            }
            
            .game-intro {
                margin: 30px auto 0;
                padding: 20px;
                border-radius: 12px;
            }
            
            .game-intro p {
                font-size: 0.9rem;
                line-height: 1.5;
            }
            
            /* 战斗界面优化 */
            .battle-area {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
                min-height: calc(100vh - 100px);
                height: auto;
                border-radius: 15px;
            }
            
            /* 敌人区域优化 */
            .enemy {
                width: 100%;
                margin-bottom: 8px;
                padding: 8px;
                border-radius: 12px;
                max-height: 160px;
            }
            
            .enemy-display {
                padding: 8px;
            }
            
            .enemy-art {
                width: 60px;
                height: 60px;
                margin-bottom: 6px;
            }
            
            /* 玩家状态区域优化 */
            .player-status {
                width: 100%;
                padding: 8px;
                margin: 6px 0;
                border-radius: 12px;
            }
            
            /* 能量显示优化 */
            .energy-display {
                font-size: 1rem;
                margin-bottom: 6px;
                padding: 10px 18px;
                border-radius: 25px;
                min-width: 100px;
                text-align: center;
            }
            
            /* 生命值条优化 */
            .health-bar {
                height: 16px;
                border-radius: 8px;
                margin: 4px 0;
            }
            
            /* 手牌区域深度优化 */
            .hand {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 10px 0 15px 0;
                gap: 6px;
                flex: 1;
                align-items: flex-end;
                min-height: 160px;
            }
            
            .hand::-webkit-scrollbar {
                display: none;
            }
            
            .hand .card {
                min-width: 110px;
                width: 110px;
                height: 155px;
                flex-shrink: 0;
                transform: perspective(1000px) rotateX(10deg);
            }
            
            /* 卡牌尺寸全面优化 */
            .card {
                width: 110px;
                height: 155px;
                font-size: 0.7rem;
                padding: 8px;
                border-radius: 10px;
                border-width: 2px;
                touch-action: manipulation;
            }
            
            .card-name {
                font-size: 0.8rem;
                margin-bottom: 3px;
                line-height: 1.1;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .card-cost {
                font-size: 0.8rem;
                padding: 3px 8px;
                border-radius: 10px;
                margin: 3px 0;
            }
            
            .card-description {
                font-size: 0.65rem;
                line-height: 1.25;
                -webkit-line-clamp: 4;
                margin-top: 4px;
                height: 40px;
            }
            
            .card-art {
                height: 65px;
            }
            
            /* 角色选择界面深度优化 */
            .character-select {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 0 15px;
            }
            
            .character-card {
                padding: 18px;
                min-height: 240px;
                border-radius: 15px;
            }
            
            .character-card h3 {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            .character-card p {
                font-size: 0.8rem;
                line-height: 1.4;
                margin-bottom: 8px;
            }
            
            /* 按钮全面优化 - 增大触摸区域 */
            .btn {
                padding: 15px 24px;
                font-size: 1rem;
                min-width: 140px;
                margin: 8px auto;
                display: block;
                border-radius: 28px;
                letter-spacing: 0.5px;
            }
            
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            /* 战斗日志优化 */
            .log {
                max-height: 100px;
                font-size: 0.8rem;
                line-height: 1.4;
                padding: 10px;
                border-radius: 10px;
                margin-top: 8px;
            }
            
            /* 奖励界面优化 */
            .rewards {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-top: 15px;
            }
            
            .reward-card {
                padding: 20px 15px;
                min-height: 120px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            /* 牌组管理界面优化 */
            .deck-area {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .deck-section {
                padding: 15px;
                border-radius: 12px;
            }
            
            .cards-scroll-area {
                max-height: 250px;
                padding-right: 8px;
            }
            
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                justify-items: center;
            }
            
            /* 统计信息优化 */
            .game-stats {
                flex-direction: column;
                gap: 15px;
                padding: 0 20px;
            }
            
            .stat {
                padding: 12px 15px;
                text-align: center;
            }
        }
        
        /* 小屏幕手机额外优化 */
        @media screen and (max-width: 480px) {
            .game-title {
                font-size: 1.8rem;
            }
            
            .home-menu h1 {
                font-size: 1.9rem;
            }
            
            .hand .card,
            .card {
                min-width: 100px;
                width: 100px;
                height: 140px;
                font-size: 0.65rem;
            }
            
            .card-name {
                font-size: 0.75rem;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 0.9rem;
                min-width: 120px;
            }
            
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .battle-area {
                padding: 10px;
            }
        }
        
        /* 超大屏幕优化 - 确保游戏在平板上也有良好体验 */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .character-select {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .cards-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* 触摸设备全面优化 */
        @media (hover: none) and (pointer: coarse) {
            /* 全局触摸行为优化 */
            * {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* 卡牌触摸效果增强 */
            .card {
                transition: transform 0.1s ease, box-shadow 0.1s ease;
            }
            
            .card:active {
                transform: scale(0.93);
                box-shadow: 
                    0 2px 4px rgba(0,0,0,0.4),
                    inset 0 2px 4px rgba(0,0,0,0.3);
            }
            
            /* 按钮触摸效果增强 */
            .btn {
                transition: transform 0.1s ease, box-shadow 0.1s ease;
            }
            
            .btn:active {
                transform: scale(0.97);
                box-shadow: 
                    0 2px 8px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(0,0,0,0.2);
            }
            
            /* 角色卡片触摸效果 */
            .character-card:active {
                transform: scale(0.98);
                border-color: #ffb347;
            }
            
            /* 奖励卡片触摸效果 */
            .reward-card:active {
                transform: scale(0.98);
                border-color: #ffb347;
                background: rgba(255,255,255,0.15);
            }
        }
        
        /* 按钮组样式 */
        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        /* 移动端垂直按钮组 */
        .btn-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }
        
        /* 全屏容器修复 */
        html, body {
            height: 100%;
            overflow-x: hidden;
            -webkit-text-size-adjust: none;
            -webkit-overflow-scrolling: touch;
        }
        
        /* 优化移动设备上的表单元素 */
        input, select, textarea {
            font-size: 16px;
            -webkit-appearance: none;
            border-radius: 8px;
            padding: 12px;
        }
        
        /* 防止长按弹出菜单 */
        .no-context-menu {
            -webkit-touch-callout: none;
        }
        
        /* 优化滚动行为 */
        * {
            scroll-behavior: smooth;
        }
        
        /* 防止文本选择 */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-image: url('backgroudImage.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
            color: white;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4); /* 添加半透明黑色叠加，提高文字可读性 */
            pointer-events: none;
            z-index: -1;
        }
        
        html {
            height: 100%;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .game-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .stat {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .screen.active {
            display: block;
        }
        
        /* 首页菜单显示时隐藏游戏统计信息 */
        #homeScreen.active {
            position: relative;
        }
        
        #homeScreen.active ~ .game-header .game-stats {
            display: none;
        }
        
        /* 首页菜单样式 */
        .home-menu {
            text-align: center;
            padding: 50px 20px;
        }
        
        .home-menu h1 {
            font-size: 3rem;
            margin-bottom: 50px;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            to { text-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5); }
        }
        
        .home-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .home-btn {
            width: 100%;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .home-btn:hover {
            background: rgba(102, 126, 234, 0.4);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* 游戏简介样式 */
        .game-intro {
            max-width: 600px;
            margin: 40px auto 0;
            padding: 25px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 1s ease-out;
        }
        
        .game-intro h3 {
            color: #ffd700;
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .game-intro p {
            color: #fff;
            margin-bottom: 10px;
            line-height: 1.6;
            text-align: left;
        }
        
        .game-intro p strong {
            color: #667eea;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .character-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 0 auto 40px;
            max-width: 1200px;
            padding: 0 20px;
        }
        
        .character-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .character-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .character-card:hover {
            border-color: #ffd700;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .character-card.selected {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }
        
        .character-icon {
            font-size: 20rem;
            margin-bottom: 10px;
        }
        
        .deck-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .deck-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .cards-scroll-area {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
        
        .cards-scroll-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .cards-scroll-area::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
        
        .cards-scroll-area::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }
        
        .cards-scroll-area::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 140px);
            gap: 12px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .card {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border: 3px solid #ffd700;
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
            width: 140px;
            height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.3), 
                inset 0 1px 0 rgba(255,255,255,0.2),
                0 0 20px rgba(255,215,0,0.1);
        }
        
        /* 角色图标样式 */
        .character-icon {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 25px;
            font-weight: bold;
            color: black;
            z-index: 10;
            border: 1px solid rgba(0,0,0,0.3);
        }
        
        .character-knight { background: #FFD700; } /* 金色 - 骑士 */
        .character-priest { background: #FFFFFF; } /* 白色 - 牧师 */
        .character-warlock { background: #800080; color: white; } /* 紫色 - 术士 */
        .character-hunter { background: #008000; color: white; } /* 绿色 - 猎人 */
        .character-warrior { background: #8B0000; color: white; } /* 红色 - 战士 */
        .character-rogue { background: #8B4513; color: white; } /* 棕色 - 盗贼 */
        .character-mage { background: #0000FF; color: white; } /* 蓝色 - 法师 */
        .character-neutral { background: #C0C0C0; } /* 银色 - 通用 */
        .character-curse { background: #4B0082; color: white; } /* 靛蓝色 - 诅咒 */
        .character-legendary { background: #FFA500; } /* 橙色 - 传说 */
        
        /* 卡牌分类样式 */
        .card-category {
            margin-top: 20px;
            margin-bottom: 15px;
        }
        
        .category-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            padding: 8px 12px;
            background-color: #f0f0f0;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
        }
        
        .category-header.current-character {
            border-left: 4px solid #2196F3;
            background-color: #e3f2fd;
            font-size: 17px;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            border-radius: 12px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card-art {
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            position: relative;
        }
        
        .stickman-art {
            width: 50px;
            height: 50px;
            position: relative;
        }
        
        .card.attack {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-color: #ff4444;
        }
        
        .card.defense {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border-color: #00bcd4;
        }
        
        .card.magic {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #333;
            border-color: #9c27b0;
        }
        
        .card.special {
            background: linear-gradient(135deg, #ffd89b, #19547b);
            border-color: #ff9800;
        }
        
        .card.curse {
            background: linear-gradient(135deg, #2c1810, #8b0000);
            border-color: #ff0000;
            box-shadow: 0 4px 8px rgba(255, 0, 0, 0.5), inset 0 1px 0 rgba(255,0,0,0.2);
        }
        
        .card.rarity-common {
            border-color: #ffffff;
        }
        
        .card.rarity-uncommon {
            border-color: #00ff00;
            box-shadow: 0 4px 8px rgba(0, 255, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .card.rarity-rare {
            border-color: #0080ff;
            box-shadow: 0 4px 8px rgba(0, 128, 255, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .card.rarity-curse {
            border-color: #ff0000;
            box-shadow: 0 4px 8px rgba(255, 0, 0, 0.5), inset 0 1px 0 rgba(255,0,0,0.2);
        }
        
        .card.rarity-legendary {
            border-color: #ffd700;
            background: linear-gradient(135deg, #ffd700, #ff8c00, #ffd700);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.8), inset 0 1px 0 rgba(255,255,255,0.3);
            animation: legendaryGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes legendaryGlow {
            from { 
                box-shadow: 0 4px 12px rgba(255, 215, 0, 0.8), inset 0 1px 0 rgba(255,255,255,0.3);
                transform: scale(1);
            }
            to { 
                box-shadow: 0 6px 20px rgba(255, 215, 0, 1), inset 0 1px 0 rgba(255,255,255,0.5);
                transform: scale(1.02);
            }
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .card-name {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 0.8rem;
            line-height: 1.1;
        }
        
        .card-cost {
            font-size: 0.7rem;
            opacity: 0.9;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 8px;
            margin: 2px 0;
        }
        
        .card-description {
            font-size: 0.65rem;
            line-height: 1.2;
            opacity: 0.9;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            margin-top: 3px;
        }
        
        .battle-area {
            background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(255,255,255,0.1));
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            height: auto;
            min-height: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .enemy {
            text-align: center;
            margin-bottom: 12px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(255,0,0,0.2), rgba(139,0,0,0.3));
            border: 2px solid rgba(255,0,0,0.4);
            border-radius: 15px;
            position: relative;
            box-shadow: 0 4px 16px rgba(255,0,0,0.2);
            flex-shrink: 0;
            max-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .enemy::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff0000, #ff4444, #ff0000);
            border-radius: 15px;
            z-index: -1;
            animation: enemyGlow 2s ease-in-out infinite alternate;
        }
        
        .enemy.boss::before {
            background: linear-gradient(45deg, #ffd700, #ff8c00, #ffd700, #ff8c00);
            animation: bossGlow 1.5s ease-in-out infinite alternate;
        }
        
        .boss-phase {
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,140,0,0.3));
            border: 2px solid rgba(255,215,0,0.6);
            border-radius: 10px;
            padding: 8px;
            margin: 4px 0;
            text-align: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        @keyframes bossGlow {
            from { 
                opacity: 0.6;
                background: linear-gradient(45deg, #ffd700, #ff8c00, #ffd700, #ff8c00);
            }
            to { 
                opacity: 1;
                background: linear-gradient(45deg, #ffff00, #ffd700, #ffff00, #ffd700);
            }
        }
        
        @keyframes enemyGlow {
            from { opacity: 0.3; }
            to { opacity: 0.7; }
        }
        
        .enemy-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            min-height: 0;
        }
        
        .enemy-art {
            width: 45px;
            height: 45px;
            margin-bottom: 4px;
            position: relative;
            flex-shrink: 0;
        }
        
        .health-bar {
            background: rgba(0,0,0,0.4);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 3px 0;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
            width: 100%;
            flex-shrink: 0;
        }
        
        .health-fill {
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
            height: 100%;
            transition: width 0.5s ease;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .player-health .health-fill {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
        }
        
        .player-status {
            background: linear-gradient(135deg, rgba(0,255,0,0.1), rgba(0,200,0,0.2));
            border: 2px solid rgba(0,255,0,0.3);
            border-radius: 15px;
            padding: 8px;
            margin: 8px 0;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,255,0,0.1);
            flex-shrink: 0;
        }
        
        .energy-display {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(255,215,0,0.3);
        }
        
        .hand {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 8px;
            flex: 1;
            align-items: flex-start;
            min-height: 140px;
        }
        
        .hand .card {
            min-width: 90px;
            width: 90px;
            height: 140px;
            font-size: 0.65rem;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.2);
            /* iOS触摸优化 */
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.3);
            user-select: none;
            touch-action: manipulation;
            min-width: 120px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(0,0,0,0.3),
                0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:disabled::before {
            display: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #333;
        }
        
        .btn-primary:hover {
            box-shadow: 
                0 6px 20px rgba(0,0,0,0.3),
                0 0 30px rgba(255, 215, 0, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .btn-danger:hover {
            box-shadow: 
                0 6px 20px rgba(0,0,0,0.3),
                0 0 30px rgba(255, 107, 107, 0.4);
        }
        
        .rewards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .reward-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .reward-card:hover {
            border-color: #ffd700;
            transform: translateY(-5px);
        }
        
        .log {
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            min-height: 80px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.85rem;
            flex-shrink: 0;
            border: 2px solid rgba(255,215,0,0.4);
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        }
        
        /* 美化滚动条 */
        .log::-webkit-scrollbar {
            width: 8px;
        }
        
        .log::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        .log::-webkit-scrollbar-thumb {
            background: rgba(255,215,0,0.5);
            border-radius: 4px;
        }
        
        .log::-webkit-scrollbar-thumb:hover {
            background: rgba(255,215,0,0.7);
        }
        
        .log-entry {
            margin-bottom: 6px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            color: #fff;
            line-height: 1.4;
        }
        
        /* 为不同类型的日志添加不同颜色 */
        .log-entry.damage {
            color: #ff8888;
        }
        
        .log-entry.heal {
            color: #88ff88;
        }
        
        .log-entry.buff {
            color: #8888ff;
        }
        
        .log-entry.debuff {
            color: #ff88ff;
        }
        
        .log-entry.system {
            color: #ffcc88;
        }
        
        .buff {
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,140,0,0.2));
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 6px 12px;
            margin: 3px;
            display: inline-block;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 
                0 2px 6px rgba(255,215,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .buff::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: buffShine 2s ease-in-out infinite;
        }
        
        @keyframes buffShine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }
        
        .damage-number {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 1000;
            animation: damageFloat 1s ease-out forwards;
        }
        
        .heal-number {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #44ff44;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 1000;
            animation: damageFloat 1s ease-out forwards;
        }
        
        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
            }
        }
        
        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .flash-red {
            animation: flashRed 0.3s ease-in-out;
        }
        
        @keyframes flashRed {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(255, 0, 0, 0.3); }
        }
        
        /* 教程按钮样式 */
        .tutorial-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* 怪物图鉴按钮样式 */
        .monster-pedia-button {
            position: fixed;
            top: 20px;
            right: 160px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .monster-pedia-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .tutorial-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* 教程弹窗样式 */
        .tutorial-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .tutorial-content {
            background: rgba(255, 255, 255, 0.95);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #333;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .tutorial-content h2 {
            color: #667eea;
            margin-top: 0;
            text-align: center;
            font-size: 2rem;
            margin-bottom: 30px;
        }
        
        .tutorial-content h3 {
            color: #764ba2;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .tutorial-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .tutorial-content ul,
        .tutorial-content ol {
            margin-bottom: 20px;
            padding-left: 25px;
        }
        
        .tutorial-content li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .tutorial-content strong {
            color: #667eea;
        }
        
        /* 教程标签页样式 */
        .tutorial-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .tutorial-tab {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid transparent;
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #667eea;
        }
        
        .tutorial-tab:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .tutorial-tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* 教程标签页内容样式 */
        .tutorial-tab-content {
            display: none;
            animation: tabContentFadeIn 0.3s ease-out;
        }
        
        @keyframes tabContentFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tutorial-tab-content.active {
            display: block;
        }
        
        /* 关闭按钮样式 */
        .tutorial-close,
        .monster-pedia-close {
            color: #667eea;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .tutorial-close:hover,
        .tutorial-close:focus,
        .monster-pedia-close:hover,
        .monster-pedia-close:focus {
            color: #764ba2;
            text-decoration: none;
        }
        
        /* 底部按钮样式 */
        .tutorial-footer,
        .monster-pedia-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        /* 怪物图鉴弹窗样式 */
        .monster-pedia-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .monster-pedia-content {
            background: rgba(255, 255, 255, 0.95);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            color: #333;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .monster-pedia-content h2 {
            color: #667eea;
            margin-top: 0;
            text-align: center;
            font-size: 2rem;
            margin-bottom: 30px;
        }
        
        .monster-pedia-content h3 {
            color: #764ba2;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .monster-pedia-content h4 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .monster-pedia-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .monster-pedia-content ul,
        .monster-pedia-content ol {
            margin-bottom: 20px;
            padding-left: 25px;
        }
        
        .monster-pedia-content li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .monster-pedia-content strong {
            color: #667eea;
        }
        
        /* 怪物图鉴标签页样式 */
        .monster-pedia-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .monster-pedia-tab {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid transparent;
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #667eea;
        }
        
        .monster-pedia-tab:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .monster-pedia-tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* 怪物图鉴标签页内容样式 */
        .monster-pedia-tab-content {
            display: none;
            animation: tabContentFadeIn 0.3s ease-out;
        }
        
        .monster-pedia-tab-content.active {
            display: block;
        }
        
        /* 怪物卡片样式 */
        .monster-card {
            background: rgba(102, 126, 234, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .monster-card:hover {
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }
        
        /* BOSS怪物卡片样式 */
        .boss-card {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.1), rgba(204, 0, 0, 0.1));
            border: 2px solid rgba(255, 153, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .boss-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 153, 0, 0.2) 0%, rgba(255, 153, 0, 0) 70%);
            animation: glowPulse 3s ease-in-out infinite;
        }
        
        .boss-card:hover {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.15), rgba(204, 0, 0, 0.15));
            box-shadow: 0 6px 20px rgba(255, 153, 0, 0.3);
            transform: translateY(-2px);
        }
        
        /* BOSS图标样式 */
        .boss-icon {
            position: relative;
            margin-right: 20px;
        }
        
        /* BOSS艺术图像样式 */
        .boss-art {
            width: 60px;
            height: 60px;
            animation: dragonFloat 5s ease-in-out infinite;
        }
        
        /* BOSS名称样式 */
        .boss-name {
            color: #ff9900;
            text-shadow: 0 0 8px rgba(255, 153, 0, 0.6);
            font-size: 1.4rem;
        }
        
        /* 动画效果 */
        @keyframes glowPulse {
            0%, 100% {
                opacity: 0.3;
                transform: scale(0.9);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }
        
        @keyframes dragonFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            25% {
                transform: translateY(-5px) rotate(2deg);
            }
            75% {
                transform: translateY(5px) rotate(-2deg);
            }
        }
        
        .monster-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .monster-icon {
            font-size: 2rem;
            margin-right: 15px;
        }
        
        .monster-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
            margin: 0;
        }
        
        .monster-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        
        .ability-list {
            margin-top: 15px;
        }
        
        .ability-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .ability-icon {
            font-size: 1.2rem;
            margin-right: 10px;
            margin-top: 2px;
        }
        
        .ability-info {
            flex: 1;
        }
        
        .ability-name {
            font-weight: bold;
            color: #764ba2;
        }
        
        .phase-indicator {
            background: #764ba2;
            color: white;
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .phase-divider {
            height: 3px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 30px 0;
            border: none;
        }
        
        /* 奖励界面样式优化 */
        .rewards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 800px;
            margin: 30px auto;
        }
        
        .reward-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            width: 220px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .reward-card:hover {
            border-color: #ffd700;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }
        
        .reward-card h3 {
            color: #ffd700;
            margin-top: 0;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .reward-card p {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .reward-card p:last-child {
            font-size: 0.9rem;
            color: #ccc;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- 教程按钮 -->
    <div id="monsterPediaButton" class="monster-pedia-button">
        📖 怪物图鉴
    </div>
    
    <div id="tutorialButton" class="tutorial-button">
        ❓ 教程
    </div>
    
    <!-- 怪物图鉴弹窗 -->
    <div id="monsterPediaModal" class="monster-pedia-modal">
        <div class="monster-pedia-content">
            <span class="monster-pedia-close">&times;</span>
            <h2>怪物图鉴</h2>
            
            <div class="monster-pedia-tabs">
                    <button class="monster-pedia-tab active" data-tab="normalMonsters">普通怪物</button>
                    <button class="monster-pedia-tab" data-tab="eliteMonsters">精英怪物</button>
                    <button class="monster-pedia-tab" data-tab="bossMonsters">BOSS怪物</button>
                </div>
            
            <div id="normalMonsters" class="monster-pedia-tab-content active">
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">👹</div>
                        <h3 class="monster-name">哥布林</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 28</div>
                        <div class="stat-item">攻击力: 6</div>
                        <div class="stat-item">类型: 基础</div>
                    </div>
                    <p>最基础的敌人，攻击简单直接。作为新手遇到的第一个敌人，他们行动模式简单，是熟悉战斗系统的好对手。</p>
                </div>
                
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">🏹</div>
                        <h3 class="monster-name">哥布林弓手</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 22</div>
                        <div class="stat-item">攻击力: 8</div>
                        <div class="stat-item">类型: 远程</div>
                    </div>
                    <p>远程攻击敌人，有几率造成额外伤害。虽然生命值较低，但高攻击力和精准射击能力让他们成为不可小觑的威胁。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🎯</div>
                            <div class="ability-info">
                                <div class="ability-name">精准射击</div>
                                <div class="ability-description">有几率对玩家造成额外的穿透伤害。</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">🧌</div>
                        <h3 class="monster-name">兽人战士</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 42</div>
                        <div class="stat-item">攻击力: 10</div>
                        <div class="stat-item">类型: 近战</div>
                    </div>
                    <p>强壮的近战敌人，当生命值降低时会进入狂怒状态，攻击力大幅提升。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">⚔️</div>
                            <div class="ability-info">
                                <div class="ability-name">狂怒</div>
                                <div class="ability-description">当生命值低于50%时，攻击力提升50%。</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">🥷</div>
                        <h3 class="monster-name">暗影刺客</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 30</div>
                        <div class="stat-item">攻击力: 12</div>
                        <div class="stat-item">类型: 刺客</div>
                    </div>
                    <p>擅长潜行和毒素攻击的敌人，行动迅速，难以被攻击命中。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">👻</div>
                            <div class="ability-info">
                                <div class="ability-name">潜行</div>
                                <div class="ability-description">有几率闪避玩家的攻击。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🩸</div>
                            <div class="ability-info">
                                <div class="ability-name">毒素</div>
                                <div class="ability-description">攻击会使玩家中毒，每回合造成持续伤害。</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="eliteMonsters" class="monster-pedia-tab-content">
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">🗿</div>
                        <h3 class="monster-name">石头巨人</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 65</div>
                        <div class="stat-item">攻击力: 8</div>
                        <div class="stat-item">类型: 坦克</div>
                    </div>
                    <p>高血量高防御的精英敌人，攻击者会受到反伤。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🛡️</div>
                            <div class="ability-info">
                                <div class="ability-name">护甲</div>
                                <div class="ability-description">有几率获得额外的护甲，减少受到的伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🌵</div>
                            <div class="ability-info">
                                <div class="ability-name">荆棘</div>
                                <div class="ability-description">攻击者会受到所造成伤害的一部分反弹。</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">👺</div>
                        <h3 class="monster-name">火焰恶魔</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 48</div>
                        <div class="stat-item">攻击力: 14</div>
                        <div class="stat-item">类型: 魔法</div>
                    </div>
                    <p>掌控火焰的精英敌人，火焰攻击会造成持续燃烧伤害。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🔥</div>
                            <div class="ability-info">
                                <div class="ability-name">燃烧</div>
                                <div class="ability-description">攻击会使玩家燃烧，每回合造成持续伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🛡️🔥</div>
                            <div class="ability-info">
                                <div class="ability-name">火焰护盾</div>
                                <div class="ability-description">有几率获得火焰护盾，减少受到的伤害并对攻击者造成燃烧效果。</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">🧙‍♂️</div>
                        <h3 class="monster-name">冰霜法师</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 38</div>
                        <div class="stat-item">攻击力: 10</div>
                        <div class="stat-item">类型: 魔法</div>
                    </div>
                    <p>精通冰霜魔法的法师，攻击会冰冻敌人，使其无法行动。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">❄️</div>
                            <div class="ability-info">
                                <div class="ability-name">冰冻</div>
                                <div class="ability-description">攻击有几率冰冻玩家，使其无法行动一回合。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🛡️❄️</div>
                            <div class="ability-info">
                                <div class="ability-name">冰甲</div>
                                <div class="ability-description">有几率获得冰甲，大幅减少受到的物理伤害。</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="bossMonsters" class="monster-pedia-tab-content">
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">🐲</div>
                        <h3 class="monster-name">暗影龙王</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 200</div>
                        <div class="stat-item">攻击力: 18</div>
                        <div class="stat-item">类型: BOSS (第5关)</div>
                    </div>
                    <p>第5关的守关BOSS，拥有强大的暗影魔法和召唤能力。随着战斗进行，它会进入不同阶段，变得越来越强大。</p>
                    
                    <h4><span class="phase-indicator">觉醒阶段</span></h4>
                    <p>暗影龙王苏醒，使用基础攻击。这是战斗的开始阶段，BOSS还没有展现全部实力。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🌑</div>
                            <div class="ability-info">
                                <div class="ability-name">暗影吐息</div>
                                <div class="ability-description">喷射暗影能量，对玩家造成伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🐉</div>
                            <div class="ability-info">
                                <div class="ability-name">翅膀攻击</div>
                                <div class="ability-description">用强大的翅膀攻击玩家，有几率造成击退效果。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">愤怒阶段</span></h4>
                    <p>当暗影龙王生命值降至70%以下时，它会进入愤怒阶段，召唤暗影分身并释放诅咒光环。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">👥</div>
                            <div class="ability-info">
                                <div class="ability-name">暗影分身</div>
                                <div class="ability-description">召唤一个暗影分身协助战斗，分身具有本体30%的能力。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🪶</div>
                            <div class="ability-info">
                                <div class="ability-name">诅咒光环</div>
                                <div class="ability-description">释放诅咒光环，使玩家每回合受到额外伤害。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">绝望阶段</span></h4>
                    <p>当暗影龙王生命值降至30%以下时，它会进入绝望阶段，扭曲现实并准备最终审判。这是战斗的最后阶段，BOSS会释放其最强大的技能。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🌀</div>
                            <div class="ability-info">
                                <div class="ability-name">现实撕裂</div>
                                <div class="ability-description">撕裂现实，对玩家造成巨额伤害，并有几率摧毁一张手牌。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">⏱️</div>
                            <div class="ability-info">
                                <div class="ability-name">时间扭曲</div>
                                <div class="ability-description">扭曲时间，使玩家下一回合少抽一张牌。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">⚖️</div>
                            <div class="ability-info">
                                <div class="ability-name">最终审判</div>
                                <div class="ability-description">释放终极技能，对玩家造成毁灭性伤害。</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">🌟</div>
                        <h3 class="monster-name">元素领主</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 300</div>
                        <div class="stat-item">攻击力: 22</div>
                        <div class="stat-item">类型: BOSS (第10关)</div>
                    </div>
                    <p>第10关的守关BOSS，掌控四大元素之力，会在战斗中转换不同的形态，每种形态拥有不同的技能和特性。</p>
                    
                    <h4><span class="phase-indicator">火焰形态</span></h4>
                    <p>元素领主以火焰形态出现，燃烧一切。在这个形态下，BOSS的攻击带有火焰属性。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🌠</div>
                            <div class="ability-info">
                                <div class="ability-name">流星打击</div>
                                <div class="ability-description">召唤流星攻击玩家，造成高额伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🔥</div>
                            <div class="ability-info">
                                <div class="ability-name">火焰光环</div>
                                <div class="ability-description">释放火焰光环，使玩家每回合受到燃烧伤害。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">冰霜形态</span></h4>
                    <p>当元素领主生命值降至60%以下时，它会转换为冰霜形态，冰冻战场。在这个形态下，BOSS的攻击带有冰霜属性，并会尝试控制玩家。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">❄️</div>
                            <div class="ability-info">
                                <div class="ability-name">暴风雪</div>
                                <div class="ability-description">召唤暴风雪，对玩家造成持续伤害并降低其攻击速度。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🔒</div>
                            <div class="ability-info">
                                <div class="ability-name">冰牢</div>
                                <div class="ability-description">将玩家困在冰牢中，使其无法行动。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">雷电形态</span></h4>
                    <p>当元素领主生命值降至30%以下时，它会转换为雷电形态，雷电毁灭一切。这是BOSS的最终形态，拥有最强大的攻击力。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">⚡</div>
                            <div class="ability-info">
                                <div class="ability-name">连锁闪电</div>
                                <div class="ability-description">释放连锁闪电，对玩家造成伤害并传导至其他目标。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">⛈️</div>
                            <div class="ability-info">
                                <div class="ability-name">雷暴</div>
                                <div class="ability-description">召唤雷暴，对玩家造成持续伤害并有几率使其麻痹。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">⚡💥</div>
                            <div class="ability-info">
                                <div class="ability-name">能量过载</div>
                                <div class="ability-description">释放过载的能量，对玩家造成毁灭性伤害。</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">🌌</div>
                        <h3 class="monster-name">虚空君主</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 400</div>
                        <div class="stat-item">攻击力: 28</div>
                        <div class="stat-item">类型: BOSS (第15关)</div>
                    </div>
                    <p>第15关的守关BOSS，来自虚空的恐怖存在，能够操控现实和心灵。</p>
                    
                    <h4><span class="phase-indicator">物质形态</span></h4>
                    <p>虚空君主以物质形态降临，使用基础的虚空攻击。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🌌</div>
                            <div class="ability-info">
                                <div class="ability-name">虚空打击</div>
                                <div class="ability-description">用虚空能量攻击玩家，造成伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">💔</div>
                            <div class="ability-info">
                                <div class="ability-name">现实裂痕</div>
                                <div class="ability-description">撕裂现实，对玩家造成伤害并降低其护甲。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">能量形态</span></h4>
                    <p>当虚空君主生命值降至50%以下时，它会转为纯能量体，操控心智。在这个形态下，BOSS会变得更难被攻击，并开始汲取玩家的生命能量。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🩸</div>
                            <div class="ability-info">
                                <div class="ability-name">能量汲取</div>
                                <div class="ability-description">汲取玩家的生命能量，恢复自己的生命值。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🌪️</div>
                            <div class="ability-info">
                                <div class="ability-name">虚空风暴</div>
                                <div class="ability-description">召唤虚空风暴，对玩家造成持续伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🧠</div>
                            <div class="ability-info">
                                <div class="ability-name">心灵控制</div>
                                <div class="ability-description">尝试控制玩家的心灵，使其无法使用某些卡牌。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">终极形态</span></h4>
                    <p>当虚空君主生命值降至20%以下时，它会展现真正力量，威胁现实本身。这是战斗的最后阶段，BOSS会释放其最强大的技能。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">💥</div>
                            <div class="ability-info">
                                <div class="ability-name">现实崩溃</div>
                                <div class="ability-description">使周围的现实崩溃，对玩家造成巨额伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🌀</div>
                            <div class="ability-info">
                                <div class="ability-name">虚空奇点</div>
                                <div class="ability-description">召唤虚空奇点，持续吸取玩家的生命值和能量。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">☠️</div>
                            <div class="ability-info">
                                <div class="ability-name">存在抹除</div>
                                <div class="ability-description">尝试抹除玩家的存在，造成毁灭性伤害。</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="monster-card">
                    <div class="monster-header">
                        <div class="monster-icon">✨</div>
                        <h3 class="monster-name">创世神</h3>
                    </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 500</div>
                        <div class="stat-item">攻击力: 35</div>
                        <div class="stat-item">类型: BOSS (第20关)</div>
                    </div>
                    <p>第20关的守关BOSS，掌控创造与毁灭的力量，会对玩家进行多重试炼。</p>
                    
                    <h4><span class="phase-indicator">审判阶段</span></h4>
                    <p>创世神审判挑战者的资格，使用神圣之力进行攻击。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">⚖️</div>
                            <div class="ability-info">
                                <div class="ability-name">神圣审判</div>
                                <div class="ability-description">释放神圣之力，对玩家造成伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">💫</div>
                            <div class="ability-info">
                                <div class="ability-name">圣光</div>
                                <div class="ability-description">释放圣光，恢复自己的生命值。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">试炼阶段</span></h4>
                    <p>当创世神生命值降至60%以下时，它会展现创造与毁灭的力量，对玩家进行更严峻的试炼。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🌊</div>
                            <div class="ability-info">
                                <div class="ability-name">创造之波</div>
                                <div class="ability-description">释放创造之波，对玩家造成伤害并恢复自己的生命值。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">💥</div>
                            <div class="ability-info">
                                <div class="ability-name">毁灭光束</div>
                                <div class="ability-description">发射毁灭光束，对玩家造成巨额伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🔄</div>
                            <div class="ability-info">
                                <div class="ability-name">时间循环</div>
                                <div class="ability-description">创造时间循环，使玩家的某些状态持续时间延长。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">终极试炼</span></h4>
                    <p>当创世神生命值降至30%以下时，它会释放最终的考验，生死轮回。这是战斗的最后阶段，BOSS会展现其全部力量。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🌀</div>
                            <div class="ability-info">
                                <div class="ability-name">创世纪风暴</div>
                                <div class="ability-description">释放创世纪风暴，对玩家造成持续伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🌍</div>
                            <div class="ability-info">
                                <div class="ability-name">天启</div>
                                <div class="ability-description">释放天启之力，对玩家造成毁灭性伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">♾️</div>
                            <div class="ability-info">
                                <div class="ability-name">重生轮回</div>
                                <div class="ability-description">进入重生轮回状态，每回合恢复生命值，直到被打破。</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="monster-card boss-card">
                        <div class="monster-header">
                            <div class="monster-icon boss-icon">
                                <svg class="enemy-art boss-art" viewBox="0 0 80 80">
                                    <defs>
                                        <linearGradient id="dragonGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#ff9900;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#cc0000;stop-opacity:1" />
                                        </linearGradient>
                                        <radialGradient id="dragonGlow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                            <stop offset="0%" style="stop-color:#ffcc00;stop-opacity:0.8" />
                                            <stop offset="100%" style="stop-color:#ff6600;stop-opacity:0" />
                                        </radialGradient>
                                    </defs>
                                    <g transform="translate(40,40)">
                                        <!-- 头部 -->
                                        <path d="M0,-30 C-15,-25 -20,-15 -20,0 C-20,15 -15,25 0,30 C15,25 20,15 20,0 C20,-15 15,-25 0,-30 Z" fill="url(#dragonGradient)" />
                                        <!-- 眼睛 -->
                                        <circle cx="-10" cy="-10" r="3" fill="white" />
                                        <circle cx="10" cy="-10" r="3" fill="white" />
                                        <circle cx="-10" cy="-10" r="1.5" fill="#0000ff" />
                                        <circle cx="10" cy="-10" r="1.5" fill="#0000ff" />
                                        <!-- 鼻子 -->
                                        <path d="M0,-25 L-5,-20 L5,-20 Z" fill="#333333" />
                                        <!-- 嘴巴 -->
                                        <path d="M-15,-5 C-10,0 -10,5 0,10 C10,5 10,0 15,-5" stroke="#333333" stroke-width="2" fill="none" />
                                        <!-- 牙齿 -->
                                        <path d="M-10,-2 L-10,2 L-8,-2 Z" fill="white" />
                                        <path d="M0,10 L0,14 L2,10 Z" fill="white" />
                                        <path d="M10,-2 L10,2 L8,-2 Z" fill="white" />
                                        <!-- 角 -->
                                        <path d="M0,-30 L-5,-40 L-3,-38 L0,-32 Z" fill="url(#dragonGradient)" />
                                        <path d="M0,-30 L5,-40 L3,-38 L0,-32 Z" fill="url(#dragonGradient)" />
                                        <!-- 身体 -->
                                        <path d="M0,20 C0,30 -10,40 -20,40 C-30,40 -40,30 -40,20 C-40,10 -30,0 -20,0 C-15,5 -10,10 0,20 Z" fill="url(#dragonGradient)" />
                                        <path d="M0,20 C0,30 10,40 20,40 C30,40 40,30 40,20 C40,10 30,0 20,0 C15,5 10,10 0,20 Z" fill="url(#dragonGradient)" />
                                        <!-- 翅膀 -->
                                        <path d="M20,5 C25,15 35,25 35,15 C35,5 30,0 20,5 Z" fill="url(#dragonGradient)" opacity="0.8" />
                                        <path d="M-20,5 C-25,15 -35,25 -35,15 C-35,5 -30,0 -20,5 Z" fill="url(#dragonGradient)" opacity="0.8" />
                                        <!-- 尾巴 -->
                                        <path d="M0,40 C5,45 10,50 15,55" stroke="url(#dragonGradient)" stroke-width="4" fill="none" />
                                        <!-- 爪子 -->
                                        <path d="M-20,40 L-25,45 L-22,45 L-20,42 Z" fill="#333333" />
                                        <path d="M20,40 L25,45 L22,45 L20,42 Z" fill="#333333" />
                                        <!-- 发光效果 -->
                                        <circle cx="0" cy="0" r="45" fill="url(#dragonGlow)" />
                                        <!-- 能量效果 -->
                                        <circle cx="0" cy="10" r="15" fill="none" stroke="#ffcc00" stroke-width="2" stroke-dasharray="5,3" opacity="0.6" />
                                        <!-- 腹部纹饰 -->
                                        <path d="M0,0 C-5,5 0,10 5,5" stroke="#ffcc00" stroke-width="2" fill="none" />
                                        <path d="M0,5 C-3,10 0,15 3,10" stroke="#ffcc00" stroke-width="2" fill="none" />
                                    </g>
                                </svg>
                            </div>
                            <h3 class="monster-name boss-name">源初魔龙尼伯罗根</h3>
                        </div>
                    <div class="monster-stats">
                        <div class="stat-item">生命值: 650</div>
                        <div class="stat-item">攻击力: 42</div>
                        <div class="stat-item">类型: BOSS (第25关)</div>
                    </div>
                    <p>第25关的最终BOSS，远古时代的源初魔龙，拥有无与伦比的力量和多阶段的战斗形态。作为游戏的最终挑战，它融合了所有元素的力量，并且具有复活的能力。</p>
                    
                    <h4><span class="phase-indicator">远古苏醒</span></h4>
                    <p>源初魔龙从远古沉睡中苏醒，展现其古老的力量。这是战斗的开始阶段，BOSS会使用基础的龙息和防御技能。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🔥</div>
                            <div class="ability-info">
                                <div class="ability-name">原始火焰吐息</div>
                                <div class="ability-description">喷射原始火焰，对玩家造成高额伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🗣️</div>
                            <div class="ability-info">
                                <div class="ability-name">震天龙吟</div>
                                <div class="ability-description">发出震天龙吟，使玩家沉默2回合并失去2点能量。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🛡️</div>
                            <div class="ability-info">
                                <div class="ability-name">鳞片护甲</div>
                                <div class="ability-description">激活鳞片护甲，获得2层护甲，每层减少3点受到的伤害。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">元素融合</span></h4>
                    <p>当源初魔龙生命值降至70%以下时，它会融合四大元素之力，开始扭曲现实法则。在这个阶段，BOSS的攻击会变得更加多样化，并附带元素效果。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🌪️</div>
                            <div class="ability-info">
                                <div class="ability-name">元素混乱</div>
                                <div class="ability-description">引发元素混乱，造成伤害并随机施加燃烧、冰冻或中毒效果。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🌀</div>
                            <div class="ability-info">
                                <div class="ability-name">现实断裂</div>
                                <div class="ability-description">断裂现实，造成伤害并摧毁一张随机手牌。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🌑</div>
                            <div class="ability-info">
                                <div class="ability-name">时间日食</div>
                                <div class="ability-description">引发时间日食，接下来2回合玩家每回合少抽1张牌。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">世界末日</span></h4>
                    <p>当源初魔龙生命值降至40%以下时，它会陷入疯狂，释放足以毁灭世界的力量。在这个阶段，BOSS的攻击会变得更加致命，并且会开始降低玩家的最大生命值。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🌍</div>
                            <div class="ability-info">
                                <div class="ability-name">大灾变</div>
                                <div class="ability-description">释放大灾变，造成巨额伤害并永久降低玩家的最大生命值。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🩸</div>
                            <div class="ability-info">
                                <div class="ability-name">虚空吸收</div>
                                <div class="ability-description">攻击并吸收造成伤害的30%作为生命值。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">😈</div>
                            <div class="ability-info">
                                <div class="ability-name">龙疯狂</div>
                                <div class="ability-description">进入疯狂状态，攻击力和攻击速度大幅提升。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">死亡轮回</span></h4>
                    <p>当源初魔龙生命值降至0时，它会进入死亡轮回状态，复活并获得不死特性。在这个阶段，BOSS会汲取生命能量，玩家必须在5回合内打破这个状态，否则战斗将变得更加困难。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">🔥</div>
                            <div class="ability-info">
                                <div class="ability-name">复活火焰</div>
                                <div class="ability-description">在死亡时触发，恢复一定生命值并获得不死特性。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">💀</div>
                            <div class="ability-info">
                                <div class="ability-name">永恒痛苦</div>
                                <div class="ability-description">使玩家每回合受到5点伤害，效果会递减。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🩸</div>
                            <div class="ability-info">
                                <div class="ability-name">生命汲取</div>
                                <div class="ability-description">汲取玩家的生命能量，恢复自己的生命值。</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="phase-divider">
                    
                    <h4><span class="phase-indicator">终焉时刻</span></h4>
                    <p>当死亡轮回阶段持续5回合后，源初魔龙会进入终焉时刻阶段，完全觉醒为龙神形态，带来终焉审判。在这个最终阶段，BOSS会获得无敌护盾，护盾会持续一段时间后消失，玩家必须抓住机会进行攻击。</p>
                    <div class="ability-list">
                        <div class="ability-item">
                            <div class="ability-icon">💥</div>
                            <div class="ability-info">
                                <div class="ability-name">天启光束</div>
                                <div class="ability-description">释放天启光束，对玩家造成毁灭性伤害。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">⚡</div>
                            <div class="ability-info">
                                <div class="ability-name">源初湮灭</div>
                                <div class="ability-description">使用源初之力，试图彻底湮灭玩家。</div>
                            </div>
                        </div>
                        <div class="ability-item">
                            <div class="ability-icon">🐉</div>
                            <div class="ability-info">
                                <div class="ability-name">龙神形态</div>
                                <div class="ability-description">完全觉醒为龙神形态，获得无敌护盾和所有元素的力量。</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="monster-pedia-footer">
                <button class="btn" id="closeMonsterPedia">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 教程弹窗 -->
    <div id="tutorialModal" class="tutorial-modal">
        <div class="tutorial-content">
            <span class="tutorial-close">&times;</span>
            <h2>卡牌肉鸽冒险 游戏教程</h2>
            
            <div class="tutorial-tabs">
                <button class="tutorial-tab active" data-tab="basicInfo">基本介绍</button>
                <button class="tutorial-tab" data-tab="cardSystem">卡牌系统</button>
                <button class="tutorial-tab" data-tab="battleSystem">战斗系统</button>
                <button class="tutorial-tab" data-tab="buffEffects">BUFF与状态</button>
                <button class="tutorial-tab" data-tab="enemies">敌人与BOSS</button>
            </div>
            
            <div id="basicInfo" class="tutorial-tab-content active">
                <h3>游戏简介</h3>
                <p>《卡牌肉鸽冒险》是一款结合了卡牌战斗和肉鸽元素的冒险游戏。玩家将选择一个角色，通过收集卡牌、升级能力来挑战各种敌人，最终击败强大的BOSS。</p>
                
                <h3>游戏目标</h3>
                <p>游戏共有25个关卡，每5关会遇到一个强大的BOSS，最终挑战第25关的源初魔龙尼伯罗根。通过收集卡牌、升级能力来击败所有敌人，获得胜利！每一场战斗都是一次全新的冒险体验！</p>
                
                <h3>角色选择</h3>
                <p>游戏开始时，您可以选择七种不同的角色：</p>
                <ul>
                    <li><strong>战士</strong>：高生命值和物理伤害，擅长近距离战斗</li>
                    <li><strong>法师</strong>：强大的魔法伤害和效果，但生命值较低</li>
                    <li><strong>盗贼</strong>：高暴击几率和敏捷，擅长连击和闪避</li>
                    <li><strong>猎人</strong>：精准的远程攻击和战术布局，擅长控制战场</li>
                    <li><strong>骑士</strong>：极高生命值和防御能力，擅长神圣魔法和能量管理</li>
                    <li><strong>牧师</strong>：强大的治疗和增益能力，擅长维持自身和队友生命</li>
                    <li><strong>术士</strong>：牺牲生命值换取强大魔法伤害，擅长暗影和恶魔魔法</li>
                </ul>
            </div>
            
            <div id="cardSystem" class="tutorial-tab-content">
                <h3>卡牌类型</h3>
                <p>游戏中有多种类型的卡牌：</p>
                <ul>
                    <li><strong>攻击卡</strong>：对敌人造成伤害</li>
                    <li><strong>防御卡</strong>：获得护盾，减少受到的伤害</li>
                    <li><strong>魔法卡</strong>：造成魔法伤害或附加特殊效果</li>
                    <li><strong>特殊卡</strong>：具有独特效果的卡牌</li>
                    <li><strong>诅咒卡</strong>：负面效果的卡牌，通常会在特殊事件中获得</li>
                </ul>
                
                <h3>卡牌稀有度</h3>
                <p>卡牌有不同的稀有度，从普通到传奇：</p>
                <ul>
                    <li><strong>普通</strong>：基础卡牌，容易获得</li>
                    <li><strong>稀有</strong>：更强的卡牌，效果更独特</li>
                    <li><strong>传奇</strong>：非常强大的卡牌，拥有独特的特殊效果</li>
                </ul>
                
                <h3>卡牌强化</h3>
                <p>在游戏中，您可以使用金币强化卡牌，提升其效果。强化后的卡牌会有"+"标记。</p>
            </div>
            
            <div id="battleSystem" class="tutorial-tab-content">
                <h3>战斗流程</h3>
                <p>战斗遵循以下流程：</p>
                <ol>
                    <li>玩家回合：使用卡牌攻击、防御或施加效果</li>
                    <li>敌人回合：敌人执行其行动，可能是攻击、防御或使用特殊能力</li>
                    <li>回合结束：弃牌堆洗牌成为新的牌库，进入下一回合</li>
                </ol>
                
                <h3>能量系统</h3>
                <p>每张卡牌都需要消耗一定的能量才能使用。每回合开始时，您的能量会重置。合理管理能量是取得胜利的关键！</p>
                
                <h3>结束回合</h3>
                <p>当您无法或不想继续使用卡牌时，可以点击"结束回合"按钮进入敌人回合。</p>
                
                <h3>撤退</h3>
                <p>在战斗中，您可以选择撤退，但会损失10点生命值。这是在危险情况下保存性命的方式。</p>
            </div>
            
            <div id="buffEffects" class="tutorial-tab-content">
                <h3>正面效果（BUFF）</h3>
                <ul>
                    <li><strong>力量</strong>：提升攻击力</li>
                    <li><strong>护甲</strong>：减少受到的物理伤害</li>
                    <li><strong>护盾</strong>：临时的防御值，优先承受伤害</li>
                    <li><strong>潜行</strong>：避免敌人的攻击</li>
                    <li><strong>荆棘</strong>：受到攻击时反弹伤害</li>
                    <li><strong>反击</strong>：敌人攻击后反击造成伤害</li>
                </ul>
                
                <h3>负面效果（DEBUFF）</h3>
                <ul>
                    <li><strong>虚弱</strong>：降低攻击力</li>
                    <li><strong>毒素</strong>：每回合受到伤害</li>
                    <li><strong>燃烧</strong>：每回合受到双倍伤害</li>
                    <li><strong>恐惧</strong>：无法使用攻击卡</li>
                    <li><strong>诅咒</strong>：多种负面效果</li>
                </ul>
                
                <h3>特殊效果</h3>
                <ul>
                    <li><strong>暴击</strong>：造成双倍伤害</li>
                    <li><strong>连击</strong>：连续使用卡牌时增强效果</li>
                    <li><strong>穿刺</strong>：无视敌人的护盾</li>
                    <li><strong>吸血</strong>：将伤害转化为生命值</li>
                    <li><strong>潜行攻击</strong>：在潜行状态下伤害翻倍</li>
                </ul>
            </div>
            
            <div id="enemies" class="tutorial-tab-content">
                <h3>普通敌人</h3>
                <p>游戏中有多种普通敌人，每种都有独特的能力和策略：</p>
                <ul>
                    <li><strong>哥布林</strong>：基础敌人，简单直接</li>
                    <li><strong>哥布林弓手</strong>：远程攻击，有几率造成额外伤害</li>
                    <li><strong>兽人战士</strong>：血量低时进入狂怒状态</li>
                    <li><strong>暗影刺客</strong>：擅长潜行和毒素攻击</li>
                    <li><strong>石头巨人</strong>：高血量高防御，攻击者会受到反伤</li>
                    <li>还有更多敌人等待您的发现！</li>
                </ul>
                
                <h3>守关BOSS</h3>
                <p>每5个关卡会出现一个强大的BOSS：</p>
                <ul>
                    <li><strong>暗影龙王</strong>（第5关）：拥有暗影魔法和召唤能力</li>
                    <li><strong>元素领主</strong>（第10关）：掌控火焰、冰霜和雷电元素</li>
                    <li><strong>虚空君主</strong>（第15关）：操控虚空能量，扭曲现实</li>
                    <li><strong>创世神</strong>（第20关）：创造与毁灭的化身</li>
                    <li><strong>源初魔龙尼伯罗根</strong>（第25关）：游戏的最终挑战，远古时代的源初魔龙，拥有无与伦比的力量和多阶段战斗形态</li>
                </ul>
                
                <h3>BOSS阶段</h3>
                <p>BOSS会随着血量降低进入不同阶段，获得新的能力和更强大的攻击。</p>
                
                <h4>源初魔龙特殊阶段</h4>
                <p>作为最终BOSS，源初魔龙尼伯罗根拥有独特的5阶段战斗模式：</p>
                <ul>
                    <li><strong>远古苏醒</strong>：初始阶段，使用基础的龙息和防御技能</li>
                    <li><strong>元素融合</strong>：生命值降至70%以下时，融合四大元素之力，攻击变得更加多样化</li>
                    <li><strong>世界末日</strong>：生命值降至40%以下时，陷入疯狂，释放足以毁灭世界的力量</li>
                    <li><strong>死亡轮回</strong>：生命值降至0时，进入死亡轮回状态，复活并获得不死特性</li>
                    <li><strong>终焉时刻</strong>：死亡轮回持续5回合后，完全觉醒为龙神形态，带来终焉审判</li>
                </ul>
                <p>击败源初魔龙需要充分利用之前关卡中收集的卡牌和能力，制定合理的战斗策略！</p>
            </div>
            
            <div class="tutorial-footer">
                <button class="btn" id="closeTutorial">关闭</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="game-header">
            <h1 class="game-title">🃏 卡牌肉鸽冒险</h1>
            <div class="game-stats">
                <div class="stat">
                    <div>关卡: <span id="level">1</span></div>
                </div>
                <div class="stat">
                    <div>金币: <span id="gold">50</span></div>
                </div>
                <div class="stat">
                    <div>牌组: <span id="deckCount">0</span>张</div>
                </div>
            </div>
            <div id="buffs"></div>
        </div>

        <!-- 首页菜单界面 -->
        <div id="homeScreen" class="screen active">
            <div class="home-menu">
                <h1>卡牌肉鸽冒险</h1>
                <div class="home-buttons">
                    <button id="startButton" class="home-btn">开始游戏</button>
                    <button id="exitButton" class="home-btn">退出游戏</button>
                </div>
                
                <div class="game-intro">
                    <h3>🎮 游戏简介</h3>
                    <p>《卡牌肉鸽冒险》是一款结合卡牌战斗与肉鸽元素的冒险游戏。玩家需选择战士、法师、盗贼等7种角色之一，通过收集卡牌、升级能力挑战25个关卡，每5关将遭遇强力BOSS，最终击败第25关的源初魔龙尼伯罗根。</p>
                    <p>游戏核心玩法为回合制卡牌战斗：玩家回合消耗能量使用攻击、防御、魔法等不同类型卡牌；敌人回合由敌方行动；回合结束后弃牌堆洗牌成为新牌库。卡牌分为普通、稀有、传奇三个稀有度，可通过金币强化提升效果。每场战斗都是独特体验，合理搭配卡牌与策略是取胜关键。</p>
                </div>
            </div>
        </div>
        
        <!-- 角色选择界面 -->
        <div id="characterScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px;">选择你的角色</h2>
            <div class="character-select">
                <div class="character-card" data-character="warrior">
                    <div class="character-icon">⚔️</div>
                    <h3>战士</h3>
                    <p>生命值: 100 | 能量: 3</p>
                    <p>护甲精通: 每回合开始获得2点护盾</p>
                    <p>防御加成: +2护盾效果</p>
                </div>
                <div class="character-card" data-character="mage">
                    <div class="character-icon">🔮</div>
                    <h3>法师</h3>
                    <p>生命值: 70 | 能量: 4</p>
                    <p>奥术智慧: 每打出2张法术牌抽1张牌</p>
                    <p>法术强度: +2法术伤害</p>
                </div>
                <div class="character-card" data-character="rogue">
                    <div class="character-icon">🗡️</div>
                    <h3>盗贼</h3>
                    <p>生命值: 85 | 能量: 3</p>
                    <p>连击精通: 每回合第一张牌消耗-1</p>
                    <p>暴击几率: 15%造成1.5倍伤害</p>
                </div>
                <div class="character-card" data-character="hunter">
                    <div class="character-icon">🏹</div>
                    <h3>猎人</h3>
                    <p>生命值: 90 | 能量: 3</p>
                    <p>精准射击: 每回合第一发远程攻击伤害+50%</p>
                    <p>射程优势: 远程攻击+2伤害</p>
                </div>
                <div class="character-card" data-character="knight">
                    <div class="character-icon">🛡️</div>
                    <h3>骑士</h3>
                    <p>生命值: 105 | 能量: 3</p>
                    <p>神圣守护: 每回合开始有50%几率获得1点能量和2点护盾</p>
                    <p>圣能亲和: 神圣技能效果增强</p>
                </div>
                <div class="character-card" data-character="priest">
                    <div class="character-icon">🙏</div>
                    <h3>牧师</h3>
                    <p>生命值: 80 | 能量: 3</p>
                    <p>神圣治疗: 每回合结束时，若生命值低于50%，恢复6点生命值</p>
                    <p>治疗增效: 治疗效果+2</p>
                </div>
                <div class="character-card" data-character="warlock">
                    <div class="character-icon">👹</div>
                    <h3>术士</h3>
                    <p>生命值: 65 | 能量: 4</p>
                    <p>邪能增幅: 每使用一张消耗生命的卡牌，获得1层邪能（每层+1魔法伤害）</p>
                    <p>恶魔之力: 初始魔法伤害+2</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" id="startGame" disabled>开始冒险</button>
            </div>
        </div>

        <!-- 牌组管理界面 -->
        <div id="deckScreen" class="screen">
            <div class="deck-area">
                <div class="deck-section">
                    <h3>可选卡牌</h3>
                    <div class="cards-scroll-area">
                        <div class="cards-grid" id="availableCards"></div>
                    </div>
                </div>
                <div class="deck-section">
                    <h3>我的牌组</h3>
                    <div class="cards-scroll-area">
                        <div class="cards-grid" id="playerDeck"></div>
                    </div>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-primary" id="enterBattle">进入战斗</button>
                <button class="btn" id="shopBtn">商店 (10金币抽卡)</button>
                <button class="btn" id="randomEventBtn">探索事件</button>
                <button class="btn" id="upgradeBtn">强化卡牌 (25金币)</button>
            </div>
        </div>

        <!-- 战斗界面 -->
        <div id="battleScreen" class="screen">
            <div class="battle-area">
                <div class="enemy">
                    <div class="enemy-display">
                        <div class="enemy-art" id="enemyArt"></div>
                        <h4 id="enemyName" style="margin: 2px 0; font-size: 0.9rem; line-height: 1.1;">哥布林</h4>
                        <div class="health-bar">
                            <div class="health-fill" id="enemyHealth" style="width: 100%"></div>
                        </div>
                        <div id="enemyStats" style="font-size: 0.75rem; margin: 2px 0; line-height: 1;">生命值: <span id="enemyHp">30</span> / <span id="enemyMaxHp">30</span></div>
                        <div id="enemyIntent" style="margin-top: 4px; padding: 3px 6px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.7rem; line-height: 1.1; flex-shrink: 0;">
                            <span id="intentIcon">⚔️</span> <span id="intentText">准备攻击 (6伤害)</span>
                        </div>
                    </div>
                </div>

                <div class="player-status">
                    <div class="energy-display">⚡ 能量: <span id="energy">3</span> / 3</div>
                    <div class="health-bar player-health">
                        <div class="health-fill" id="playerHealth" style="width: 100%"></div>
                    </div>
                    <div>❤️ 生命值: <span id="playerHp">100</span> / <span id="playerMaxHp">100</span></div>
                    <div id="playerStatusEffects" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.8rem;"></div>
                    <div id="enemyStatusEffects" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.8rem;"></div>
                </div>

                <div class="hand" id="hand"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" id="endTurn">🔄 结束回合</button>
                    <button class="btn btn-danger" id="retreatBtn">🏃 撤退</button>
                </div>

                <h3 style="text-align: center; margin-bottom: 10px; color: #ffd700;">📝 战斗日志</h3>
                <div class="log" id="battleLog"></div>
            </div>
        </div>

        <!-- 奖励界面 -->
        <div id="rewardScreen" class="screen">
            <h2 style="text-align: center;">胜利！选择你的奖励</h2>
            <div class="rewards" id="rewards"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" id="nextLevel">下一关</button>
            </div>
        </div>

        <!-- 通关界面 -->
        <div id="victoryScreen" class="screen">
            <div style="text-align: center;">
                <h2 style="color: #ffd700; font-size: 3rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">🏆 恭喜通关！</h2>
                <p style="font-size: 1.5rem; margin: 20px 0;">你击败了第 <span id="victoryLevel">5</span> 关的守关BOSS！</p>
                <p style="font-size: 1.2rem; color: #ffd700;">获得了传奇卡牌奖励！</p>
                <div id="victoryRewards" style="margin: 30px 0;"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" id="continueAdventure">继续冒险 (难度提升)</button>
                    <button class="btn" id="backToMenu">返回主页</button>
                </div>
            </div>
        </div>

        <!-- 随机事件界面 -->
        <div id="eventScreen" class="screen">
            <div style="text-align: center;">
                <h2 id="eventTitle">随机事件</h2>
                <p id="eventDescription" style="font-size: 1.2rem; margin: 20px 0; line-height: 1.5;"></p>
                <div id="eventChoices" style="margin: 30px 0;"></div>
            </div>
        </div>

        <!-- 成就界面 -->
        <div id="achievementScreen" class="screen">
            <div style="text-align: center;">
                <h2>🏆 成就系统</h2>
                <div id="achievementsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;"></div>
                <button class="btn" id="closeAchievements">返回</button>
            </div>
        </div>

        <!-- 卡牌强化界面 -->
        <div id="upgradeScreen" class="screen">
            <div style="text-align: center;">
                <h2>⚡ 卡牌强化</h2>
                <p>选择一张卡牌进行强化</p>
                <div id="upgradeCards" class="cards-grid" style="margin: 30px 0;"></div>
                <button class="btn" id="skipUpgrade">跳过强化</button>
            </div>
        </div>

        <!-- 游戏结束界面 -->
        <div id="gameOverScreen" class="screen">
            <div style="text-align: center;">
                <h2>游戏结束</h2>
                <p>你到达了第 <span id="finalLevel">1</span> 关</p>
                <div id="gameOverAchievements" style="margin: 20px 0;"></div>
                <button class="btn btn-primary" id="restartGame">重新开始</button>
                <button class="btn" id="viewAchievements">查看成就</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        let gameState = {
            level: 1,
            gold: 50,
            selectedCharacter: null,
            playerDeck: [],
            playerHp: 100,
            playerMaxHp: 100,
            energy: 3,
            maxEnergy: 3,
            hand: [],
            buffs: [],
            legendaryBuffCount: 0,
            currentEnemy: null,
            battleLog: [],
            // 新卡牌效果相关状态
            enemyBleed: 0,
            enemyStunned: 0,
            enemyFear: 0,
            tauntActive: false,
            soulLinkActive: false,
            soulLinkTurns: 0,
            firstRangedAttackThisTurn: true,
            badLuckThisTurn: false,
            badLuckActive: 0,
            // 控制效果疲劳计数器
            stunCount: 0,
            freezeCount: 0,
            fearCount: 0,
            // 潜行效果疲劳计数器
            stealthCount: 0,
            // 源初魔龙特殊状态
            scaleArmor: 0,
            eternalPain: 0,
            deathReincarnationCount: 0,
            // 新角色相关属性
            passiveAbility: '',
            spellsPlayedThisTurn: 0,
            firstCardThisTurn: true,
            demonicEnergy: 0,
            // 陷阱相关状态
            trapActive: false,
            trapType: null
        };

        // 角色数据
        const characters = {
            warrior: {
                name: '战士',
                icon: '⚔️',
                maxHp: 100,
                maxEnergy: 3,
                attackBonus: 0,
                defenseBonus: 2,
                passive: 'armor_mastery', // 护甲精通：每回合开始获得2点护盾
                startingCards: ['重击', '铁壁防御', '战吼', '重击', '铁壁防御', '愤怒', '坚韧', '战术撤退']
            },
            mage: {
                name: '法师',
                icon: '🔮',
                maxHp: 70,
                maxEnergy: 4,
                magicBonus: 1,
                spellPower: 2,
                passive: 'arcane_intellect', // 奥术智慧：每打出2张法术牌抽1张牌
                startingCards: ['魔法飞弹', '法师护甲', '奥术洞察', '魔法飞弹', '法师护甲', '冰霜新星', '魔力涌流', '传送']
            },
            rogue: {
                name: '盗贼',
                icon: '🗡️',
                maxHp: 85,
                maxEnergy: 3,
                comboBonus: 1,
                critChance: 0.15,
                passive: 'combo_mastery', // 连击精通：每回合第一张牌消耗-1
                startingCards: ['快刀', '闪避', '毒刃', '快刀', '闪避', '影袭', '潜行', '致命毒药']
            },
            hunter: {
                name: '猎人',
                icon: '🏹',
                maxHp: 90,
                maxEnergy: 3,
                markBonus: 1,
                rangeBonus: 2,
                passive: 'precision_shot', // 精准射击：每回合第一发远程攻击造成1.5倍伤害
                startingCards: ['精准射击', '鹰眼', '陷阱', '精准射击', '鹰眼', '猎人标记', '追踪', '箭雨']
            },
            knight: {
                name: '骑士',
                icon: '🛡️',
                maxHp: 105,
                maxEnergy: 3,
                holyBonus: 1,
                energyEfficiency: 1,
                passive: 'holy_guardian', // 神圣守护：每回合开始有50%几率获得1点能量和2点护盾
                startingCards: ['圣盾术', '正义打击', '虔诚', '十字军打击', '圣盾术', '神圣愤怒', '光明祝福', '保护祝福']
            },
            priest: {
                name: '牧师',
                icon: '🙏',
                maxHp: 80,
                maxEnergy: 3,
                healingPower: 2,
                holyBonus: 2,
                passive: 'holy_healing', // 神圣治疗：每回合结束时，若生命值低于50%，恢复6点生命值
                startingCards: ['治疗术', '心灵之火', '神圣之光', '治疗术', '心灵之火', '净化', '精神专注', '神圣干涉']
            },
            warlock: {
                name: '术士',
                icon: '👹',
                maxHp: 65,
                maxEnergy: 4,
                magicBonus: 2,
                demonicPower: 1,
                passive: 'demonic_amplification', // 邪能增幅：每使用一张消耗生命的卡牌，获得1层邪能（每层邪能提供+1魔法伤害）
                startingCards: ['腐蚀术', '生命分流', '暗影箭', '腐蚀术', '生命分流', '吸取灵魂', '献祭', '恐吓']
            }
        };

        // 卡牌数据
        const cardDatabase = {
            // 骑士神圣卡牌
            '正义打击': { type: 'attack', cost: 1, damage: 7, holy: true, description: '造成7点神圣伤害', art: 'holy-strike', rarity: 'common', character: 'knight' },
            '十字军打击': { type: 'attack', cost: 2, damage: 9, holy: true, description: '造成9点神圣伤害', art: 'crusader-strike', rarity: 'common', character: 'knight' },
            '神圣愤怒': { type: 'attack', cost: 2, damage: 8, holy: true, splash: 4, description: '造成8点神圣伤害，对其他敌人造成4点溅射伤害', art: 'holy-wrath', rarity: 'uncommon', character: 'knight' },
            '光明审判': { type: 'attack', cost: 2, damage: 10, holy: true, heal: 3, description: '造成10点神圣伤害并恢复3点生命值', art: 'holy-judgment', rarity: 'uncommon', character: 'knight' },
            '复仇打击': { type: 'attack', cost: 3, damage: 12, holy: true, maxHealthBonus: 0.05, description: '造成12点神圣伤害，并附加目标最大生命值5%的额外伤害', art: 'vengeance', rarity: 'rare', character: 'knight' },
            '圣盾术': { type: 'defense', cost: 1, block: 8, holy: true, description: '获得8点护盾', art: 'holy-shield', rarity: 'common', character: 'knight' },
            '虔诚': { type: 'ability', cost: 0, buff: 'holy_strength', stacks: 1, description: '获得1层神圣之力（下次神圣攻击+4伤害）', art: 'devotion', rarity: 'common', character: 'knight' },
            '光明祝福': { type: 'ability', cost: 2, buff: 'holy_armor', stacks: 2, description: '获得2层神圣护甲（每层+2护盾效果）', art: 'holy-blessing', rarity: 'uncommon', character: 'knight' },
            '保护祝福': { type: 'ability', cost: 2, invulnerable: 1, exhaust: true, description: '获得1回合无敌效果，使用后消耗', art: 'protection', rarity: 'rare', character: 'knight' },
            '神圣奉献': { type: 'ability', cost: 3, aoe: true, damage: 6, holy: true, description: '对所有敌人造成6点神圣伤害', art: 'consecration', rarity: 'rare', character: 'knight' },
            
            // 牧师神圣卡牌
            '心灵之火': { type: 'attack', cost: 1, damage: 6, holy: true, description: '造成6点神圣伤害，根据已恢复的生命值额外+1伤害/每8点生命恢复', art: 'holy-fire', rarity: 'common', character: 'priest' },
            '神圣之光': { type: 'ability', cost: 1, heal: 5, damage: 2, holy: true, description: '恢复5点生命值并造成2点神圣伤害', art: 'holy-light', rarity: 'common', character: 'priest' },
            '治疗术': { type: 'ability', cost: 2, heal: 8, damage: 3, holy: true, description: '恢复8点生命值并造成3点神圣伤害', art: 'heal', rarity: 'common', character: 'priest' },
            '净化': { type: 'ability', cost: 1, cleanse: true, damage: 2, holy: true, description: '移除自身所有负面效果并造成2点神圣伤害', art: 'cleanse', rarity: 'common', character: 'priest' },
            '精神专注': { type: 'ability', cost: 1, draw: 1, damage: 1, holy: true, description: '抽1张牌并造成1点神圣伤害', art: 'focus', rarity: 'common', character: 'priest' },
            '神圣干涉': { type: 'ability', cost: 3, heal: 12, draw: 1, damage: 5, holy: true, description: '恢复12点生命值，抽1张牌并造成5点神圣伤害', art: 'divine-intervention', rarity: 'rare', character: 'priest' },
            '信仰之力': { type: 'ability', cost: 2, buff: 'faith', stacks: 2, damage: 3, holy: true, description: '获得2层信仰（每层+1治疗效果）并造成3点神圣伤害', art: 'faith', rarity: 'uncommon', character: 'priest' },
            '神圣新星': { type: 'ability', cost: 3, aoe: true, damage: 7, holy: true, heal: 5, description: '对所有敌人造成7点神圣伤害并恢复5点生命值', art: 'holy-nova', rarity: 'rare', character: 'priest' },
            '虔诚祈祷': { type: 'ability', cost: 3, heal: 15, exhaust: true, damage: 6, holy: true, description: '恢复15点生命值，使用后移除，并造成6点神圣伤害', art: 'prayer', rarity: 'rare', character: 'priest' },
            '心灵控制': { type: 'ability', cost: 4, control: true, damage: 4, holy: true, description: '控制一个敌人1回合，使其攻击自身，并造成4点神圣伤害', art: 'mind-control', rarity: 'rare', character: 'priest' },
            
            // 术士暗影卡牌
            '暗影箭': { type: 'magic', cost: 1, damage: 7, shadow: true, description: '造成7点暗影伤害', art: 'shadow-bolt', rarity: 'common', character: 'warlock' },
            '腐蚀术': { type: 'magic', cost: 1, damage: 4, dot: 3, shadow: true, description: '造成4点暗影伤害并每回合造成3点伤害，持续3回合', art: 'corruption', rarity: 'common', character: 'warlock' },
            '生命分流': { type: 'ability', cost: 1, energy_gain: 2, self_damage: 5, description: '获得2点能量，对自己造成5点伤害', art: 'life-tap', rarity: 'common', character: 'warlock' },
            '吸取灵魂': { type: 'magic', cost: 2, damage: 8, lifesteal: true, shadow: true, description: '造成8点暗影伤害并恢复6点生命值', art: 'siphon-soul', rarity: 'uncommon', character: 'warlock' },
            '献祭': { type: 'magic', cost: 2, damage: 10, fire: true, description: '造成10点火焰伤害', art: 'immolate', rarity: 'uncommon', character: 'warlock' },
            '恐吓': { type: 'ability', cost: 2, fear: true, description: '使敌人恐惧1回合，无法行动', art: 'fear', rarity: 'uncommon', character: 'warlock' },
            '恶魔印记': { type: 'ability', cost: 1, buff: 'demonic_power', stacks: 1, description: '获得1层恶魔之力（每层+1魔法伤害）', art: 'demon-mark', rarity: 'common', character: 'warlock' },
            '暗影形态': { type: 'ability', cost: 3, buff: 'shadow_form', stacks: 1, description: '进入暗影形态，所有暗影伤害+5，持续2回合', art: 'shadow-form', rarity: 'rare', character: 'warlock' },
            '地狱火': { type: 'magic', cost: 4, damage: 15, fire: true, aoe: true, self_damage: 8, description: '对所有敌人造成15点火焰伤害，对自己造成8点伤害', art: 'hellfire', rarity: 'rare', character: 'warlock' },
            '灵魂收割': { type: 'magic', cost: 3, damage: 12, execute: 0.25, shadow: true, description: '造成12点暗影伤害，敌人血量低于25%时伤害翻倍', art: 'soul-reaper', rarity: 'rare', character: 'warlock' },
            
            // 猎人射击卡牌
            '精准射击': { type: 'attack', cost: 1, damage: 6, range: true, description: '造成6点远程伤害', art: 'bow-shot', rarity: 'common', character: 'hunter' },
            '箭雨': { type: 'attack', cost: 2, damage: 5, hits: 2, range: true, description: '发射2支箭，每支造成5点远程伤害', art: 'arrow-rain', rarity: 'common', character: 'hunter' },
            '猎人标记': { type: 'ability', cost: 1, mark: true, description: '标记敌人，所有对其的攻击+3伤害', art: 'target', rarity: 'common', character: 'hunter' },
            '穿透射击': { type: 'attack', cost: 2, damage: 10, pierce: true, range: true, description: '造成10点远程伤害，无视护盾', art: 'pierce', rarity: 'uncommon', character: 'hunter' },
            '多重射击': { type: 'attack', cost: 3, damage: 4, hits: 3, range: true, description: '发射3支箭，每支造成4点远程伤害', art: 'multishot', rarity: 'uncommon', character: 'hunter' },
            '瞄准射击': { type: 'attack', cost: 2, damage: 12, precision: true, range: true, description: '造成12点远程伤害，对标记的敌人伤害翻倍', art: 'snipe', rarity: 'rare', character: 'hunter' },
            '陷阱': { type: 'ability', cost: 1, trap: true, stun: 1, description: '设置陷阱，敌人行动时受到8点伤害并眩晕1回合', art: 'trap', rarity: 'uncommon', character: 'hunter' },
            '爆炸陷阱': { type: 'ability', cost: 2, trap: true, explosion: true, description: '设置爆炸陷阱，敌人行动时受到12点伤害并对其他敌人造成4点溅射伤害', art: 'explosive-trap', rarity: 'rare', character: 'hunter' },
            '毒蛇陷阱': { type: 'ability', cost: 2, trap: true, poison: 3, description: '设置毒蛇陷阱，敌人行动时受到6点伤害并施加3层毒素', art: 'snake-trap', rarity: 'rare', character: 'hunter' },
            '追踪': { type: 'ability', cost: 1, draw: 1, description: '抽1张牌', art: 'track', rarity: 'common', character: 'hunter' },
            '鹰眼': { type: 'ability', cost: 0, buff: 'precision', stacks: 1, description: '获得1层精准（下次远程攻击伤害+4）', art: 'eagle-eye', rarity: 'common', character: 'hunter' },
            '急速射击': { type: 'attack', cost: 2, damage: 7, range: true, draw: 1, description: '造成7点远程伤害并抽1张牌', art: 'rapid-shot', rarity: 'uncommon', character: 'hunter' },
            '稳固射击': { type: 'attack', cost: 3, damage: 15, range: true, exhaust: true, description: '造成15点远程伤害，使用后移除', art: 'steady-shot', rarity: 'rare', character: 'hunter' },
            
            // 战士攻击卡牌
            '重击': { type: 'attack', cost: 2, damage: 10, description: '造成10点伤害', art: 'sword-strike', rarity: 'common', character: 'warrior' },
            '战吼': { type: 'attack', cost: 1, damage: 6, buff: 'strength', stacks: 1, description: '造成6点伤害，获得1层力量', art: 'charge', rarity: 'common', character: 'warrior' },
            '愤怒': { type: 'attack', cost: 1, damage: 8, self_damage: 2, description: '造成8点伤害，对自己造成2点伤害', art: 'berserker', rarity: 'common', character: 'warrior' },
            '嗜血': { type: 'attack', cost: 2, damage: 8, lifesteal: true, description: '造成8点伤害并恢复等量生命值', art: 'vampiric', rarity: 'common', character: 'warrior' },
            '狂暴攻击': { type: 'attack', cost: 3, damage: 16, exhaust: true, description: '造成16点伤害，使用后移除', art: 'berserker', rarity: 'uncommon', character: 'warrior' },
            '双刃斩': { type: 'attack', cost: 2, damage: 6, hits: 2, description: '攻击2次，每次6点伤害', art: 'dual-slash', rarity: 'uncommon', character: 'warrior' },
            '横扫千军': { type: 'attack', cost: 3, damage: 8, splash: 6, description: '造成8点伤害，对其他敌人造成6点溅射伤害', art: 'cleave', rarity: 'uncommon', character: 'warrior' },
            '斩首': { type: 'attack', cost: 3, damage: 12, execute: 0.3, description: '造成12点伤害，敌人血量低于30%时秒杀', art: 'execute', rarity: 'rare', character: 'warrior' },
            '战争践踏': { type: 'attack', cost: 3, damage: 12, stun: 1, description: '造成12点伤害并眩晕敌人1回合', art: 'stomp', rarity: 'rare', character: 'warrior' },
            
            // 盗贼攻击卡牌
            '快刀': { type: 'attack', cost: 1, damage: 5, description: '造成5点伤害', art: 'dagger', rarity: 'common', character: 'rogue' },
            '影袭': { type: 'attack', cost: 2, damage: 8, combo: true, description: '造成8点伤害，连击：+3伤害', art: 'combo', rarity: 'common', character: 'rogue' },
            '毒刃': { type: 'attack', cost: 2, damage: 6, poison: 2, description: '造成6点伤害并施加2层毒素', art: 'poison-blade', rarity: 'common', character: 'rogue' },
            '割裂': { type: 'attack', cost: 2, damage: 6, bleed: 4, description: '造成6点伤害并施加4层流血', art: 'bleed', rarity: 'common', character: 'rogue', dot_multiplier: 0.75 },
            '致命一击': { type: 'attack', cost: 2, damage: 12, crit_bonus: 0.3, description: '造成12点伤害，30%几率造成双倍伤害', art: 'critical', rarity: 'uncommon', character: 'rogue' },
            '穿刺': { type: 'attack', cost: 2, damage: 10, pierce: true, description: '造成10点伤害，无视护盾', art: 'pierce', rarity: 'uncommon', character: 'rogue' },
            '连击风暴': { type: 'attack', cost: 2, damage: 4, combo: true, hits: 3, description: '连击：造成3次4点伤害', art: 'combo-storm', rarity: 'uncommon', character: 'rogue' },
            '暗杀': { type: 'attack', cost: 3, damage: 20, stealth_bonus: true, description: '造成20点伤害，潜行时伤害翻倍', art: 'execute', rarity: 'rare', character: 'rogue' },
            
            // 战士防御卡牌
            '铁壁防御': { type: 'defense', cost: 1, block: 6, description: '获得6点护盾', art: 'shield', rarity: 'common', character: 'warrior' },
            '坚韧': { type: 'defense', cost: 1, buff: 'armor', stacks: 1, description: '获得1层护甲（永久减伤1点）', art: 'toughness', rarity: 'common', character: 'warrior' },
            '战术撤退': { type: 'defense', cost: 1, block: 4, draw: 1, description: '获得4护盾并抽1张牌', art: 'parry', rarity: 'common', character: 'warrior' },
            '嘲讽': { type: 'defense', cost: 1, block: 3, taunt: true, description: '获得3护盾，吸引敌人攻击', art: 'taunt', rarity: 'common', character: 'warrior' },
            '反击': { type: 'defense', cost: 2, block: 5, counter: 6, description: '获得5护盾，受到攻击时反击6点伤害', art: 'counter', rarity: 'uncommon', character: 'warrior' },
            '钢铁意志': { type: 'defense', cost: 2, block: 10, buff: 'strength', stacks: 1, description: '获得10护盾和1层力量', art: 'iron-will', rarity: 'uncommon', character: 'warrior' },
            '盾牌猛击': { type: 'defense', cost: 2, block: 8, damage: 6, description: '获得8护盾并造成6点伤害', art: 'shield-bash', rarity: 'uncommon', character: 'warrior' },
            '完美防御': { type: 'defense', cost: 3, block: 18, exhaust: true, description: '获得18护盾，使用后移除', art: 'perfect-defense', rarity: 'rare', character: 'warrior' },
            
            // 盗贼防御卡牌
            '闪避': { type: 'defense', cost: 1, block: 5, description: '获得5点护盾', art: 'dodge', rarity: 'common', character: 'rogue' },
            '潜行': { type: 'defense', cost: 2, stealth: 1, draw: 1, description: '获得1回合潜行并抽1张牌（一场战斗中使用超过2次后，每多使用一次增加20%失败概率）', art: 'stealth', rarity: 'common', character: 'rogue' },
            '烟雾弹': { type: 'defense', cost: 1, dodge_next: true, description: '下次攻击必定闪避', art: 'dodge', rarity: 'uncommon', character: 'rogue' },
            '影分身': { type: 'defense', cost: 2, block: 8, combo: true, description: '获得8护盾，连击：再获得4护盾', art: 'clone', rarity: 'uncommon', character: 'rogue' },
            '消失': { type: 'defense', cost: 3, stealth: 2, draw: 2, description: '获得2回合潜行并抽2张牌（一场战斗中使用超过2次后，每多使用一次增加20%失败概率）', art: 'vanish', rarity: 'rare', character: 'rogue' },
            
            // 法师魔法卡牌
            '魔法飞弹': { type: 'magic', cost: 1, damage: 4, hits: 2, description: '发射2枚飞弹，每枚造成4点伤害', art: 'magic-missile', rarity: 'common', character: 'mage' },
            '法师护甲': { type: 'magic', cost: 1, block: 5, description: '获得5点护盾', art: 'magic-shield', rarity: 'common', character: 'mage' },
            '奥术洞察': { type: 'magic', cost: 1, draw: 2, energy_gain: 1, description: '抽2张牌并获得1点能量', art: 'focus', rarity: 'common', character: 'mage' },
            '冰霜新星': { type: 'magic', cost: 2, damage: 6, freeze: 1, description: '造成6点伤害并冰冻敌人1回合', art: 'freeze-ray', rarity: 'common', character: 'mage' },
            '魔力涌流': { type: 'magic', cost: 0, energy_gain: 2, exhaust: true, description: '获得2点能量，使用后移除', art: 'mana-drain', rarity: 'common', character: 'mage' },
            '传送': { type: 'magic', cost: 1, dodge_next: true, draw: 1, description: '下次攻击必定闪避，抽1张牌', art: 'teleport', rarity: 'common', character: 'mage' },
            '火球术': { type: 'magic', cost: 2, damage: 12, burn: 1, description: '造成12点伤害并施加1层燃烧', art: 'fireball', rarity: 'uncommon', character: 'mage' },
            '闪电链': { type: 'magic', cost: 2, damage: 8, chain: true, description: '造成8点伤害，每有1张法术牌在手中+2伤害', art: 'lightning', rarity: 'uncommon', character: 'mage' },
            '冰墙术': { type: 'magic', cost: 2, block: 12, freeze_attacker: true, description: '获得12护盾，攻击者被冰冻1回合', art: 'frost-shield', rarity: 'uncommon', character: 'mage' },
            '奥数强化': { type: 'magic', cost: 2, buff: 'spellpower', stacks: 2, description: '获得2层法术强度', art: 'spell-enhance', rarity: 'uncommon', character: 'mage' },
            '奥术爆发': { type: 'magic', cost: 3, damage: 18, discard_hand: true, description: '造成18点伤害，弃掉所有手牌', art: 'elemental-burst', rarity: 'rare', character: 'mage' },
            '时间扭曲': { type: 'magic', cost: 4, extra_turn: true, exhaust: true, description: '获得额外回合，使用后移除', art: 'time-warp', rarity: 'rare', character: 'mage' },
            '元素连击': { type: 'magic', cost: 3, damage: 15, combo: true, description: '连击：根据元素效果强化伤害', art: 'elemental-combo', rarity: 'rare', character: 'mage' },
            
            // 通用特殊卡牌
            '致命毒药': { type: 'special', cost: 1, poison: 3, description: '给敌人施加3层毒素', art: 'poison-blade', rarity: 'common', character: 'neutral' },
            '治疗药水': { type: 'special', cost: 1, heal: 8, description: '恢复8点生命值', art: 'heal', rarity: 'common', character: 'neutral' },
            '专注': { type: 'special', cost: 1, draw: 2, description: '抽2张牌', art: 'focus', rarity: 'common', character: 'neutral' },
            '能量水晶': { type: 'special', cost: 0, energy_gain: 1, description: '获得1点能量', art: 'energy-crystal', rarity: 'common', character: 'neutral' },
            '吸血': { type: 'special', cost: 2, damage: 8, lifesteal: true, description: '造成8伤害并恢复等量生命', art: 'vampiric', rarity: 'uncommon', character: 'neutral' },
            '狂怒药剂': { type: 'special', cost: 2, buff: 'strength', stacks: 2, self_damage: 3, description: '获得2层力量，受到3点伤害', art: 'rage', rarity: 'uncommon', character: 'neutral' },
            '净化': { type: 'special', cost: 1, cleanse: true, heal: 6, description: '移除所有负面效果并恢复6生命', art: 'purify', rarity: 'uncommon', character: 'neutral' },
            '灵魂链接': { type: 'special', cost: 2, link: true, link_duration: 2, description: '与敌人建立灵魂链接，2回合内双方伤害共享', art: 'soul-link', rarity: 'uncommon', character: 'neutral' },
            '元素融合': { type: 'special', cost: 3, combine_elements: true, base_damage: 6, effect_multiplier: 2.5, description: '结合所有负面效果造成基础伤害×(1+效果数量×倍率)的伤害', art: 'elemental-fusion', rarity: 'uncommon', character: 'neutral' },
            '幸运硬币': { type: 'special', cost: 0, lucky: true, description: '随机获得正面效果', art: 'lucky-coin', rarity: 'rare', character: 'neutral' },
            '重生护符': { type: 'special', cost: 3, revive: true, exhaust: true, description: '死亡时复活并恢复50%生命，使用后移除', art: 'rebirth', rarity: 'rare', character: 'neutral' },
            '无限循环': { type: 'special', cost: 3, loop: true, description: '将1张卡牌放回牌库顶部', art: 'infinite-loop', rarity: 'rare', character: 'neutral' },
            
            // 诅咒卡牌（负面效果）
            '虚弱诅咒': { type: 'curse', cost: 1, weakness: 2, description: '攻击力-2，无法移除', art: 'weakness-curse', unremovable: true, rarity: 'curse', character: 'curse' },
            '疲劳': { type: 'curse', cost: 2, description: '消耗2能量，什么都不做', art: 'fatigue', unremovable: true, rarity: 'curse', character: 'curse' },
            '痛苦': { type: 'curse', cost: 0, self_damage: 4, description: '对自己造成4点伤害', art: 'pain', unremovable: true, rarity: 'curse', character: 'curse' },
            '混乱': { type: 'curse', cost: 1, random_cost: true, description: '随机消耗1-3点能量', art: 'pain', unremovable: true, rarity: 'curse', character: 'curse' },
            '恐惧': { type: 'curse', cost: 0, fear: true, description: '本回合无法打出攻击牌', art: 'weakness-curse', unremovable: true, rarity: 'curse', character: 'curse' },
            '厄运': { type: 'curse', cost: 0, bad_luck: true, duration: 2, description: '2回合内所有卡牌效果减半', art: 'bad-luck', unremovable: true, rarity: 'curse', character: 'curse' },
            
            // 传奇卡牌（BOSS奖励）
            '暗影支配': { type: 'special', cost: 3, damage: 25, shadow_clone: true, description: '造成25点伤害并召唤暗影分身协助战斗', art: 'shadow-domination', rarity: 'legendary', character: 'legendary' },
            '龙王之怒': { type: 'attack', cost: 4, damage: 35, dragon_breath: true, description: '造成35点伤害，对所有敌人生效', art: 'dragon-fury', rarity: 'legendary', character: 'legendary' },
            '时空扭曲': { type: 'special', cost: 2, time_warp: true, extra_turn: true, description: '获得额外回合并重置所有冷却', art: 'time-warp', rarity: 'legendary', character: 'legendary' },
            
            '元素掌控': { type: 'magic', cost: 3, elemental_mastery: true, description: '根据场上元素类型造成不同效果', art: 'elemental-control', rarity: 'legendary', character: 'legendary' },
            '风暴之心': { type: 'magic', cost: 2, storm_core: true, description: '每打出一张牌获得1点能量，本回合最多5点', art: 'storm-heart', rarity: 'legendary', character: 'legendary' },
            '永恒冰晶': { type: 'defense', cost: 1, eternal_ice: true, description: '获得永久护盾，每回合+3护盾值', art: 'eternal-ice', rarity: 'legendary', character: 'legendary' },
            
            '虚空掌握': { type: 'special', cost: 4, void_mastery: true, description: '移除敌人所有正面效果并造成等量伤害', art: 'void-mastery', rarity: 'legendary', character: 'legendary' },
            '现实重构': { type: 'special', cost: 3, reality_rewrite: true, description: '重新洗牌并抽5张牌，本回合牌费用-1', art: 'reality-rewrite', rarity: 'legendary', character: 'legendary' },
            '存在湮灭': { type: 'attack', cost: 5, existence_erase: true, description: '造成敌人当前生命值50%的伤害', art: 'existence-erasure', rarity: 'legendary', character: 'legendary' },
            
            '创世之力': { type: 'special', cost: 4, genesis_power: true, description: '恢复所有生命值并获得所有正面效果', art: 'genesis-power', rarity: 'legendary', character: 'legendary' },
            '神圣审判': { type: 'attack', cost: 3, divine_judgment: true, description: '造成伤害等于敌人已损失生命值', art: 'divine-judgment', rarity: 'legendary', character: 'legendary' },
            '永恒轮回': { type: 'special', cost: 0, eternal_cycle: true, exhaust: true, description: '死亡时复活并恢复满血，获得所有传奇卡牌', art: 'eternal-cycle', rarity: 'legendary', character: 'legendary' },
            
            // 新传奇卡牌
            '自然之力': { type: 'magic', cost: 3, nature_power: true, base_damage: 10, dot_multiplier: 2, description: '每有1层自然效果（流血/毒素）造成额外伤害', art: 'nature-force', rarity: 'legendary', character: 'legendary' },
            '战争之神': { type: 'attack', cost: 4, war_god: true, base_damage: 15, strength_multiplier: 3, description: '每有1层力量获得额外伤害，消耗所有力量层数', art: 'war-god', rarity: 'legendary', character: 'legendary' }
        };

        // 敌人数据
        const enemies = [
            { name: '哥布林', icon: '👹', hp: 28, attack: 6, pattern: 'simple', abilities: [], intent: 'attack', description: '最基础的敌人，攻击简单直接' },
            { name: '哥布林弓手', icon: '🏹', hp: 22, attack: 8, pattern: 'ranged', abilities: ['precise_shot'], intent: 'attack', description: '远程攻击，有几率造成额外伤害' },
            { name: '兽人战士', icon: '🧌', hp: 42, attack: 10, pattern: 'aggressive', abilities: ['rage'], intent: 'buff', description: '血量低时会进入狂怒状态' },
            { name: '暗影刺客', icon: '🥷', hp: 30, attack: 12, pattern: 'burst', abilities: ['stealth', 'poison'], intent: 'stealth', description: '擅长潜行和毒素攻击' },
            { name: '石头巨人', icon: '🗿', hp: 65, attack: 8, pattern: 'tank', abilities: ['armor', 'thorns'], intent: 'defend', description: '高血量高防御，攻击者会受到反伤' },
            { name: '火焰恶魔', icon: '👺', hp: 48, attack: 14, pattern: 'magic', abilities: ['burn', 'fire_shield'], intent: 'attack', description: '火焰攻击会造成持续燃烧伤害' },
            { name: '冰霜法师', icon: '🧙‍♂️', hp: 38, attack: 10, pattern: 'magic', abilities: ['freeze', 'ice_armor'], intent: 'debuff', description: '冰霜魔法会冰冻敌人' },
            { name: '毒蛇', icon: '🐍', hp: 25, attack: 5, pattern: 'poison', abilities: ['poison', 'dodge'], intent: 'debuff', description: '速度快，攻击带毒，难以命中' },
            { name: '骷髅战士', icon: '💀', hp: 35, attack: 9, pattern: 'undead', abilities: ['revive', 'bone_armor'], intent: 'attack', description: '不死生物，有几率复活' },
            { name: '雷电元素', icon: '⚡', hp: 32, attack: 13, pattern: 'elemental', abilities: ['chain_lightning', 'energy_drain'], intent: 'special', description: '雷电攻击会连锁传导' },
            { name: '血魔', icon: '🩸', hp: 45, attack: 11, pattern: 'vampire', abilities: ['lifesteal', 'blood_curse'], intent: 'attack', description: '吸血攻击，会诅咒敌人' },
            { name: '机械守卫', icon: '🤖', hp: 58, attack: 12, pattern: 'construct', abilities: ['repair', 'overload'], intent: 'defend', description: '机械构造体，可以自我修复' },
            { name: '暗影领主', icon: '👤', hp: 72, attack: 16, pattern: 'shadow', abilities: ['shadow_clone', 'darkness'], intent: 'special', description: '暗影魔法大师，可以分身' },
            { name: '凤凰', icon: '🔥', hp: 55, attack: 18, pattern: 'phoenix', abilities: ['rebirth', 'fire_aura'], intent: 'attack', description: '死亡时会重生，火焰光环' },
            { name: '时间守护者', icon: '⏰', hp: 62, attack: 14, pattern: 'time', abilities: ['time_stop', 'rewind'], intent: 'special', description: '掌控时间的强大存在' },
            { name: '虚空行者', icon: '🌌', hp: 68, attack: 20, pattern: 'void', abilities: ['void_strike', 'reality_tear'], intent: 'attack', description: '来自虚空的恐怖生物' },
            { name: '古龙', icon: '🐉', hp: 120, attack: 25, pattern: 'dragon', abilities: ['dragon_breath', 'ancient_magic', 'flight'], intent: 'special', description: '古老而强大的龙族' },
            { name: '混沌之主', icon: '👁️', hp: 150, attack: 28, pattern: 'chaos', abilities: ['chaos_bolt', 'reality_warp', 'summon_minions'], intent: 'special', description: '混沌的化身，不可预测' }
        ];

        // 事件系统
        const randomEvents = [
            {
                name: '神秘商人',
                description: '你遇到了一个神秘商人，他愿意用特殊价格交易...',
                choices: [
                    { text: '购买稀有卡牌 (30金币)', cost: 30, effect: 'rare_card' },
                    { text: '购买神器 (50金币)', cost: 50, effect: 'relic' },
                    { text: '离开', cost: 0, effect: 'nothing' }
                ]
            },
            {
                name: '古老祭坛',
                description: '你发现了一个古老的祭坛，散发着神秘的力量...',
                choices: [
                    { text: '献祭生命值换取力量 (-20HP, +3力量)', cost: 20, effect: 'sacrifice_hp' },
                    { text: '净化诅咒 (移除所有诅咒卡)', cost: 0, effect: 'purify' },
                    { text: '离开', cost: 0, effect: 'nothing' }
                ]
            },
            {
                name: '魔法泉水',
                description: '你找到了一处魔法泉水，泉水闪闪发光...',
                choices: [
                    { text: '饮用泉水 (完全恢复)', cost: 0, effect: 'full_heal' },
                    { text: '用空瓶收集 (获得治疗药水卡)', cost: 0, effect: 'heal_potion' },
                    { text: '离开', cost: 0, effect: 'nothing' }
                ]
            },
            {
                name: '流浪法师',
                description: '一位流浪法师愿意传授你魔法知识...',
                choices: [
                    { text: '学习法术 (获得随机法术卡)', cost: 0, effect: 'magic_card' },
                    { text: '请求强化 (随机强化一张卡)', cost: 15, effect: 'upgrade_card' },
                    { text: '离开', cost: 0, effect: 'nothing' }
                ]
            },
            {
                name: '诅咒宝箱',
                description: '你发现了一个散发不祥气息的宝箱...',
                choices: [
                    { text: '打开宝箱 (获得稀有卡牌+诅咒卡)', cost: 0, effect: 'cursed_treasure' },
                    { text: '净化后打开 (20金币，只获得稀有卡牌)', cost: 20, effect: 'purified_treasure' },
                    { text: '离开', cost: 0, effect: 'nothing' }
                ]
            }
        ];

        // 成就系统
        const achievements = {
            'first_victory': { name: '初次胜利', description: '赢得第一场战斗', unlocked: false },
            'boss_slayer': { name: 'BOSS杀手', description: '击败第一个守关BOSS', unlocked: false },
            'legendary_collector': { name: '传奇收藏家', description: '获得第一张传奇卡牌', unlocked: false },
            'combo_master': { name: '连击大师', description: '单回合打出5张牌', unlocked: false },
            'survivor': { name: '幸存者', description: '在生命值低于10时获胜', unlocked: false },
            'perfectionist': { name: '完美主义者', description: '不受伤害完成一场战斗', unlocked: false },
            'hoarder': { name: '囤积者', description: '拥有超过100金币', unlocked: false },
            'ascension': { name: '飞升者', description: '完成一次难度提升挑战', unlocked: false }
        };

        // 卡牌强化系统
        const cardUpgrades = {
            // 通用卡牌
            '重击': { name: '重击+', damage: 14, description: '造成14点伤害（强化版）' },
            '快刀': { name: '快刀+', damage: 7, description: '造成7点伤害（强化版）' },
            '魔法飞弹': { name: '魔法飞弹+', damage: 6, hits: 2, description: '发射2枚飞弹，每枚造成6点伤害（强化版）' },
            '铁壁防御': { name: '铁壁防御+', block: 9, description: '获得9点护盾（强化版）' },
            '闪避': { name: '闪避+', block: 8, description: '获得8点护盾（强化版）' },
            '法师护甲': { name: '法师护甲+', block: 8, description: '获得8点护盾（强化版）' },
            
            // 骑士卡牌
            '正义打击': { name: '正义打击+', damage: 10, description: '造成10点神圣伤害（强化版）' },
            '十字军打击': { name: '十字军打击+', damage: 12, description: '造成12点神圣伤害（强化版）' },
            '神圣愤怒': { name: '神圣愤怒+', damage: 11, splash: 6, description: '造成11点神圣伤害，对其他敌人造成6点溅射伤害（强化版）' },
            '光明审判': { name: '光明审判+', damage: 13, heal: 4, description: '造成13点神圣伤害并恢复4点生命值（强化版）' },
            '复仇打击': { name: '复仇打击+', damage: 15, maxHealthBonus: 0.08, description: '造成15点神圣伤害，并附加目标最大生命值8%的额外伤害（强化版）' },
            '圣盾术': { name: '圣盾术+', block: 11, description: '获得11点护盾（强化版）' },
            '虔诚': { name: '虔诚+', buff: 'holy_strength', stacks: 2, description: '获得2层神圣之力（每层下次神圣攻击+4伤害）（强化版）' },
            '光明祝福': { name: '光明祝福+', buff: 'holy_armor', stacks: 3, description: '获得3层神圣护甲（每层+2护盾效果）（强化版）' },
            
            // 法师卡牌
            '火球术': { name: '火球术+', damage: 15, burn: 2, description: '造成15点伤害并施加2层燃烧（强化版）' },
            '闪电链': { name: '闪电链+', damage: 10, chain: true, description: '造成10点伤害，每有1张法术牌在手中+2伤害（强化版）' },
            '冰霜新星': { name: '冰霜新星+', damage: 8, freeze: 1, description: '造成8点伤害并冰冻敌人1回合（强化版）' },
            '奥数强化': { name: '奥数强化+', buff: 'spellpower', stacks: 3, description: '获得3层法术强度（强化版）' },
            '奥术洞察': { name: '奥术洞察+', draw: 3, energy_gain: 1, description: '抽3张牌并获得1点能量（强化版）' },
            '魔力涌流': { name: '魔力涌流+', energy_gain: 3, exhaust: true, description: '获得3点能量，使用后移除（强化版）' },
            
            // 猎人卡牌
            '精准射击': { name: '精准射击+', damage: 8, range: true, description: '造成8点远程伤害（强化版）' },
            '箭雨': { name: '箭雨+', damage: 6, hits: 3, range: true, description: '发射3支箭，每支造成6点远程伤害（强化版）' },
            '穿透射击': { name: '穿透射击+', damage: 13, pierce: true, range: true, description: '造成13点远程伤害，无视护盾（强化版）' },
            '瞄准射击': { name: '瞄准射击+', damage: 15, precision: true, range: true, description: '造成15点远程伤害，对标记的敌人伤害翻倍（强化版）' },
            '急速射击': { name: '急速射击+', damage: 9, range: true, draw: 1, description: '造成9点远程伤害并抽1张牌（强化版）' },
            '稳固射击': { name: '稳固射击+', damage: 18, range: true, exhaust: true, description: '造成18点远程伤害，使用后移除（强化版）' },
            
            // 战士卡牌
            '战吼': { name: '战吼+', damage: 8, buff: 'strength', stacks: 2, description: '造成8点伤害，获得2层力量（强化版）' },
            '嗜血': { name: '嗜血+', damage: 10, lifesteal: true, description: '造成10点伤害并恢复等量生命值（强化版）' },
            '狂暴攻击': { name: '狂暴攻击+', damage: 20, exhaust: true, description: '造成20点伤害，使用后移除（强化版）' },
            '横扫千军': { name: '横扫千军+', damage: 10, splash: 8, description: '造成10点伤害，对其他敌人造成8点溅射伤害（强化版）' },
            '斩首': { name: '斩首+', damage: 15, execute: 0.35, description: '造成15点伤害，敌人血量低于35%时秒杀（强化版）' },
            '盾牌猛击': { name: '盾牌猛击+', block: 10, damage: 8, description: '获得10护盾并造成8点伤害（强化版）' },
            
            // 盗贼卡牌
            '影袭': { name: '影袭+', damage: 10, combo: true, description: '造成10点伤害，连击：+4伤害（强化版）' },
            '毒刃': { name: '毒刃+', damage: 8, poison: 3, description: '造成8点伤害并施加3层毒素（强化版）' },
            '割裂': { name: '割裂+', damage: 8, bleed: 5, description: '造成8点伤害并施加5层流血（强化版）' },
            '致命一击': { name: '致命一击+', damage: 15, crit_bonus: 0.4, description: '造成15点伤害，40%几率造成双倍伤害（强化版）' },
            '穿刺': { name: '穿刺+', damage: 13, pierce: true, description: '造成13点伤害，无视护盾（强化版）' },
            '暗杀': { name: '暗杀+', damage: 25, stealth_bonus: true, description: '造成25点伤害，潜行时伤害翻倍（强化版）' },
            
            // 牧师卡牌
            '心灵之火': { name: '心灵之火+', damage: 8, holy: true, description: '造成8点神圣伤害，根据已恢复的生命值额外+1伤害/每8点生命恢复（强化版）' },
            '神圣之光': { name: '神圣之光+', cost: 1, heal: 7, damage: 3, holy: true, description: '恢复7点生命值并造成3点神圣伤害（强化版）' },
            '治疗术': { name: '治疗术+', cost: 2, heal: 11, damage: 4, holy: true, description: '恢复11点生命值并造成4点神圣伤害（强化版）' },
            '净化': { name: '净化+', cost: 1, cleanse: true, damage: 3, holy: true, description: '移除自身所有负面效果并造成3点神圣伤害（强化版）' },
            '信仰之力': { name: '信仰之力+', cost: 2, buff: 'faith', stacks: 3, damage: 4, holy: true, description: '获得3层信仰（每层+1治疗效果）并造成4点神圣伤害（强化版）' },
            '神圣新星': { name: '神圣新星+', cost: 3, aoe: true, damage: 9, holy: true, heal: 7, description: '对所有敌人造成9点神圣伤害并恢复7点生命值（强化版）' },
            
            // 术士卡牌
            '暗影箭': { name: '暗影箭+', damage: 10, shadow: true, description: '造成10点暗影伤害（强化版）' },
            '腐蚀术': { name: '腐蚀术+', damage: 6, dot: 4, shadow: true, description: '造成6点暗影伤害并每回合造成4点伤害，持续3回合（强化版）' },
            '吸取灵魂': { name: '吸取灵魂+', damage: 10, lifesteal: true, shadow: true, description: '造成10点暗影伤害并恢复8点生命值（强化版）' },
            '献祭': { name: '献祭+', damage: 13, fire: true, description: '造成13点火焰伤害（强化版）' },
            '地狱火': { name: '地狱火+', damage: 18, fire: true, aoe: true, self_damage: 8, description: '对所有敌人造成18点火焰伤害，对自己造成8点伤害（强化版）' },
            '灵魂收割': { name: '灵魂收割+', damage: 15, execute: 0.3, shadow: true, description: '造成15点暗影伤害，敌人血量低于30%时伤害翻倍（强化版）' }
        };

        // 守关BOSS数据
        const bosses = {
            5: {
                name: '暗影龙王',
                icon: '🐲',
                maxHp: 200,
                attack: 18,
                phases: [
                    {
                        name: '觉醒阶段',
                        hpThreshold: 1.0,
                        abilities: ['shadow_breath', 'wing_attack'],
                        description: '暗影龙王苏醒，使用基础攻击'
                    },
                    {
                        name: '愤怒阶段',
                        hpThreshold: 0.7,
                        abilities: ['shadow_breath', 'wing_attack', 'shadow_clone', 'curse_aura'],
                        description: '暗影龙王愤怒，召唤暗影分身并释放诅咒光环'
                    },
                    {
                        name: '绝望阶段',
                        hpThreshold: 0.3,
                        abilities: ['shadow_breath', 'reality_tear', 'time_distortion', 'final_judgment'],
                        description: '暗影龙王濒死，扭曲现实并准备最终审判'
                    }
                ],
                rewards: ['暗影支配', '龙王之怒', '时空扭曲']
            },
            10: {
                name: '元素领主',
                icon: '🌟',
                maxHp: 300,
                attack: 22,
                phases: [
                    {
                        name: '火焰形态',
                        hpThreshold: 1.0,
                        abilities: ['meteor_strike', 'fire_aura', 'burn_field'],
                        description: '元素领主以火焰形态出现，燃烧一切'
                    },
                    {
                        name: '冰霜形态',
                        hpThreshold: 0.6,
                        abilities: ['blizzard', 'ice_prison', 'freeze_time'],
                        description: '元素领主转换为冰霜形态，冰冻战场'
                    },
                    {
                        name: '雷电形态',
                        hpThreshold: 0.3,
                        abilities: ['chain_lightning', 'thunder_storm', 'energy_overload'],
                        description: '元素领主最终形态，雷电毁灭一切'
                    }
                ],
                rewards: ['元素掌控', '风暴之心', '永恒冰晶']
            },
            15: {
                name: '虚空君主',
                icon: '🌌',
                maxHp: 400,
                attack: 28,
                phases: [
                    {
                        name: '物质形态',
                        hpThreshold: 1.0,
                        abilities: ['void_strike', 'reality_crack', 'dimension_shift'],
                        description: '虚空君主以物质形态降临'
                    },
                    {
                        name: '能量形态',
                        hpThreshold: 0.5,
                        abilities: ['energy_drain', 'void_storm', 'mind_control'],
                        description: '虚空君主转为纯能量体，操控心智'
                    },
                    {
                        name: '终极形态',
                        hpThreshold: 0.2,
                        abilities: ['reality_collapse', 'void_singularity', 'existence_erasure'],
                        description: '虚空君主展现真正力量，威胁现实本身'
                    }
                ],
                rewards: ['虚空掌握', '现实重构', '存在湮灭']
            },
            20: {
                name: '创世神',
                icon: '✨',
                maxHp: 500,
                attack: 35,
                phases: [
                    {
                        name: '审判阶段',
                        hpThreshold: 1.0,
                        abilities: ['divine_judgment', 'holy_light', 'blessing_curse'],
                        description: '创世神审判挑战者的资格'
                    },
                    {
                        name: '试炼阶段',
                        hpThreshold: 0.6,
                        abilities: ['creation_wave', 'destruction_beam', 'time_loop'],
                        description: '创世神展现创造与毁灭的力量'
                    },
                    {
                        name: '终极试炼',
                        hpThreshold: 0.3,
                        abilities: ['genesis_storm', 'apocalypse', 'rebirth_cycle'],
                        description: '创世神的最终考验，生死轮回'
                    }
                ],
                rewards: ['创世之力', '神圣审判', '永恒轮回']
            },
            25: {
                name: '源初魔龙尼伯罗根',
                icon: '⚡🐉',
                maxHp: 650,
                attack: 42,
                phases: [
                    {
                        name: '远古苏醒',
                        hpThreshold: 1.0,
                        abilities: ['primal_flame_breath', 'dragon_roar', 'scale_armor'],
                        description: '源初魔龙从远古沉睡中苏醒，展现其古老的力量'
                    },
                    {
                        name: '元素融合',
                        hpThreshold: 0.7,
                        abilities: ['elemental_chaos', 'reality_fracture', 'time_eclipse'],
                        description: '源初魔龙融合四大元素之力，开始扭曲现实法则'
                    },
                    {
                        name: '世界末日',
                        hpThreshold: 0.4,
                        abilities: ['cataclysm', 'void_absorption', 'dragon_madness'],
                        description: '源初魔龙陷入疯狂，释放足以毁灭世界的力量'
                    },
                    {
                        name: '死亡轮回',
                        hpThreshold: 0.0,
                        abilities: ['resurrection_flame', 'eternal_agony', 'life_drain'],
                        description: '源初魔龙死亡后复活，进入不死状态，汲取生命能量'
                    },
                    {
                        name: '终焉时刻',
                        hpThreshold: 0.0,
                        abilities: ['apocalypse_beam', 'primal_annihilation', 'dragon_god_form'],
                        description: '源初魔龙完全觉醒为龙神形态，带来终焉审判'
                    }
                ],
                rewards: ['源初龙焰', '元素掌控者', '龙神之息']
            }
        };

        // 初始化游戏
        function initGame() {
            showScreen('homeScreen');
            setupEventListeners();
        }

        // 添加触摸和点击事件的辅助函数
        function addTouchAndClickEvent(element, callback) {
            if (element) {
                // 用于防止双击和触摸与点击事件的重复触发
                let lastClickTime = 0;
                const DOUBLE_CLICK_TIME = 500;
                
                // 触摸开始事件
                element.addEventListener('touchstart', function(e) {
                    // 只有在iOS上才阻止默认行为，避免在其他设备上出现问题
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.platform) || 
                                 (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                    if (isIOS) {
                        e.preventDefault();
                    }
                    
                    // 记录触摸开始位置，用于检测是否是真正的点击
                    this.startX = e.touches[0].clientX;
                    this.startY = e.touches[0].clientY;
                });
                
                // 触摸结束事件（更适合iOS的点击检测）
                element.addEventListener('touchend', function(e) {
                    // 只有在iOS上才阻止默认行为
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.platform) || 
                                 (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                    if (isIOS) {
                        e.preventDefault();
                    }
                    
                    // 检查是否是短点击（移动距离很小）
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const distance = Math.sqrt(
                        Math.pow(endX - this.startX, 2) + Math.pow(endY - this.startY, 2)
                    );
                    
                    // 如果移动距离很小，视为点击
                    if (distance < 10) {
                        // 防止重复触发
                        const now = Date.now();
                        if (now - lastClickTime > DOUBLE_CLICK_TIME) {
                            lastClickTime = now;
                            callback.call(this, e);
                        }
                    }
                });
                
                // 保留点击事件以兼容桌面设备
                element.addEventListener('click', function(e) {
                    // 防止重复触发
                    const now = Date.now();
                    if (now - lastClickTime > DOUBLE_CLICK_TIME) {
                        lastClickTime = now;
                        callback.call(this, e);
                    }
                });
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 角色选择
            // 首页菜单按钮
            addTouchAndClickEvent(document.getElementById('startButton'), () => showScreen('characterScreen'));
            addTouchAndClickEvent(document.getElementById('exitButton'), () => {
                if (confirm('确定要退出游戏吗？')) {
                    window.close();
                }
            });
            
            // 角色选择
            document.querySelectorAll('.character-card').forEach(card => {
                addTouchAndClickEvent(card, () => selectCharacter(card.dataset.character));
            });

            addTouchAndClickEvent(document.getElementById('startGame'), startGame);
            addTouchAndClickEvent(document.getElementById('enterBattle'), enterBattle);
            addTouchAndClickEvent(document.getElementById('shopBtn'), openShop);
            addTouchAndClickEvent(document.getElementById('randomEventBtn'), triggerRandomEvent);
            addTouchAndClickEvent(document.getElementById('upgradeBtn'), openUpgradeScreen);
            addTouchAndClickEvent(document.getElementById('endTurn'), endTurn);
            addTouchAndClickEvent(document.getElementById('retreatBtn'), retreat);
            addTouchAndClickEvent(document.getElementById('nextLevel'), nextLevel);
            addTouchAndClickEvent(document.getElementById('continueAdventure'), continueAdventure);
            addTouchAndClickEvent(document.getElementById('backToMenu'), backToMenu);
            addTouchAndClickEvent(document.getElementById('restartGame'), restartGame);
            addTouchAndClickEvent(document.getElementById('viewAchievements'), () => showScreen('achievementScreen'));
            addTouchAndClickEvent(document.getElementById('closeAchievements'), () => showScreen('gameOverScreen'));
            addTouchAndClickEvent(document.getElementById('skipUpgrade'), () => showScreen('deckScreen'));
        }

        // 选择角色
        function selectCharacter(characterType) {
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-character="${characterType}"]`).classList.add('selected');
            
            gameState.selectedCharacter = characterType;
            document.getElementById('startGame').disabled = false;
        }

        // 开始游戏
        function startGame() {
            const character = characters[gameState.selectedCharacter];
            gameState.playerMaxHp = character.maxHp;
            gameState.playerHp = character.maxHp;
            gameState.maxEnergy = character.maxEnergy;
            gameState.energy = character.maxEnergy;
            
            // 添加角色被动技能
            gameState.passiveAbility = character.passive;
            gameState.spellsPlayedThisTurn = 0;
            gameState.firstCardThisTurn = true;
            gameState.demonicEnergy = 0;
            
            // 添加初始卡牌
            gameState.playerDeck = [...character.startingCards];
            
            updateUI();
            showScreen('deckScreen');
            updateDeckDisplay();
        }

        // 更新UI
        function updateUI() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('gold').textContent = gameState.gold;
            document.getElementById('deckCount').textContent = gameState.playerDeck.length;
            
            // 更新buff显示
            const buffsContainer = document.getElementById('buffs');
            buffsContainer.innerHTML = '';
            gameState.buffs.forEach(buff => {
                const buffElement = document.createElement('div');
                buffElement.className = 'buff';
                buffElement.textContent = buff.name + (buff.stacks ? ` (${buff.stacks})` : '');
                buffsContainer.appendChild(buffElement);
            });
        }

        // 更新牌组显示
        function updateDeckDisplay() {
            const availableCards = document.getElementById('availableCards');
            const playerDeck = document.getElementById('playerDeck');
            
            // 清空现有内容
            availableCards.innerHTML = '';
            playerDeck.innerHTML = '';
            
            // 获取当前选中角色
            const currentCharacter = gameState.selectedCharacter;
            
            // 筛选可选卡牌
            const availableCardNames = Object.keys(cardDatabase).filter(name => 
                (!gameState.playerDeck.includes(name) || gameState.playerDeck.filter(card => card === name).length < 3) && 
                cardDatabase[name].rarity !== 'legendary'
            );
            
            // 对可用卡牌进行分类
            const categorizedCards = {
                currentCharacter: [],
                neutral: [],
                otherClasses: {}
            };
            
            // 初始化其他职业分类
            const allCharacters = ['knight', 'priest', 'warlock', 'hunter', 'warrior', 'rogue', 'mage'];
            allCharacters.forEach(char => {
                categorizedCards.otherClasses[char] = [];
            });
            
            // 按角色分类卡牌
            availableCardNames.forEach(cardName => {
                const card = cardDatabase[cardName];
                if (card.character === currentCharacter) {
                    categorizedCards.currentCharacter.push(cardName);
                } else if (card.character === 'neutral') {
                    categorizedCards.neutral.push(cardName);
                } else if (allCharacters.includes(card.character)) {
                    categorizedCards.otherClasses[card.character].push(cardName);
                }
            });
            
            // 创建角色名称映射
            const characterNames = {
                'knight': '骑士',
                'priest': '牧师',
                'warlock': '术士',
                'hunter': '猎人',
                'warrior': '战士',
                'rogue': '盗贼',
                'mage': '法师'
            };
            
            // 优先显示当前角色的卡牌
            if (categorizedCards.currentCharacter.length > 0) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'card-category';
                
                const header = document.createElement('div');
                header.className = 'category-header current-character';
                header.textContent = `${characterNames[currentCharacter] || '当前角色'}`;
                categoryDiv.appendChild(header);
                
                const cardsGrid = document.createElement('div');
                cardsGrid.className = 'cards-grid';
                
                categorizedCards.currentCharacter.forEach(cardName => {
                    const cardElement = createCardElement(cardName, () => addCardToDeck(cardName));
                    cardsGrid.appendChild(cardElement);
                });
                
                categoryDiv.appendChild(cardsGrid);
                availableCards.appendChild(categoryDiv);
            }
            
            // 显示通用卡牌
            if (categorizedCards.neutral.length > 0) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'card-category';
                
                const header = document.createElement('div');
                header.className = 'category-header';
                header.textContent = '通用卡牌';
                categoryDiv.appendChild(header);
                
                const cardsGrid = document.createElement('div');
                cardsGrid.className = 'cards-grid';
                
                categorizedCards.neutral.forEach(cardName => {
                    const cardElement = createCardElement(cardName, () => addCardToDeck(cardName));
                    cardsGrid.appendChild(cardElement);
                });
                
                categoryDiv.appendChild(cardsGrid);
                availableCards.appendChild(categoryDiv);
            }
            
            // 显示其他角色的卡牌
            allCharacters.forEach(char => {
                if (char !== currentCharacter && categorizedCards.otherClasses[char].length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'card-category';
                    
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.textContent = `${characterNames[char] || char}`;
                    categoryDiv.appendChild(header);
                    
                    const cardsGrid = document.createElement('div');
                    cardsGrid.className = 'cards-grid';
                    
                    categorizedCards.otherClasses[char].forEach(cardName => {
                        const cardElement = createCardElement(cardName, () => addCardToDeck(cardName));
                        cardsGrid.appendChild(cardElement);
                    });
                    
                    categoryDiv.appendChild(cardsGrid);
                    availableCards.appendChild(categoryDiv);
                }
            });
            
            // 显示玩家牌组
            playerDeck.innerHTML = '';
            gameState.playerDeck.forEach((cardName, index) => {
                const cardElement = createCardElement(cardName, () => removeCardFromDeck(index));
                playerDeck.appendChild(cardElement);
            });
        }

        // 创建卡牌元素
        function createCardElement(cardName, onClick) {
            const card = cardDatabase[cardName];
            // 添加安全检查，如果卡牌不存在于数据库中，使用默认值
            if (!card) {
                const cardElement = document.createElement('div');
                cardElement.className = 'card unknown';
                cardElement.innerHTML = `
                    <div class="card-art"></div>
                    <div class="card-name">❓ ${cardName}</div>
                    <div class="card-cost">💎 0</div>
                    <div class="card-description">未知卡牌</div>
                `;
                addTouchAndClickEvent(cardElement, onClick);
                return cardElement;
            }
            
            const cardElement = document.createElement('div');
            cardElement.className = `card ${card.type} rarity-${card.rarity}`;
            
            // 添加稀有度标识
            let rarityIcon = '';
            switch(card.rarity) {
                case 'common': rarityIcon = '⚪'; break;
                case 'uncommon': rarityIcon = '🟢'; break;
                case 'rare': rarityIcon = '🔵'; break;
                case 'legendary': rarityIcon = '🌟'; break;
                case 'curse': rarityIcon = '🔴'; break;
            }
            
            // 添加角色图标
            let characterIcon = '';
            if (card.character) {
                let iconText = '';
                switch(card.character) {
                    case 'knight': iconText = '骑'; break;
                    case 'priest': iconText = '牧'; break;
                    case 'warlock': iconText = '术'; break;
                    case 'hunter': iconText = '猎'; break;
                    case 'warrior': iconText = '战'; break;
                    case 'rogue': iconText = '贼'; break;
                    case 'mage': iconText = '法'; break;
                    case 'neutral': iconText = '通'; break;
                    case 'curse': iconText = '诅'; break;
                    case 'legendary': iconText = '传'; break;
                }
                characterIcon = `<div class="character-icon character-${card.character}">${iconText}</div>`;
            }
            
            cardElement.innerHTML = `
                <div class="card-art">
                    ${createStickmanArt(card.art)}
                </div>
                ${characterIcon}
                <div class="card-name">${rarityIcon} ${cardName}</div>
                <div class="card-cost">💎 ${card.cost}</div>
                <div class="card-description">${card.description}</div>
            `;
            addTouchAndClickEvent(cardElement, onClick);
            return cardElement;
        }
        
        // 创建精美敌人原画
        function createEnemyArt(enemyName) {
            const enemyArtMap = {
                '哥布林': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <radialGradient id="goblinAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#8B4513;stop-opacity:0.6" />
                            <stop offset="100%" style="stop-color:#654321;stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <!-- 邪恶光环 -->
                    <circle cx="40" cy="40" r="35" fill="url(#goblinAura)" opacity="0.7"/>
                    <!-- 哥布林头部 -->
                    <circle cx="40" cy="18" r="12" fill="#8B4513" stroke="#654321" stroke-width="2"/>
                    <!-- 邪恶眼睛 -->
                    <circle cx="36" cy="15" r="2" fill="#ff0000"/>
                    <circle cx="44" cy="15" r="2" fill="#ff0000"/>
                    <circle cx="36" cy="14" r="0.8" fill="#ffffff"/>
                    <circle cx="44" cy="14" r="0.8" fill="#ffffff"/>
                    <!-- 邪恶笑容 -->
                    <path d="M32 22 Q40 28 48 22" stroke="#654321" stroke-width="2" fill="none"/>
                    <polygon points="35,24 37,26 39,24" fill="#ffffff"/>
                    <polygon points="41,24 43,26 45,24" fill="#ffffff"/>
                    <!-- 尖耳朵 -->
                    <polygon points="28,8 32,2 36,10" fill="#654321" stroke="#4a2c17" stroke-width="1"/>
                    <polygon points="44,10 48,2 52,8" fill="#654321" stroke="#4a2c17" stroke-width="1"/>
                    <!-- 身体 -->
                    <rect x="35" y="30" width="10" height="25" fill="#8B4513" rx="3"/>
                    <!-- 破烂衣服 -->
                    <rect x="34" y="32" width="12" height="8" fill="#654321" rx="2"/>
                    <path d="M34 40 Q40 42 46 40" stroke="#4a2c17" stroke-width="1" fill="none"/>
                    <!-- 手臂 -->
                    <line x1="40" y1="35" x2="25" y2="42" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <line x1="40" y1="35" x2="55" y2="42" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <!-- 武器 - 粗糙的棍棒 -->
                    <rect x="20" y="38" width="8" height="2" fill="#654321" rx="1"/>
                    <circle cx="18" cy="39" r="2" fill="#4a2c17"/>
                    <circle cx="16" cy="37" r="1" fill="#654321"/>
                    <circle cx="17" cy="41" r="0.8" fill="#654321"/>
                    <!-- 腿部 -->
                    <line x1="40" y1="55" x2="32" y2="72" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <line x1="40" y1="55" x2="48" y2="72" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <!-- 破烂靴子 -->
                    <ellipse cx="32" cy="72" rx="3" ry="2" fill="#4a2c17"/>
                    <ellipse cx="48" cy="72" rx="3" ry="2" fill="#4a2c17"/>
                </svg>`,
                '兽人战士': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <radialGradient id="orcAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#2F4F2F;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#1C3A1C;stop-opacity:0.2" />
                        </radialGradient>
                    </defs>
                    <!-- 战士光环 -->
                    <circle cx="40" cy="40" r="35" fill="url(#orcAura)" opacity="0.8"/>
                    <!-- 兽人头部 -->
                    <circle cx="40" cy="18" r="14" fill="#2F4F2F" stroke="#1C3A1C" stroke-width="2"/>
                    <!-- 愤怒眼睛 -->
                    <circle cx="35" cy="15" r="2.5" fill="#ff0000"/>
                    <circle cx="45" cy="15" r="2.5" fill="#ff0000"/>
                    <circle cx="35" cy="14" r="1" fill="#ffffff"/>
                    <circle cx="45" cy="14" r="1" fill="#ffffff"/>
                    <!-- 獠牙 -->
                    <polygon points="36,22 38,28 40,22" fill="#ffffff"/>
                    <polygon points="40,22 42,28 44,22" fill="#ffffff"/>
                    <!-- 愤怒表情 -->
                    <path d="M32 24 Q40 30 48 24" stroke="#1C3A1C" stroke-width="3" fill="none"/>
                    <!-- 战争涂料 -->
                    <path d="M30 12 Q35 8 40 12" stroke="#8B0000" stroke-width="2" fill="none"/>
                    <path d="M40 12 Q45 8 50 12" stroke="#8B0000" stroke-width="2" fill="none"/>
                    <!-- 肌肉身体 -->
                    <rect x="34" y="32" width="12" height="28" fill="#2F4F2F" rx="4"/>
                    <!-- 护甲 -->
                    <rect x="32" y="34" width="16" height="8" fill="#654321" rx="2"/>
                    <circle cx="40" cy="38" r="2" fill="#8B4513"/>
                    <!-- 强壮手臂 -->
                    <line x1="40" y1="38" x2="20" y2="45" stroke="#2F4F2F" stroke-width="5" stroke-linecap="round"/>
                    <line x1="40" y1="38" x2="60" y2="45" stroke="#2F4F2F" stroke-width="5" stroke-linecap="round"/>
                    <!-- 巨斧 -->
                    <rect x="15" y="42" width="12" height="3" fill="#8B4513" rx="1"/>
                    <polygon points="12,38 18,42 18,47 12,47" fill="#C0C0C0" stroke="#999" stroke-width="1"/>
                    <polygon points="12,38 8,42 12,47" fill="#999"/>
                    <!-- 腿部 -->
                    <line x1="40" y1="60" x2="32" y2="75" stroke="#2F4F2F" stroke-width="5" stroke-linecap="round"/>
                    <line x1="40" y1="60" x2="48" y2="75" stroke="#2F4F2F" stroke-width="5" stroke-linecap="round"/>
                    <!-- 战靴 -->
                    <ellipse cx="32" cy="75" rx="4" ry="3" fill="#654321"/>
                    <ellipse cx="48" cy="75" rx="4" ry="3" fill="#654321"/>
                </svg>`,
                '暗影刺客': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <radialGradient id="shadowAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#800080;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#2C2C2C;stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <!-- 暗影领域 -->
                    <circle cx="40" cy="40" r="35" fill="url(#shadowAura)" opacity="0.9"/>
                    <!-- 半透明刺客头部 -->
                    <circle cx="40" cy="18" r="10" fill="#2C2C2C" stroke="#800080" stroke-width="2" opacity="0.7"/>
                    <!-- 发光眼睛 -->
                    <circle cx="36" cy="16" r="1.5" fill="#ff0000" opacity="1"/>
                    <circle cx="44" cy="16" r="1.5" fill="#ff0000" opacity="1"/>
                    <circle cx="36" cy="15" r="0.5" fill="#ffffff"/>
                    <circle cx="44" cy="15" r="0.5" fill="#ffffff"/>
                    <!-- 面罩 -->
                    <path d="M32 20 Q40 18 48 20 Q44 24 40 24 Q36 24 32 20" fill="#1a1a1a" opacity="0.8"/>
                    <!-- 暗影身体 -->
                    <rect x="36" y="28" width="8" height="25" fill="#2C2C2C" rx="3" opacity="0.6"/>
                    <!-- 暗影轮廓 -->
                    <rect x="34" y="26" width="12" height="29" fill="none" stroke="#800080" stroke-width="2" stroke-dasharray="3,3" rx="4" opacity="0.8"/>
                    <!-- 暗影手臂 -->
                    <line x1="40" y1="35" x2="22" y2="42" stroke="#800080" stroke-width="3" stroke-linecap="round" opacity="0.8" stroke-dasharray="4,2"/>
                    <line x1="40" y1="35" x2="58" y2="42" stroke="#800080" stroke-width="3" stroke-linecap="round" opacity="0.8" stroke-dasharray="4,2"/>
                    <!-- 暗影匕首 -->
                    <rect x="18" y="40" width="8" height="1.5" fill="#C0C0C0" opacity="0.9"/>
                    <polygon points="18,39 16,41 18,42" fill="#800080" opacity="0.8"/>
                    <rect x="54" y="40" width="8" height="1.5" fill="#C0C0C0" opacity="0.9"/>
                    <polygon points="62,39 64,41 62,42" fill="#800080" opacity="0.8"/>
                    <!-- 暗影粒子 -->
                    <circle cx="25" cy="30" r="1.5" fill="#800080" opacity="0.9"/>
                    <circle cx="55" cy="35" r="1" fill="#4a0080" opacity="0.7"/>
                    <circle cx="30" cy="50" r="0.8" fill="#800080" opacity="0.8"/>
                    <circle cx="50" cy="45" r="1.2" fill="#4a0080" opacity="0.6"/>
                    <!-- 暗影腿部 -->
                    <line x1="40" y1="53" x2="34" y2="70" stroke="#800080" stroke-width="3" stroke-linecap="round" opacity="0.6" stroke-dasharray="3,3"/>
                    <line x1="40" y1="53" x2="46" y2="70" stroke="#800080" stroke-width="3" stroke-linecap="round" opacity="0.6" stroke-dasharray="3,3"/>
                </svg>`,
                '石头巨人': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <linearGradient id="stoneGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#999999" />
                            <stop offset="50%" style="stop-color:#696969" />
                            <stop offset="100%" style="stop-color:#2F4F4F" />
                        </linearGradient>
                    </defs>
                    <!-- 石头光环 -->
                    <circle cx="40" cy="40" r="35" fill="#696969" opacity="0.3"/>
                    <!-- 巨大头部 -->
                    <rect x="28" y="8" width="24" height="20" fill="url(#stoneGrad)" stroke="#2F4F4F" stroke-width="2" rx="4"/>
                    <!-- 发光眼睛 -->
                    <circle cx="34" cy="16" r="3" fill="#FF4500"/>
                    <circle cx="46" cy="16" r="3" fill="#FF4500"/>
                    <circle cx="34" cy="15" r="1" fill="#ffff00"/>
                    <circle cx="46" cy="15" r="1" fill="#ffff00"/>
                    <!-- 石头纹理 -->
                    <rect x="30" y="22" width="20" height="3" fill="#2F4F4F" rx="1"/>
                    <circle cx="32" cy="12" r="1" fill="#8B4513"/>
                    <circle cx="48" cy="20" r="1.5" fill="#8B4513"/>
                    <circle cx="40" cy="25" r="1" fill="#8B4513"/>
                    <!-- 巨大身体 -->
                    <rect x="25" y="28" width="30" height="28" fill="url(#stoneGrad)" stroke="#2F4F4F" stroke-width="2" rx="3"/>
                    <!-- 胸甲细节 -->
                    <rect x="27" y="32" width="26" height="6" fill="#2F4F4F" rx="2"/>
                    <circle cx="40" cy="35" r="2" fill="#8B4513"/>
                    <!-- 巨大手臂 -->
                    <rect x="12" y="32" width="13" height="20" fill="url(#stoneGrad)" stroke="#2F4F4F" stroke-width="2" rx="3"/>
                    <rect x="55" y="32" width="13" height="20" fill="url(#stoneGrad)" stroke="#2F4F4F" stroke-width="2" rx="3"/>
                    <!-- 手部 -->
                    <circle cx="18" cy="52" r="4" fill="#696969" stroke="#2F4F4F" stroke-width="1"/>
                    <circle cx="61" cy="52" r="4" fill="#696969" stroke="#2F4F4F" stroke-width="1"/>
                    <!-- 巨大腿部 -->
                    <rect x="30" y="56" width="8" height="18" fill="url(#stoneGrad)" stroke="#2F4F4F" stroke-width="2"/>
                    <rect x="42" y="56" width="8" height="18" fill="url(#stoneGrad)" stroke="#2F4F4F" stroke-width="2"/>
                    <!-- 石头靴 -->
                    <ellipse cx="34" cy="74" rx="5" ry="3" fill="#2F4F4F"/>
                    <ellipse cx="46" cy="74" rx="5" ry="3" fill="#2F4F4F"/>
                </svg>`,
                '火焰恶魔': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <radialGradient id="fireAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#ff6600;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#ff0000;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#8B0000;stop-opacity:0.2" />
                        </radialGradient>
                    </defs>
                    <!-- 火焰光环 -->
                    <circle cx="40" cy="40" r="35" fill="url(#fireAura)" opacity="0.9"/>
                    <!-- 恶魔头部 -->
                    <circle cx="40" cy="18" r="13" fill="#8B0000" stroke="#FF0000" stroke-width="2"/>
                    <!-- 火焰眼睛 -->
                    <circle cx="35" cy="15" r="2.5" fill="#FF4500"/>
                    <circle cx="45" cy="15" r="2.5" fill="#FF4500"/>
                    <circle cx="35" cy="14" r="1" fill="#ffff00"/>
                    <circle cx="45" cy="14" r="1" fill="#ffff00"/>
                    <!-- 恶魔角 -->
                    <polygon points="30,5 34,0 38,8" fill="#FF4500" stroke="#ff0000" stroke-width="1"/>
                    <polygon points="42,8 46,0 50,5" fill="#FF4500" stroke="#ff0000" stroke-width="1"/>
                    <!-- 邪恶笑容 -->
                    <path d="M30 24 Q40 30 50 24" stroke="#FF0000" stroke-width="3" fill="none"/>
                    <polygon points="33,26 35,29 37,26" fill="#ffffff"/>
                    <polygon points="43,26 45,29 47,26" fill="#ffffff"/>
                    <!-- 火焰身体 -->
                    <rect x="33" y="31" width="14" height="25" fill="#8B0000" rx="4"/>
                    <!-- 火焰纹理 -->
                    <path d="M35 33 Q40 30 45 33 Q40 36 35 33" fill="#FF4500" opacity="0.8"/>
                    <path d="M36 40 Q40 37 44 40 Q40 43 36 40" fill="#ff6600" opacity="0.7"/>
                    <!-- 火焰手臂 -->
                    <line x1="40" y1="38" x2="20" y2="48" stroke="#8B0000" stroke-width="4" stroke-linecap="round"/>
                    <line x1="40" y1="38" x2="60" y2="48" stroke="#8B0000" stroke-width="4" stroke-linecap="round"/>
                    <!-- 火焰效果 -->
                    <circle cx="25" cy="35" r="3" fill="#FF4500" opacity="0.9"/>
                    <circle cx="23" cy="32" r="2" fill="#ff6600" opacity="0.8"/>
                    <circle cx="27" cy="38" r="1.5" fill="#ffff00" opacity="0.7"/>
                    <circle cx="55" cy="38" r="3" fill="#FF4500" opacity="0.9"/>
                    <circle cx="57" cy="35" r="2" fill="#ff6600" opacity="0.8"/>
                    <circle cx="53" cy="41" r="1.5" fill="#ffff00" opacity="0.7"/>
                    <!-- 火焰腿部 -->
                    <line x1="40" y1="56" x2="32" y2="72" stroke="#8B0000" stroke-width="4" stroke-linecap="round"/>
                    <line x1="40" y1="56" x2="48" y2="72" stroke="#8B0000" stroke-width="4" stroke-linecap="round"/>
                    <!-- 火焰足迹 -->
                    <ellipse cx="32" cy="72" rx="4" ry="2" fill="#FF4500" opacity="0.8"/>
                    <ellipse cx="48" cy="72" rx="4" ry="2" fill="#FF4500" opacity="0.8"/>
                </svg>`
            };
            
            // 添加BOSS原画
            const bossArtMap = {
                '暗影龙王': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <radialGradient id="dragonAura" cx="50%" cy="50%" r="70%">
                            <stop offset="0%" style="stop-color:#800080;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#4a0080;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#2c2c2c;stop-opacity:0.3" />
                        </radialGradient>
                        <linearGradient id="dragonScale" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4a0080" />
                            <stop offset="50%" style="stop-color:#800080" />
                            <stop offset="100%" style="stop-color:#2c2c2c" />
                        </linearGradient>
                    </defs>
                    <!-- 暗影领域 -->
                    <circle cx="40" cy="40" r="38" fill="url(#dragonAura)" opacity="0.9"/>
                    <!-- 龙头 -->
                    <ellipse cx="40" cy="20" rx="18" ry="12" fill="url(#dragonScale)" stroke="#800080" stroke-width="2"/>
                    <!-- 龙眼 -->
                    <circle cx="32" cy="18" r="3" fill="#ff0000"/>
                    <circle cx="48" cy="18" r="3" fill="#ff0000"/>
                    <circle cx="32" cy="17" r="1" fill="#ffffff"/>
                    <circle cx="48" cy="17" r="1" fill="#ffffff"/>
                    <!-- 龙角 -->
                    <polygon points="25,8 30,2 35,12" fill="#4a0080" stroke="#800080" stroke-width="1"/>
                    <polygon points="45,12 50,2 55,8" fill="#4a0080" stroke="#800080" stroke-width="1"/>
                    <!-- 龙嘴 -->
                    <path d="M22 25 Q40 35 58 25" stroke="#800080" stroke-width="3" fill="none"/>
                    <polygon points="35,28 40,32 45,28" fill="#ff0000"/>
                    <!-- 龙身 -->
                    <ellipse cx="40" cy="45" rx="20" ry="15" fill="url(#dragonScale)" stroke="#800080" stroke-width="2"/>
                    <!-- 龙鳞纹理 -->
                    <circle cx="30" cy="40" r="2" fill="#800080" opacity="0.7"/>
                    <circle cx="50" cy="42" r="2" fill="#800080" opacity="0.7"/>
                    <circle cx="40" cy="48" r="2" fill="#800080" opacity="0.7"/>
                    <circle cx="35" cy="52" r="1.5" fill="#4a0080" opacity="0.8"/>
                    <circle cx="45" cy="50" r="1.5" fill="#4a0080" opacity="0.8"/>
                    <!-- 龙翼 -->
                    <path d="M15 35 Q5 25 15 15 Q25 25 20 40" fill="#2c2c2c" stroke="#800080" stroke-width="2" opacity="0.8"/>
                    <path d="M65 35 Q75 25 65 15 Q55 25 60 40" fill="#2c2c2c" stroke="#800080" stroke-width="2" opacity="0.8"/>
                    <!-- 暗影效果 -->
                    <circle cx="20" cy="30" r="3" fill="#800080" opacity="0.6"/>
                    <circle cx="60" cy="35" r="2.5" fill="#4a0080" opacity="0.7"/>
                    <circle cx="40" cy="65" r="4" fill="#2c2c2c" opacity="0.5"/>
                    <!-- 龙尾 -->
                    <path d="M40 60 Q30 70 40 75 Q50 70 40 60" fill="url(#dragonScale)" stroke="#800080" stroke-width="1"/>
                </svg>`,
                '元素领主': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <radialGradient id="elementalAura" cx="50%" cy="50%" r="70%">
                            <stop offset="0%" style="stop-color:#ffff00;stop-opacity:1" />
                            <stop offset="30%" style="stop-color:#ff6600;stop-opacity:0.8" />
                            <stop offset="60%" style="stop-color:#0066ff;stop-opacity:0.6" />
                            <stop offset="100%" style="stop-color:#00ff00;stop-opacity:0.3" />
                        </radialGradient>
                    </defs>
                    <!-- 元素光环 -->
                    <circle cx="40" cy="40" r="38" fill="url(#elementalAura)" opacity="0.9"/>
                    <!-- 元素核心 -->
                    <circle cx="40" cy="40" r="15" fill="#ffffff" stroke="#ffff00" stroke-width="3"/>
                    <circle cx="40" cy="40" r="10" fill="#ffff00" opacity="0.8"/>
                    <circle cx="40" cy="40" r="5" fill="#ffffff"/>
                    <!-- 火焰元素 -->
                    <circle cx="25" cy="25" r="6" fill="#ff6600" opacity="0.9"/>
                    <circle cx="23" cy="23" r="3" fill="#ffff00" opacity="0.8"/>
                    <path d="M20 20 Q25 15 30 20 Q25 25 20 20" fill="#ff0000" opacity="0.7"/>
                    <!-- 冰霜元素 -->
                    <polygon points="55,20 60,25 55,30 50,25" fill="#00bfff" opacity="0.9"/>
                    <polygon points="53,22 57,25 53,28 49,25" fill="#ffffff" opacity="0.8"/>
                    <circle cx="55" cy="25" r="2" fill="#87ceeb" opacity="0.7"/>
                    <!-- 雷电元素 -->
                    <path d="M20 55 L25 65 L23 65 L28 75 L25 70 L22 70 L20 55" fill="#ffff00" opacity="0.9"/>
                    <path d="M18 57 Q22 52 26 57" stroke="#ffffff" stroke-width="2" fill="none" opacity="0.8"/>
                    <!-- 自然元素 -->
                    <circle cx="60" cy="60" r="5" fill="#00ff00" opacity="0.9"/>
                    <circle cx="58" cy="58" r="2" fill="#90ee90" opacity="0.8"/>
                    <circle cx="62" cy="62" r="1.5" fill="#32cd32" opacity="0.7"/>
                    <!-- 元素眼睛 -->
                    <circle cx="35" cy="35" r="2" fill="#ffffff"/>
                    <circle cx="45" cy="35" r="2" fill="#ffffff"/>
                    <circle cx="35" cy="34" r="1" fill="#ffff00"/>
                    <circle cx="45" cy="34" r="1" fill="#ffff00"/>
                    <!-- 元素轨道 -->
                    <circle cx="40" cy="40" r="25" fill="none" stroke="#ffff00" stroke-width="2" opacity="0.6" stroke-dasharray="5,5"/>
                    <circle cx="40" cy="40" r="30" fill="none" stroke="#ff6600" stroke-width="1.5" opacity="0.5" stroke-dasharray="3,3"/>
                    <circle cx="40" cy="40" r="35" fill="none" stroke="#0066ff" stroke-width="1" opacity="0.4" stroke-dasharray="2,2"/>
                </svg>`,
                '虚空君主': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <radialGradient id="voidAura" cx="50%" cy="50%" r="70%">
                            <stop offset="0%" style="stop-color:#000000;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#4a0080;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#800080;stop-opacity:0.3" />
                        </radialGradient>
                    </defs>
                    <!-- 虚空领域 -->
                    <circle cx="40" cy="40" r="38" fill="url(#voidAura)" opacity="0.95"/>
                    <!-- 虚空裂缝 -->
                    <path d="M10 10 Q40 20 70 10 Q40 30 10 10" fill="none" stroke="#800080" stroke-width="3" opacity="0.8"/>
                    <path d="M10 70 Q40 60 70 70 Q40 50 10 70" fill="none" stroke="#800080" stroke-width="3" opacity="0.8"/>
                    <path d="M10 40 Q20 20 40 40 Q60 20 70 40" fill="none" stroke="#4a0080" stroke-width="2" opacity="0.7"/>
                    <!-- 虚空核心 -->
                    <circle cx="40" cy="40" r="12" fill="#000000" stroke="#800080" stroke-width="3"/>
                    <circle cx="40" cy="40" r="8" fill="#4a0080" opacity="0.8"/>
                    <circle cx="40" cy="40" r="4" fill="#800080" opacity="0.6"/>
                    <circle cx="40" cy="40" r="2" fill="#ffffff"/>
                    <!-- 虚空眼睛 -->
                    <circle cx="35" cy="35" r="3" fill="#800080"/>
                    <circle cx="45" cy="35" r="3" fill="#800080"/>
                    <circle cx="35" cy="34" r="1.5" fill="#ffffff"/>
                    <circle cx="45" cy="34" r="1.5" fill="#ffffff"/>
                    <!-- 虚空触手 -->
                    <path d="M25 50 Q15 60 25 70 Q35 60 25 50" fill="#4a0080" opacity="0.7"/>
                    <path d="M55 50 Q65 60 55 70 Q45 60 55 50" fill="#4a0080" opacity="0.7"/>
                    <path d="M40 55 Q30 65 40 75 Q50 65 40 55" fill="#4a0080" opacity="0.7"/>
                    <!-- 虚空粒子 -->
                    <circle cx="20" cy="20" r="1.5" fill="#800080" opacity="0.9"/>
                    <circle cx="60" cy="25" r="1" fill="#4a0080" opacity="0.8"/>
                    <circle cx="15" cy="60" r="1.2" fill="#800080" opacity="0.7"/>
                    <circle cx="65" cy="55" r="0.8" fill="#4a0080" opacity="0.9"/>
                    <circle cx="25" cy="35" r="1" fill="#800080" opacity="0.6"/>
                    <circle cx="55" cy="45" r="1.3" fill="#4a0080" opacity="0.8"/>
                    <!-- 现实扭曲效果 -->
                    <path d="M5 40 Q20 30 35 40 Q50 50 65 40 Q50 30 35 40 Q20 50 5 40" fill="none" stroke="#800080" stroke-width="1.5" opacity="0.5" stroke-dasharray="4,4"/>
                </svg>`,
                '创世神': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <radialGradient id="divineAura" cx="50%" cy="50%" r="70%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                            <stop offset="30%" style="stop-color:#ffd700;stop-opacity:0.9" />
                            <stop offset="60%" style="stop-color:#ffb347;stop-opacity:0.7" />
                            <stop offset="100%" style="stop-color:#ff8c00;stop-opacity:0.3" />
                        </radialGradient>
                    </defs>
                    <!-- 神圣光环 -->
                    <circle cx="40" cy="40" r="38" fill="url(#divineAura)" opacity="0.95"/>
                    <!-- 神圣光芒 -->
                    <line x1="40" y1="5" x2="40" y2="15" stroke="#ffffff" stroke-width="3" opacity="0.9"/>
                    <line x1="40" y1="65" x2="40" y2="75" stroke="#ffffff" stroke-width="3" opacity="0.9"/>
                    <line x1="5" y1="40" x2="15" y2="40" stroke="#ffffff" stroke-width="3" opacity="0.9"/>
                    <line x1="65" y1="40" x2="75" y2="40" stroke="#ffffff" stroke-width="3" opacity="0.9"/>
                    <line x1="15" y1="15" x2="22" y2="22" stroke="#ffd700" stroke-width="2" opacity="0.8"/>
                    <line x1="58" y1="22" x2="65" y2="15" stroke="#ffd700" stroke-width="2" opacity="0.8"/>
                    <line x1="15" y1="65" x2="22" y2="58" stroke="#ffd700" stroke-width="2" opacity="0.8"/>
                    <line x1="58" y1="58" x2="65" y2="65" stroke="#ffd700" stroke-width="2" opacity="0.8"/>
                    <!-- 神圣头部 -->
                    <circle cx="40" cy="25" r="12" fill="#ffffff" stroke="#ffd700" stroke-width="2"/>
                    <!-- 神圣眼睛 -->
                    <circle cx="35" cy="22" r="2.5" fill="#ffd700"/>
                    <circle cx="45" cy="22" r="2.5" fill="#ffd700"/>
                    <circle cx="35" cy="21" r="1" fill="#ffffff"/>
                    <circle cx="45" cy="21" r="1" fill="#ffffff"/>
                    <!-- 神圣光环头饰 -->
                    <circle cx="40" cy="25" r="18" fill="none" stroke="#ffd700" stroke-width="2" opacity="0.7"/>
                    <circle cx="40" cy="25" r="15" fill="none" stroke="#ffb347" stroke-width="1.5" opacity="0.6"/>
                    <!-- 神圣身体 -->
                    <rect x="32" y="37" width="16" height="25" fill="#ffffff" stroke="#ffd700" stroke-width="2" rx="5"/>
                    <!-- 神圣纹饰 -->
                    <circle cx="40" cy="45" r="4" fill="#ffd700" opacity="0.8"/>
                    <circle cx="40" cy="45" r="2" fill="#ffffff"/>
                    <path d="M35 50 Q40 47 45 50" stroke="#ffd700" stroke-width="2" fill="none"/>
                    <path d="M35 55 Q40 52 45 55" stroke="#ffb347" stroke-width="1.5" fill="none"/>
                    <!-- 神圣翅膀 -->
                    <path d="M20 40 Q10 30 20 20 Q30 30 25 45" fill="#ffffff" stroke="#ffd700" stroke-width="1.5" opacity="0.9"/>
                    <path d="M60 40 Q70 30 60 20 Q50 30 55 45" fill="#ffffff" stroke="#ffd700" stroke-width="1.5" opacity="0.9"/>
                    <!-- 翅膀羽毛细节 -->
                    <path d="M22 25 Q18 22 22 20" stroke="#ffd700" stroke-width="1" fill="none"/>
                    <path d="M24 30 Q20 27 24 25" stroke="#ffd700" stroke-width="1" fill="none"/>
                    <path d="M58 25 Q62 22 58 20" stroke="#ffd700" stroke-width="1" fill="none"/>
                    <path d="M56 30 Q60 27 56 25" stroke="#ffd700" stroke-width="1" fill="none"/>
                    <!-- 神圣能量 -->
                    <circle cx="25" cy="35" r="2" fill="#ffd700" opacity="0.8"/>
                    <circle cx="55" cy="35" r="2" fill="#ffd700" opacity="0.8"/>
                    <circle cx="30" cy="60" r="1.5" fill="#ffb347" opacity="0.7"/>
                    <circle cx="50" cy="60" r="1.5" fill="#ffb347" opacity="0.7"/>
                </svg>`,
                '源初魔龙尼伯罗根': `<svg class="enemy-art" viewBox="0 0 80 80">
                    <defs>
                        <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#1a1a2e" />
                            <stop offset="100%" stop-color="#16213e" />
                        </linearGradient>
                        <radialGradient id="glowGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                            <stop offset="0%" stop-color="#ff5252" stop-opacity="0.8" />
                            <stop offset="100%" stop-color="#ff5252" stop-opacity="0" />
                        </radialGradient>
                    </defs>
                    <!-- 发光效果 -->
                    <circle cx="40" cy="40" r="38" fill="url(#glowGradient)" opacity="0.7" />
                    
                    <!-- 龙的身体 -->
                    <g>
                        <!-- 龙的主体 -->
                        <path d="M40,30 C35,25 30,28 25,26 C20,24 18,20 18,16 C18,12 22,10 26,12 C30,14 32,18 35,17 C38,16 40,14 42,13 C44,12 46,13 48,15 C50,17 52,20 54,23 C56,26 58,30 60,34 C62,38 64,43 62,47 C60,51 55,54 50,55 C45,56 40,55 35,53 C30,51 27,47 25,43 C23,39 22,34 24,30 C26,26 30,24 35,25 C40,26 45,28 40,30 Z" 
                              fill="#2c3e50" stroke="#e74c3c" stroke-width="2" />
                        
                        <!-- 龙的脖子和头部 -->
                        <path d="M40,30 C42,29 45,28 48,27 C51,26 54,25 57,24 C60,23 63,23 65,24 C67,25 68,27 67,29 C66,31 64,33 62,34" 
                              fill="#2c3e50" stroke="#e74c3c" stroke-width="2" />
                        
                        <!-- 头部细节 -->
                        <path d="M67,29 C68,30 69,31 69,32 C69,33 68,34 67,34 C66,34 65,33 65,32 C65,31 66,30 67,29 Z" 
                              fill="#34495e" stroke="#e74c3c" stroke-width="1" />
                        
                        <!-- 眼睛 - 红色发光眼睛 -->
                        <circle cx="65" cy="28" r="1.5" fill="#2c3e50" />
                        <circle cx="65" cy="28" r="0.8" fill="#e74c3c" />
                        <circle cx="65" cy="28" r="0.3" fill="white" />
                        <circle cx="65" cy="28" r="2.5" fill="none" stroke="#e74c3c" stroke-width="0.5" opacity="0.5" />
                        
                        <!-- 龙角 -->
                        <path d="M66,24 C67,21 69,19 68,17" stroke="#e74c3c" stroke-width="0.8" fill="none" />
                        <path d="M64,24 C63,21 61,19 62,17" stroke="#e74c3c" stroke-width="0.8" fill="none" />
                        
                        <!-- 龙的翅膀 -->
                        <path d="M40,30 C38,28 35,26 32,24 C29,22 26,23 24,25 C22,27 21,29 22,31 C23,33 25,35 28,36" 
                              fill="#1a1a2e" stroke="#e74c3c" stroke-width="0.8" />
                        
                        <!-- 翅膀细节 -->
                        <path d="M32,24 C30,27 27,30 25,33" stroke="#e74c3c" stroke-width="0.5" fill="none" />
                        <path d="M29,22 C27,25 25,28 23,31" stroke="#e74c3c" stroke-width="0.5" fill="none" />
                        
                        <!-- 龙的尾巴 -->
                        <path d="M25,43 C23,45 22,47 21,49 C20,51 19,53 20,55 C21,57 23,58 25,57" 
                              stroke="#e74c3c" stroke-width="0.8" fill="none" />
                        
                        <!-- 爪子 -->
                        <path d="M40,30 C41,32 42,34 41,36" stroke="#e74c3c" stroke-width="0.8" fill="none" />
                        <path d="M41,36 C40.5,37 40,37 39.5,36" stroke="#e74c3c" stroke-width="0.5" fill="none" />
                        
                        <path d="M45,35 C46,37 47,39 46,41" stroke="#e74c3c" stroke-width="0.8" fill="none" />
                        <path d="M46,41 C45.5,42 45,42 44.5,41" stroke="#e74c3c" stroke-width="0.5" fill="none" />
                        
                        <!-- 腹部 -->
                        <path d="M35,30 C36,31 38,31 40,30 C42,29 44,29 45,30 C46,31 48,31 50,30 C52,29 54,29 56,30 C58,31 60,32 62,34" 
                              stroke="#e74c3c" stroke-width="0.5" fill="none" opacity="0.5" />
                        
                        <!-- 能量效果 -->
                        <path d="M67,29 C69,32 71,36 69,40 C67,44 63,48 62,47" 
                              stroke="#e74c3c" stroke-width="0.5" stroke-dasharray="1,1" fill="none" opacity="0.7" />
                    </g>
                </svg>`
            };
            
            // 合并所有敌人原画
            const allEnemyArt = { ...enemyArtMap, ...bossArtMap };
            
            return allEnemyArt[enemyName] || allEnemyArt['哥布林'];
        }
        
        // 创建精美卡牌原画
        function createStickmanArt(artType) {
            const artMap = {
                'sword-strike': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="swordGlow" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#ffff00;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#ff6600;stop-opacity:0.2" />
                        </radialGradient>
                        <linearGradient id="swordBlade" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#e6e6e6" />
                            <stop offset="50%" style="stop-color:#ffffff" />
                            <stop offset="100%" style="stop-color:#cccccc" />
                        </linearGradient>
                    </defs>
                    <!-- 背景光效 -->
                    <circle cx="30" cy="30" r="25" fill="url(#swordGlow)" opacity="0.6"/>
                    <!-- 战士身体 -->
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <rect x="27" y="17" width="6" height="18" fill="#8B4513" rx="2"/>
                    <!-- 护甲细节 -->
                    <rect x="26" y="18" width="8" height="4" fill="#C0C0C0" rx="1"/>
                    <circle cx="30" cy="20" r="1" fill="#FFD700"/>
                    <!-- 手臂 -->
                    <line x1="30" y1="22" x2="18" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="22" x2="42" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <!-- 剑柄 -->
                    <rect x="15" y="26" width="2" height="8" fill="#8B4513" rx="1"/>
                    <!-- 剑刃 -->
                    <polygon points="16,18 18,20 18,26 16,26" fill="url(#swordBlade)" stroke="#999" stroke-width="0.5"/>
                    <!-- 剑光效果 -->
                    <line x1="17" y1="18" x2="17" y2="26" stroke="#ffffff" stroke-width="0.5" opacity="0.8"/>
                    <!-- 攻击轨迹 -->
                    <path d="M 10 15 Q 20 10 25 20" stroke="#ffff00" stroke-width="2" fill="none" opacity="0.7"/>
                    <path d="M 8 17 Q 18 12 23 22" stroke="#ff6600" stroke-width="1" fill="none" opacity="0.5"/>
                    <!-- 腿部 -->
                    <line x1="30" y1="35" x2="25" y2="50" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="35" y2="50" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <!-- 靴子 -->
                    <ellipse cx="25" cy="50" rx="2" ry="1" fill="#654321"/>
                    <ellipse cx="35" cy="50" rx="2" ry="1" fill="#654321"/>
                </svg>`,
                'charge': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="chargeAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#ff4444;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#ffaa00;stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <!-- 冲锋光环 -->
                    <circle cx="30" cy="30" r="28" fill="url(#chargeAura)" opacity="0.7"/>
                    <!-- 战士头部 -->
                    <circle cx="25" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <!-- 愤怒表情 -->
                    <circle cx="23" cy="10" r="0.5" fill="#ff0000"/>
                    <circle cx="27" cy="10" r="0.5" fill="#ff0000"/>
                    <path d="M 22 14 Q 25 16 28 14" stroke="#8B0000" stroke-width="1" fill="none"/>
                    <!-- 冲锋姿态身体 -->
                    <rect x="22" y="17" width="6" height="16" fill="#8B4513" rx="2" transform="rotate(15 25 25)"/>
                    <!-- 盾牌 -->
                    <ellipse cx="15" cy="20" rx="4" ry="6" fill="#C0C0C0" stroke="#999" stroke-width="1"/>
                    <circle cx="15" cy="20" r="2" fill="#FFD700"/>
                    <!-- 冲锋手臂 -->
                    <line x1="25" y1="20" x2="15" y2="18" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="25" y1="20" x2="40" y2="25" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <!-- 武器 -->
                    <rect x="38" y="22" width="8" height="2" fill="#8B4513" rx="1"/>
                    <polygon points="46,20 50,24 46,26" fill="#C0C0C0" stroke="#999" stroke-width="0.5"/>
                    <!-- 速度线 -->
                    <line x1="5" y1="15" x2="15" y2="17" stroke="#ffff00" stroke-width="2" opacity="0.8"/>
                    <line x1="3" y1="20" x2="13" y2="22" stroke="#ffaa00" stroke-width="1.5" opacity="0.6"/>
                    <line x1="7" y1="25" x2="17" y2="27" stroke="#ff6600" stroke-width="1" opacity="0.4"/>
                    <!-- 腿部冲锋姿态 -->
                    <line x1="25" y1="33" x2="20" y2="48" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <line x1="25" y1="33" x2="35" y2="50" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'dagger': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <linearGradient id="rogueCloak" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#2c2c2c" />
                            <stop offset="100%" style="stop-color:#1a1a1a" />
                        </linearGradient>
                    </defs>
                    <!-- 暗影背景 -->
                    <circle cx="30" cy="30" r="25" fill="#000000" opacity="0.3"/>
                    <!-- 盗贼头部 -->
                    <circle cx="30" cy="12" r="4" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <!-- 面罩 -->
                    <path d="M 26 10 Q 30 8 34 10 Q 32 14 30 14 Q 28 14 26 10" fill="#2c2c2c"/>
                    <circle cx="28" cy="11" r="0.5" fill="#ff0000"/>
                    <circle cx="32" cy="11" r="0.5" fill="#ff0000"/>
                    <!-- 斗篷身体 -->
                    <rect x="27" y="16" width="6" height="18" fill="url(#rogueCloak)" rx="2"/>
                    <!-- 双匕首 -->
                    <rect x="20" y="20" width="1" height="6" fill="#8B4513"/>
                    <polygon points="20,18 22,20 22,22 20,20" fill="#C0C0C0" stroke="#999" stroke-width="0.3"/>
                    <rect x="39" y="22" width="1" height="6" fill="#8B4513"/>
                    <polygon points="39,20 41,22 41,24 39,22" fill="#C0C0C0" stroke="#999" stroke-width="0.3"/>
                    <!-- 手臂 -->
                    <line x1="30" y1="20" x2="21" y2="24" stroke="#ffd4a3" stroke-width="2" stroke-linecap="round"/>
                    <line x1="30" y1="20" x2="40" y2="26" stroke="#ffd4a3" stroke-width="2" stroke-linecap="round"/>
                    <!-- 暗影轨迹 -->
                    <path d="M 15 18 Q 25 15 35 25" stroke="#800080" stroke-width="1.5" fill="none" opacity="0.7" stroke-dasharray="2,2"/>
                    <!-- 腿部 -->
                    <line x1="30" y1="34" x2="26" y2="48" stroke="#2c2c2c" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="34" x2="34" y2="48" stroke="#2c2c2c" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'shield': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="shieldGlow" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#4ecdc4;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#44a08d;stop-opacity:0.2" />
                        </radialGradient>
                        <linearGradient id="shieldMetal" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#e6e6e6" />
                            <stop offset="50%" style="stop-color:#ffffff" />
                            <stop offset="100%" style="stop-color:#b3b3b3" />
                        </linearGradient>
                    </defs>
                    <!-- 防护光环 -->
                    <circle cx="30" cy="30" r="28" fill="url(#shieldGlow)" opacity="0.6"/>
                    <!-- 守护者头部 -->
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <!-- 坚毅表情 -->
                    <circle cx="28" cy="10" r="0.5" fill="#0066cc"/>
                    <circle cx="32" cy="10" r="0.5" fill="#0066cc"/>
                    <path d="M 27 14 Q 30 13 33 14" stroke="#654321" stroke-width="1" fill="none"/>
                    <!-- 重甲身体 -->
                    <rect x="26" y="17" width="8" height="18" fill="#C0C0C0" rx="2"/>
                    <rect x="27" y="18" width="6" height="3" fill="#FFD700" rx="1"/>
                    <!-- 大盾牌 -->
                    <path d="M 12 15 Q 8 25 12 40 Q 18 35 22 25 Q 18 15 12 15" fill="url(#shieldMetal)" stroke="#999" stroke-width="1"/>
                    <circle cx="17" cy="27" r="3" fill="#FFD700"/>
                    <path d="M 15 25 L 19 25 L 17 29 Z" fill="#ff6600"/>
                    <!-- 盾牌光效 -->
                    <circle cx="17" cy="27" r="8" fill="none" stroke="#4ecdc4" stroke-width="1" opacity="0.6" stroke-dasharray="3,3"/>
                    <!-- 手臂 -->
                    <line x1="30" y1="22" x2="22" y2="25" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="22" x2="38" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <!-- 腿部 -->
                    <line x1="30" y1="35" x2="26" y2="50" stroke="#C0C0C0" stroke-width="4" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="34" y2="50" stroke="#C0C0C0" stroke-width="4" stroke-linecap="round"/>
                </svg>`,
                'fireball': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="fireCore" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#ffff00" />
                            <stop offset="30%" style="stop-color:#ff6600" />
                            <stop offset="100%" style="stop-color:#cc0000" />
                        </radialGradient>
                    </defs>
                    <!-- 火焰背景 -->
                    <circle cx="30" cy="30" r="28" fill="#ff4400" opacity="0.3"/>
                    <!-- 法师头部 -->
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <!-- 法师帽 -->
                    <polygon points="25,7 35,7 32,2 28,2" fill="#4a0080" stroke="#330055" stroke-width="1"/>
                    <circle cx="30" cy="2" r="1" fill="#ffff00"/>
                    <!-- 专注表情 -->
                    <circle cx="28" cy="10" r="0.5" fill="#ff6600"/>
                    <circle cx="32" cy="10" r="0.5" fill="#ff6600"/>
                    <!-- 法袍 -->
                    <rect x="26" y="17" width="8" height="18" fill="#4a0080" rx="3"/>
                    <rect x="27" y="19" width="6" height="2" fill="#ffff00" rx="1"/>
                    <!-- 火球 -->
                    <circle cx="15" cy="22" r="6" fill="url(#fireCore)"/>
                    <circle cx="13" cy="20" r="3" fill="#ffff00" opacity="0.8"/>
                    <circle cx="17" cy="24" r="2" fill="#ffffff" opacity="0.6"/>
                    <!-- 火焰轨迹 -->
                    <path d="M 8 18 Q 5 22 8 26 Q 12 24 15 28 Q 18 22 22 26" stroke="#ff6600" stroke-width="2" fill="none" opacity="0.8"/>
                    <path d="M 6 20 Q 10 16 14 20 Q 18 24 22 20" stroke="#ffff00" stroke-width="1" fill="none" opacity="0.6"/>
                    <!-- 手臂施法姿态 -->
                    <line x1="30" y1="22" x2="21" y2="20" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="22" x2="38" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <!-- 腿部 -->
                    <line x1="30" y1="35" x2="26" y2="50" stroke="#4a0080" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="34" y2="50" stroke="#4a0080" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'lightning': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <linearGradient id="lightningGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff" />
                            <stop offset="50%" style="stop-color:#ffff00" />
                            <stop offset="100%" style="stop-color:#0066ff" />
                        </linearGradient>
                    </defs>
                    <!-- 雷电场 -->
                    <circle cx="30" cy="30" r="28" fill="#0066ff" opacity="0.2"/>
                    <!-- 法师头部 -->
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <!-- 雷电眼睛 -->
                    <circle cx="28" cy="10" r="0.5" fill="#00ffff"/>
                    <circle cx="32" cy="10" r="0.5" fill="#00ffff"/>
                    <!-- 法袍 -->
                    <rect x="26" y="17" width="8" height="18" fill="#000080" rx="3"/>
                    <!-- 闪电 -->
                    <path d="M 8 12 L 15 22 L 12 22 L 18 32 L 15 28 L 10 28 L 8 12 Z" fill="url(#lightningGrad)" stroke="#ffffff" stroke-width="0.5"/>
                    <!-- 电弧效果 -->
                    <path d="M 5 15 Q 12 10 20 18 Q 15 25 8 20" stroke="#00ffff" stroke-width="1.5" fill="none" opacity="0.8"/>
                    <path d="M 10 8 Q 18 12 25 8 Q 20 15 12 12" stroke="#ffff00" stroke-width="1" fill="none" opacity="0.6"/>
                    <!-- 手臂 -->
                    <line x1="30" y1="22" x2="18" y2="18" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="22" x2="38" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <!-- 腿部 -->
                    <line x1="30" y1="35" x2="26" y2="50" stroke="#000080" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="34" y2="50" stroke="#000080" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'stealth': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="shadowAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#800080;stop-opacity:0.6" />
                            <stop offset="100%" style="stop-color:#000000;stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <!-- 暗影领域 -->
                    <circle cx="30" cy="30" r="28" fill="url(#shadowAura)"/>
                    <!-- 半透明刺客 -->
                    <circle cx="30" cy="12" r="4" fill="#ffd4a3" stroke="#d4a574" stroke-width="1" opacity="0.4"/>
                    <rect x="27" y="16" width="6" height="18" fill="#2c2c2c" rx="2" opacity="0.4"/>
                    <!-- 暗影轮廓 -->
                    <circle cx="32" cy="14" r="5" fill="none" stroke="#800080" stroke-width="2" stroke-dasharray="3,3" opacity="0.8"/>
                    <rect x="29" y="18" width="6" height="18" fill="none" stroke="#800080" stroke-width="1.5" stroke-dasharray="2,2" rx="2" opacity="0.6"/>
                    <!-- 暗影手臂 -->
                    <line x1="30" y1="20" x2="20" y2="25" stroke="#800080" stroke-width="2" stroke-linecap="round" opacity="0.7" stroke-dasharray="4,2"/>
                    <line x1="30" y1="20" x2="40" y2="25" stroke="#800080" stroke-width="2" stroke-linecap="round" opacity="0.7" stroke-dasharray="4,2"/>
                    <!-- 暗影粒子 -->
                    <circle cx="15" cy="20" r="1" fill="#800080" opacity="0.8"/>
                    <circle cx="45" cy="25" r="1.5" fill="#4a0080" opacity="0.6"/>
                    <circle cx="20" cy="35" r="0.8" fill="#800080" opacity="0.9"/>
                    <circle cx="40" cy="40" r="1.2" fill="#4a0080" opacity="0.7"/>
                    <!-- 暗影腿部 -->
                    <line x1="30" y1="34" x2="26" y2="48" stroke="#800080" stroke-width="2" stroke-linecap="round" opacity="0.5" stroke-dasharray="3,3"/>
                    <line x1="30" y1="34" x2="34" y2="48" stroke="#800080" stroke-width="2" stroke-linecap="round" opacity="0.5" stroke-dasharray="3,3"/>
                </svg>`,
                'heal': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="healAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#00ff00;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#44ff44;stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <!-- 治疗光环 -->
                    <circle cx="30" cy="30" r="28" fill="url(#healAura)" opacity="0.7"/>
                    <!-- 牧师头部 -->
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <!-- 慈祥表情 -->
                    <circle cx="28" cy="10" r="0.5" fill="#00aa00"/>
                    <circle cx="32" cy="10" r="0.5" fill="#00aa00"/>
                    <path d="M 27 14 Q 30 15 33 14" stroke="#654321" stroke-width="1" fill="none"/>
                    <!-- 白袍 -->
                    <rect x="26" y="17" width="8" height="18" fill="#ffffff" rx="3" stroke="#e6e6e6" stroke-width="1"/>
                    <rect x="28" y="19" width="4" height="2" fill="#00ff00" rx="1"/>
                    <!-- 治疗十字 -->
                    <line x1="15" y1="20" x2="25" y2="20" stroke="#00ff00" stroke-width="3" stroke-linecap="round"/>
                    <line x1="20" y1="15" x2="20" y2="25" stroke="#00ff00" stroke-width="3" stroke-linecap="round"/>
                    <!-- 治疗光环效果 -->
                    <circle cx="20" cy="20" r="8" fill="none" stroke="#44ff44" stroke-width="1.5" opacity="0.8"/>
                    <circle cx="20" cy="20" r="12" fill="none" stroke="#88ff88" stroke-width="1" opacity="0.5"/>
                    <!-- 治疗粒子 -->
                    <circle cx="12" cy="15" r="1" fill="#00ff00" opacity="0.9"/>
                    <circle cx="28" cy="12" r="0.8" fill="#44ff44" opacity="0.7"/>
                    <circle cx="18" cy="28" r="1.2" fill="#00ff00" opacity="0.8"/>
                    <circle cx="25" cy="25" r="0.6" fill="#88ff88" opacity="0.6"/>
                    <!-- 手臂 -->
                    <line x1="30" y1="22" x2="20" y2="18" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="22" x2="38" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <!-- 腿部 -->
                    <line x1="30" y1="35" x2="26" y2="50" stroke="#ffffff" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="34" y2="50" stroke="#ffffff" stroke-width="3" stroke-linecap="round"/>
                </svg>`
            };
            
            // 添加更多卡牌原画类型
            const additionalArt = {
                'berserker': artMap['charge'],
                'dual-slash': artMap['sword-strike'],
                'execute': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="executeAura" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#ff0000;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8b0000;stop-opacity:0.3" />
                        </radialGradient>
                    </defs>
                    <circle cx="30" cy="30" r="28" fill="url(#executeAura)" opacity="0.8"/>
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <circle cx="28" cy="10" r="0.5" fill="#8b0000"/>
                    <circle cx="32" cy="10" r="0.5" fill="#8b0000"/>
                    <rect x="26" y="17" width="8" height="18" fill="#8B4513" rx="2"/>
                    <rect x="12" y="15" width="3" height="15" fill="#8B4513"/>
                    <polygon points="12,10 18,15 18,18 12,15" fill="#ff0000" stroke="#8b0000" stroke-width="1"/>
                    <line x1="30" y1="22" x2="15" y2="18" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="22" x2="38" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <path d="M 8 12 Q 15 8 22 15" stroke="#ff0000" stroke-width="3" fill="none" opacity="0.8"/>
                    <line x1="30" y1="35" x2="26" y2="50" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="34" y2="50" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'combo': artMap['dagger'],
                'poison-blade': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <circle cx="30" cy="30" r="25" fill="#9b59b6" opacity="0.3"/>
                    <circle cx="30" cy="12" r="4" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <rect x="27" y="16" width="6" height="18" fill="#2c2c2c" rx="2"/>
                    <rect x="18" y="20" width="1" height="8" fill="#8B4513"/>
                    <polygon points="18,18 20,20 20,22 18,20" fill="#9b59b6" stroke="#8e44ad" stroke-width="0.5"/>
                    <line x1="30" y1="20" x2="19" y2="22" stroke="#ffd4a3" stroke-width="2" stroke-linecap="round"/>
                    <line x1="30" y1="20" x2="38" y2="26" stroke="#ffd4a3" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="15" cy="18" r="1" fill="#9b59b6" opacity="0.8"/>
                    <circle cx="12" cy="22" r="0.8" fill="#8e44ad" opacity="0.6"/>
                    <circle cx="20" cy="15" r="1.2" fill="#9b59b6" opacity="0.7"/>
                    <line x1="30" y1="34" x2="26" y2="48" stroke="#2c2c2c" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="34" x2="34" y2="48" stroke="#2c2c2c" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'critical': artMap['execute'],
                'pierce': artMap['dagger'],
                'toughness': artMap['shield'],
                'parry': artMap['shield'],
                'counter': artMap['shield'],
                'iron-will': artMap['shield'],
                'perfect-defense': artMap['shield'],
                'dodge': artMap['stealth'],
                'clone': artMap['stealth'],
                'magic-missile': artMap['lightning'],
                'magic-shield': artMap['shield'],
                'focus': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="focusAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#00bcd4;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#0097a7;stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <circle cx="30" cy="30" r="28" fill="url(#focusAura)" opacity="0.7"/>
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <circle cx="28" cy="10" r="0.5" fill="#00bcd4"/>
                    <circle cx="32" cy="10" r="0.5" fill="#00bcd4"/>
                    <rect x="26" y="17" width="8" height="18" fill="#4a0080" rx="3"/>
                    <circle cx="30" cy="25" r="6" fill="none" stroke="#00bcd4" stroke-width="2"/>
                    <circle cx="30" cy="25" r="3" fill="#00bcd4" opacity="0.6"/>
                    <circle cx="30" cy="25" r="1" fill="#ffffff"/>
                    <line x1="30" y1="22" x2="20" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="22" x2="40" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="26" y2="50" stroke="#4a0080" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="34" y2="50" stroke="#4a0080" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'freeze-ray': artMap['lightning'],
                'mana-drain': artMap['focus'],
                'teleport': artMap['stealth'],
                'elemental-burst': artMap['fireball'],
                'time-warp': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="timeAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#9c27b0;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#673ab7;stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <circle cx="30" cy="30" r="28" fill="url(#timeAura)" opacity="0.7"/>
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <circle cx="28" cy="10" r="0.5" fill="#9c27b0"/>
                    <circle cx="32" cy="10" r="0.5" fill="#9c27b0"/>
                    <rect x="26" y="17" width="8" height="18" fill="#4a0080" rx="3"/>
                    <circle cx="20" cy="25" r="8" fill="none" stroke="#9c27b0" stroke-width="2"/>
                    <line x1="20" y1="17" x2="20" y2="21" stroke="#9c27b0" stroke-width="2"/>
                    <line x1="28" y1="25" x2="24" y2="25" stroke="#9c27b0" stroke-width="2"/>
                    <line x1="20" y1="29" x2="20" y2="33" stroke="#9c27b0" stroke-width="2"/>
                    <line x1="12" y1="25" x2="16" y2="25" stroke="#9c27b0" stroke-width="2"/>
                    <path d="M 15 20 Q 25 15 35 25" stroke="#9c27b0" stroke-width="1.5" fill="none" opacity="0.7" stroke-dasharray="3,3"/>
                    <line x1="30" y1="22" x2="20" y2="20" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="22" x2="38" y2="28" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="26" y2="50" stroke="#4a0080" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="35" x2="34" y2="50" stroke="#4a0080" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'vampiric': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <circle cx="30" cy="30" r="25" fill="#8b0000" opacity="0.4"/>
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <circle cx="28" cy="10" r="0.5" fill="#ff0000"/>
                    <circle cx="32" cy="10" r="0.5" fill="#ff0000"/>
                    <rect x="26" y="17" width="8" height="18" fill="#2c2c2c" rx="2"/>
                    <rect x="18" y="20" width="2" height="8" fill="#8B4513"/>
                    <polygon points="18,18 22,20 22,22 18,20" fill="#8b0000" stroke="#660000" stroke-width="0.5"/>
                    <path d="M 10 15 Q 20 10 30 20" stroke="#ff0000" stroke-width="2" fill="none" opacity="0.8"/>
                    <circle cx="15" cy="18" r="1.5" fill="#ff0000" opacity="0.9"/>
                    <circle cx="25" cy="15" r="1" fill="#cc0000" opacity="0.7"/>
                    <line x1="30" y1="20" x2="20" y2="22" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="20" x2="38" y2="26" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="34" x2="26" y2="48" stroke="#2c2c2c" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="34" x2="34" y2="48" stroke="#2c2c2c" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'rage': artMap['berserker'],
                'purify': artMap['heal'],
                'lucky-coin': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <defs>
                        <radialGradient id="luckAura" cx="50%" cy="50%" r="60%">
                            <stop offset="0%" style="stop-color:#ffd700;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#ffb347;stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <circle cx="30" cy="30" r="28" fill="url(#luckAura)" opacity="0.7"/>
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1"/>
                    <circle cx="28" cy="10" r="0.5" fill="#ffd700"/>
                    <circle cx="32" cy="10" r="0.5" fill="#ffd700"/>
                    <rect x="26" y="17" width="8" height="18" fill="#8B4513" rx="2"/>
                    <circle cx="18" cy="22" r="5" fill="#ffd700" stroke="#ffb347" stroke-width="1"/>
                    <text x="18" y="25" text-anchor="middle" font-size="6" fill="#8B4513">$</text>
                    <path d="M 12 18 Q 18 12 24 18" stroke="#ffd700" stroke-width="1.5" fill="none" opacity="0.8"/>
                    <circle cx="10" cy="15" r="0.8" fill="#ffd700" opacity="0.9"/>
                    <circle cx="26" cy="15" r="1" fill="#ffb347" opacity="0.7"/>
                    <circle cx="15" cy="28" r="0.6" fill="#ffd700" opacity="0.8"/>
                    <line x1="30" y1="20" x2="23" y2="20" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="20" x2="38" y2="26" stroke="#ffd4a3" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="34" x2="26" y2="48" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                    <line x1="30" y1="34" x2="34" y2="48" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
                'rebirth': artMap['heal'],
                'weakness-curse': `<svg class="stickman-art" viewBox="0 0 60 60">
                    <circle cx="30" cy="30" r="28" fill="#8b0000" opacity="0.5"/>
                    <circle cx="30" cy="12" r="5" fill="#ffd4a3" stroke="#d4a574" stroke-width="1" opacity="0.7"/>
                    <circle cx="28" cy="10" r="0.5" fill="#8b0000"/>
                    <circle cx="32" cy="10" r="0.5" fill="#8b0000"/>
                    <path d="M 27 14 Q 30 16 33 14" stroke="#8b0000" stroke-width="1" fill="none"/>
                    <rect x="26" y="17" width="8" height="18" fill="#654321" rx="2" opacity="0.8"/>
                    <path d="M 15 15 Q 30 10 45 15 Q 30 20 15 15" stroke="#ff0000" stroke-width="2" fill="none" opacity="0.8"/>
                    <circle cx="20" cy="20" r="2" fill="#8b0000" opacity="0.6"/>
                    <circle cx="40" cy="25" r="1.5" fill="#660000" opacity="0.7"/>
                    <circle cx="25" cy="30" r="1" fill="#8b0000" opacity="0.8"/>
                    <line x1="30" y1="22" x2="20" y2="28" stroke="#ffd4a3" stroke-width="2" stroke-linecap="round" opacity="0.7"/>
                    <line x1="30" y1="22" x2="40" y2="28" stroke="#ffd4a3" stroke-width="2" stroke-linecap="round" opacity="0.7"/>
                    <line x1="30" y1="35" x2="26" y2="50" stroke="#654321" stroke-width="3" stroke-linecap="round" opacity="0.8"/>
                    <line x1="30" y1="35" x2="34" y2="50" stroke="#654321" stroke-width="3" stroke-linecap="round" opacity="0.8"/>
                </svg>`,
                'fatigue': artMap['weakness-curse'],
                'pain': artMap['weakness-curse']
            };
            
            // 合并所有原画
            const allArt = { ...artMap, ...additionalArt };
            
            return allArt[artType] || allArt['sword-strike'];
        }

        // 统一的卡牌添加函数，包含数量限制检查
        function safeAddCardToDeck(cardName, showAlert = true) {
            // 检查牌组是否已满
            if (gameState.playerDeck.length >= 20) {
                return false;
            }
            
            // 获取卡牌信息
            const card = cardDatabase[cardName];
            if (!card) return false;
            
            // 检查同名卡牌数量限制
            const sameCardCount = gameState.playerDeck.filter(c => c === cardName).length;
            if (sameCardCount >= 3) {
                if (showAlert) {
                    alert(`最多只能选择3张「${cardName}」加入牌库！`);
                }
                return false;
            }
            
            // 添加卡牌
            gameState.playerDeck.push(cardName);
            return true;
        }
        
        // 添加卡牌到牌组
        function addCardToDeck(cardName) {
            if (safeAddCardToDeck(cardName)) {
                updateDeckDisplay();
                updateUI();
            }
            
            // 获取卡牌信息
            const card = cardDatabase[cardName];
            if (!card) return; // 如果卡牌不存在，直接返回
            
            // 检查是否是非本角色或非通用的其他职业卡牌
            const isOtherClassCard = card.character !== gameState.selectedCharacter && 
                                     card.character !== 'neutral';
            
            if (isOtherClassCard) {
                // 计算当前牌库中其他职业卡牌的数量
                const otherClassCardsCount = gameState.playerDeck.filter(cardNameInDeck => {
                    const cardInDeck = cardDatabase[cardNameInDeck];
                    return cardInDeck && 
                           cardInDeck.character !== gameState.selectedCharacter && 
                           cardInDeck.character !== 'neutral';
                }).length;
                
                // 如果已经有3张或更多其他职业卡牌，则不添加
                if (otherClassCardsCount >= 3) {
                    alert('最多只能选择3张非本角色或非通用的其他职业卡牌加入牌库！');
                    return;
                }
            }
            
            // 添加卡牌
            gameState.playerDeck.push(cardName);
            updateDeckDisplay();
            updateUI();
        }

        // 从牌组移除卡牌
        function removeCardFromDeck(index) {
            // 确保移除卡牌后牌组数量不会少于8张
            if (gameState.playerDeck.length <= 8) {
                alert('牌组不能少于8张卡牌！');
                return;
            }
            
            gameState.playerDeck.splice(index, 1);
            updateDeckDisplay();
            updateUI();
        }

        // 触发随机事件
        function triggerRandomEvent() {
            if (Math.random() < 0.7) { // 70%几率触发事件
                const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                showRandomEvent(event);
            } else {
                gameState.battleLog = gameState.battleLog || [];
                gameState.battleLog.push('你探索了一番，但什么也没发现...');
            }
        }

        // 显示随机事件
        function showRandomEvent(event) {
            document.getElementById('eventTitle').textContent = event.name;
            document.getElementById('eventDescription').textContent = event.description;
            
            const choicesContainer = document.getElementById('eventChoices');
            choicesContainer.innerHTML = '';
            
            event.choices.forEach(choice => {
                const choiceBtn = document.createElement('button');
                choiceBtn.className = 'btn';
                choiceBtn.textContent = choice.text;
                choiceBtn.style.margin = '10px';
                choiceBtn.style.display = 'block';
                choiceBtn.style.width = '300px';
                choiceBtn.style.marginLeft = 'auto';
                choiceBtn.style.marginRight = 'auto';
                
                if (choice.cost > 0 && gameState.gold < choice.cost) {
                    choiceBtn.disabled = true;
                    choiceBtn.style.opacity = '0.5';
                }
                
                choiceBtn.addEventListener('click', () => {
                    executeEventChoice(choice);
                    showScreen('deckScreen');
                });
                
                choicesContainer.appendChild(choiceBtn);
            });
            
            showScreen('eventScreen');
        }

        // 执行事件选择
        function executeEventChoice(choice) {
            if (choice.cost > 0) {
                gameState.gold -= choice.cost;
            }
            
            switch(choice.effect) {
                case 'rare_card':
                    const rareCards = Object.keys(cardDatabase).filter(name => 
                        cardDatabase[name].rarity === 'rare' && cardDatabase[name].type !== 'curse' && cardDatabase[name].rarity !== 'legendary'
                    );
                    let randomRare;
                    let attempts = 0;
                    const maxAttempts = 10;
                    
                    // 尝试找到一张可以添加的稀有卡牌（不超过3张限制）
                    do {
                        randomRare = rareCards[Math.floor(Math.random() * rareCards.length)];
                        attempts++;
                    } while (!safeAddCardToDeck(randomRare, false) && attempts < maxAttempts);
                    
                    if (attempts < maxAttempts) {
                        gameState.battleLog = gameState.battleLog || [];
                        gameState.battleLog.push(`获得了稀有卡牌: ${randomRare}！`);
                    } else {
                        gameState.battleLog = gameState.battleLog || [];
                        gameState.battleLog.push('牌库中无法添加更多卡牌！');
                    }
                    break;
                    
                case 'relic':
                    const availableRelics = [
                        '吸血鬼之牙', '荆棘护符', '幸运硬币', '战士之魂',
                        '法师之戒', '盗贼面具', '龙鳞护甲', '时间沙漏'
                    ];
                    const randomRelic = availableRelics[Math.floor(Math.random() * availableRelics.length)];
                    gameState.relics = gameState.relics || [];
                    if (!gameState.relics.includes(randomRelic)) {
                        gameState.relics.push(randomRelic);
                        gameState.battleLog.push(`获得了神器: ${randomRelic}！`);
                    } else {
                        gameState.gold += 25; // 如果已有该神器，给予金币补偿
                        gameState.battleLog.push('已拥有该神器，获得25金币补偿！');
                    }
                    break;
                    
                case 'sacrifice_hp':
                    gameState.playerHp -= choice.cost;
                    let strengthBuff = gameState.buffs.find(b => b.name === '力量');
                    if (strengthBuff) strengthBuff.stacks += 3;
                    else gameState.buffs.push({ name: '力量', stacks: 3, type: 'power' });
                    gameState.battleLog.push('献祭生命值，获得了强大的力量！');
                    break;
                    
                case 'purify':
                    const curseCards = gameState.playerDeck.filter(card => cardDatabase[card].type === 'curse');
                    curseCards.forEach(curse => {
                        const index = gameState.playerDeck.indexOf(curse);
                        gameState.playerDeck.splice(index, 1);
                    });
                    gameState.battleLog.push(`净化了 ${curseCards.length} 张诅咒卡牌！`);
                    break;
                    
                case 'full_heal':
                    gameState.playerHp = gameState.playerMaxHp;
                    gameState.battleLog.push('完全恢复了生命值！');
                    break;
                    
                case 'heal_potion':
                    if (safeAddCardToDeck('治疗药水', false)) {
                        gameState.battleLog.push('获得了治疗药水卡牌！');
                    } else {
                        gameState.battleLog.push('牌库中已拥有3张治疗药水！');
                    }
                    break;
                    
                case 'magic_card':
                    const magicCards = Object.keys(cardDatabase).filter(name => 
                        cardDatabase[name].type === 'magic' && cardDatabase[name].rarity !== 'curse'
                    );
                    let randomMagic;
                    let magicAttempts = 0;
                    
                    // 尝试找到一张可以添加的法术卡牌
                    do {
                        randomMagic = magicCards[Math.floor(Math.random() * magicCards.length)];
                        magicAttempts++;
                    } while (!safeAddCardToDeck(randomMagic, false) && magicAttempts < 10);
                    
                    if (magicAttempts < 10) {
                        gameState.battleLog.push(`学会了法术: ${randomMagic}！`);
                    } else {
                        gameState.battleLog.push('牌库中无法添加更多卡牌！');
                    }
                    break;
                    
                case 'upgrade_card':
                    // 随机强化一张可强化的卡牌
                    const upgradableCards = gameState.playerDeck.filter(card => cardUpgrades[card]);
                    if (upgradableCards.length > 0) {
                        const cardToUpgrade = upgradableCards[Math.floor(Math.random() * upgradableCards.length)];
                        const index = gameState.playerDeck.indexOf(cardToUpgrade);
                        gameState.playerDeck[index] = cardUpgrades[cardToUpgrade].name;
                        gameState.battleLog.push(`${cardToUpgrade} 被强化为 ${cardUpgrades[cardToUpgrade].name}！`);
                    } else {
                        gameState.gold += 15; // 退还金币
                        gameState.battleLog.push('没有可强化的卡牌，退还金币！');
                    }
                    break;
                    
                case 'cursed_treasure':
                    const treasureRares = Object.keys(cardDatabase).filter(name => 
                        cardDatabase[name].rarity === 'rare' && cardDatabase[name].type !== 'curse' && cardDatabase[name].rarity !== 'legendary'
                    );
                    const curses = Object.keys(cardDatabase).filter(name => 
                        cardDatabase[name].type === 'curse'
                    );
                    // 选择宝藏卡牌
                    let treasureCard;
                    let treasureAttempts = 0;
                    do {
                        treasureCard = treasureRares[Math.floor(Math.random() * treasureRares.length)];
                        treasureAttempts++;
                    } while (!safeAddCardToDeck(treasureCard, false) && treasureAttempts < 10);
                    
                    // 选择诅咒卡牌
                    const curseCard = curses[Math.floor(Math.random() * curses.length)];
                    gameState.playerDeck.push(curseCard); // 诅咒卡牌不限制数量
                    
                    if (treasureAttempts < 10) {
                        gameState.battleLog.push(`获得了稀有卡牌 ${treasureCard}，但也被诅咒了 ${curseCard}！`);
                    } else {
                        gameState.battleLog.push(`被诅咒了 ${curseCard}，但无法添加更多卡牌到牌库！`);
                    }
                    break;
                    
                case 'purified_treasure':
                    const purifiedRares = Object.keys(cardDatabase).filter(name => 
                        cardDatabase[name].rarity === 'rare' && cardDatabase[name].type !== 'curse' && cardDatabase[name].rarity !== 'legendary'
                    );
                    let purifiedCard;
                    let purifiedAttempts = 0;
                    do {
                        purifiedCard = purifiedRares[Math.floor(Math.random() * purifiedRares.length)];
                        purifiedAttempts++;
                    } while (!safeAddCardToDeck(purifiedCard, false) && purifiedAttempts < 10);
                    
                    if (purifiedAttempts < 10) {
                        gameState.battleLog.push(`净化宝箱后获得了稀有卡牌: ${purifiedCard}！`);
                    } else {
                        gameState.battleLog.push('净化宝箱后发现牌库中无法添加更多卡牌！');
                    }
                    break;
                    
                case 'nothing':
                    gameState.battleLog.push('你选择了离开...');
                    break;
            }
            
            updateDeckDisplay();
            updateUI();
        }

        // 打开强化界面
        function openUpgradeScreen() {
            if (gameState.gold < 25) {
                gameState.battleLog = gameState.battleLog || [];
                gameState.battleLog.push('金币不足！需要25金币进行强化。');
                return;
            }
            
            const upgradableCards = gameState.playerDeck.filter(card => cardUpgrades[card]);
            if (upgradableCards.length === 0) {
                gameState.battleLog = gameState.battleLog || [];
                gameState.battleLog.push('没有可强化的卡牌！');
                return;
            }
            
            const upgradeContainer = document.getElementById('upgradeCards');
            upgradeContainer.innerHTML = '';
            
            // 去重并显示可强化的卡牌
            const uniqueCards = [...new Set(upgradableCards)];
            uniqueCards.forEach(cardName => {
                const cardElement = createCardElement(cardName, () => {
                    upgradeCard(cardName);
                });
                upgradeContainer.appendChild(cardElement);
            });
            
            showScreen('upgradeScreen');
        }

        // 强化卡牌
        function upgradeCard(cardName) {
            if (gameState.gold < 25) {
                gameState.battleLog = gameState.battleLog || [];
                gameState.battleLog.push('金币不足！');
                return;
            }
            
            const upgrade = cardUpgrades[cardName];
            if (!upgrade) {
                gameState.battleLog = gameState.battleLog || [];
                gameState.battleLog.push('该卡牌无法强化！');
                return;
            }
            
            gameState.gold -= 25;
            const index = gameState.playerDeck.indexOf(cardName);
            if (index !== -1) {
                gameState.playerDeck[index] = upgrade.name;
                
                // 更新卡牌数据库以包含强化版本
                cardDatabase[upgrade.name] = {
                    ...cardDatabase[cardName],
                    ...upgrade,
                    rarity: cardDatabase[cardName].rarity
                };
                
                gameState.battleLog = gameState.battleLog || [];
                gameState.battleLog.push(`${cardName} 强化为 ${upgrade.name}！`);
                updateDeckDisplay();
                updateUI();
                showScreen('deckScreen');
            }
        }

        // 商店
        function openShop() {
            // 根据稀有度生成卡牌和定价（排除传奇卡牌）
            const rarityWeights = {
                'common': 60,
                'uncommon': 25,
                'rare': 10,
                'curse': 5
            };
            
            const rarityPrices = {
                'common': 8,
                'uncommon': 15,
                'rare': 25,
                'curse': 3  // 诅咒卡便宜但有负面效果
            };
            
            // 随机选择稀有度
            const totalWeight = Object.values(rarityWeights).reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            let selectedRarity = 'common';
            
            for (const [rarity, weight] of Object.entries(rarityWeights)) {
                random -= weight;
                if (random <= 0) {
                    selectedRarity = rarity;
                    break;
                }
            }
            
            // 获取该稀有度的卡牌（排除传奇卡牌）
            const availableCards = Object.keys(cardDatabase).filter(name => 
                cardDatabase[name].rarity === selectedRarity && cardDatabase[name].rarity !== 'legendary'
            );
            
            if (availableCards.length === 0) {
                gameState.battleLog = gameState.battleLog || [];
                gameState.battleLog.push('商店暂时没有商品！');
                return;
            }
            
            const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
            const price = rarityPrices[selectedRarity];
            
            if (gameState.gold >= price) {
                // 检查是否可以添加卡牌
                if (safeAddCardToDeck(randomCard, false)) {
                    gameState.gold -= price;
                    const rarityText = {
                        'common': '普通',
                        'uncommon': '罕见', 
                        'rare': '稀有',
                        'curse': '诅咒'
                    };
                    gameState.battleLog = gameState.battleLog || [];
                    gameState.battleLog.push(`花费${price}金币获得了${rarityText[selectedRarity]}卡牌: ${randomCard}！`);
                    updateDeckDisplay();
                    updateUI();
                } else {
                    gameState.battleLog = gameState.battleLog || [];
                    gameState.battleLog.push(`牌库中已拥有3张${randomCard}，无法再次购买！`);
                }
            } else {
                gameState.battleLog = gameState.battleLog || [];
                gameState.battleLog.push(`金币不足！需要${price}金币。`);
            }
        }

        // 进入战斗
        function enterBattle() {
            if (gameState.playerDeck.length < 8) {
                alert('牌组至少需要8张卡牌！');
                return;
            }
            
            // 记录战斗开始时的生命值用于成就检查
            gameState.battleStartHp = gameState.playerHp;
            gameState.cardsPlayedThisTurn = 0;
            
            // 检查是否为BOSS关卡
            const isBossLevel = bosses[gameState.level];
            
            if (isBossLevel) {
                // 生成BOSS，根据难度倍数调整属性
                const boss = bosses[gameState.level];
                const difficultyMultiplier = gameState.difficultyMultiplier || 1;
                gameState.currentEnemy = {
                    ...boss,
                    maxHp: Math.floor(boss.maxHp * difficultyMultiplier),
                    hp: Math.floor(boss.maxHp * difficultyMultiplier),
                    attack: Math.floor(boss.attack * difficultyMultiplier),
                    currentPhase: 0,
                    currentIntent: 'special',
                    turnCount: 0,
                    isBoss: true,
                    phaseTransitioned: false
                };
                addLog(`⚠️ 守关BOSS出现：${boss.name}！`);
                addLog(`当前阶段：${boss.phases[0].name} - ${boss.phases[0].description}`);
            } else {
                // 生成普通敌人
                const enemyIndex = Math.min(gameState.level - 1, enemies.length - 1);
                const baseEnemy = enemies[enemyIndex];
                
                // 根据关卡和难度调整敌人属性（使用非线性增长以增加后期难度）
                const difficultyMultiplier = gameState.difficultyMultiplier || 1;
                // 使用二次函数增长，使后期关卡难度显著提高
                const hpScaling = Math.floor((gameState.level - 1) * (3 + (gameState.level - 1) * 0.2) * difficultyMultiplier);
                const attackScaling = Math.floor((gameState.level - 1) * (1.2 + (gameState.level - 1) * 0.1) * difficultyMultiplier);
                
                gameState.currentEnemy = {
                    ...baseEnemy,
                    maxHp: Math.floor((baseEnemy.hp + hpScaling) * difficultyMultiplier),
                    hp: Math.floor((baseEnemy.hp + hpScaling) * difficultyMultiplier),
                    attack: Math.floor((baseEnemy.attack + attackScaling) * difficultyMultiplier),
                    currentIntent: baseEnemy.intent,
                    turnCount: 0,
                    isBoss: false
                };
            }
            
            // 初始化牌库系统
            gameState.drawPile = [...gameState.playerDeck];
            gameState.discardPile = [];
            gameState.exhaustedCards = []; // 记录被移除的卡牌
            
            // 洗牌
            for (let i = gameState.drawPile.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gameState.drawPile[i], gameState.drawPile[j]] = [gameState.drawPile[j], gameState.drawPile[i]];
            }
            
            // 重置战斗状态
            gameState.energy = gameState.maxEnergy;
            gameState.hand = [];
            gameState.battleLog = [];
            gameState.playerBlock = 0;
            gameState.enemyPoison = 0;
            gameState.stealthTurns = 0;
            gameState.cardsPlayedThisTurn = 0;
            gameState.enemyMarked = false; // 重置猎人标记状态
            gameState.precisionStacks = 0; // 重置精准层数（鹰眼效果）
            
            // 抽初始手牌
            drawCards(5 + (gameState.selectedCharacter === 'rogue' ? 1 : 0));
            
            showScreen('battleScreen');
            updateBattleUI();
        }

        // 抽卡
        function drawCards(count) {
            // 如果是回合开始时的抽牌，添加牌库信息到UI
            if (!document.getElementById('drawPileInfo')) {
                const battleArea = document.querySelector('.battle-area');
                const playerStatus = document.querySelector('.player-status');
                const drawPileInfo = document.createElement('div');
                drawPileInfo.id = 'drawPileInfo';
                drawPileInfo.style.position = 'absolute';
                drawPileInfo.style.top = '20px';
                drawPileInfo.style.left = '20px';
                drawPileInfo.style.background = 'rgba(0,0,0,0.7)';
                drawPileInfo.style.padding = '8px 12px';
                drawPileInfo.style.borderRadius = '8px';
                drawPileInfo.style.color = 'white';
                drawPileInfo.style.fontSize = '0.8rem';
                drawPileInfo.style.zIndex = '100';
                battleArea.insertBefore(drawPileInfo, battleArea.firstChild);
            }
            
            // 立即更新牌库信息
            document.getElementById('drawPileInfo').textContent = `🃏 牌库: ${gameState.drawPile.length}张 | 弃牌堆: ${gameState.discardPile.length}张`;
            
            // 使用定时器创建卡牌逐一出现的效果
            let delay = 0;
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    // 如果牌库为空，重置牌库
                    if (gameState.drawPile.length === 0) {
                        if (gameState.discardPile.length > 0) {
                            // 将弃牌堆洗入牌库
                            gameState.drawPile = [...gameState.discardPile];
                            gameState.discardPile = [];
                            // 洗牌
                            for (let j = gameState.drawPile.length - 1; j > 0; j--) {
                                const k = Math.floor(Math.random() * (j + 1));
                                [gameState.drawPile[j], gameState.drawPile[k]] = [gameState.drawPile[k], gameState.drawPile[j]];
                            }
                            addLog('牌库已重置并洗牌！');
                        } else {
                            // 如果弃牌堆也为空，说明所有卡牌都在手中或被移除，停止抽牌
                            addLog('没有更多卡牌可抽！');
                            return;
                        }
                    }
                    
                    if (gameState.drawPile.length > 0) {
                        const cardName = gameState.drawPile.shift(); // 从牌库顶部抽牌
                        gameState.hand.push(cardName);
                        
                        // 创建抽牌动画效果
                        const handContainer = document.getElementById('hand');
                        handContainer.innerHTML = '';
                        
                        gameState.hand.forEach((cardName, index) => {
                            const cardElement = createCardElement(cardName, () => playCard(index));
                            const card = cardDatabase[cardName];
                            if (gameState.energy < card.cost) {
                                cardElement.style.opacity = '0.5';
                                cardElement.style.cursor = 'not-allowed';
                            }
                            
                            // 为新抽到的卡牌添加动画
                            if (index === gameState.hand.length - 1) {
                                cardElement.style.animation = 'fadeIn 0.5s ease-out forwards';
                                cardElement.style.opacity = '0';
                                cardElement.style.transform = 'translateY(20px)';
                            }
                            
                            handContainer.appendChild(cardElement);
                        });
                        
                        // 更新牌库信息
                        document.getElementById('drawPileInfo').textContent = `🃏 牌库: ${gameState.drawPile.length}张 | 弃牌堆: ${gameState.discardPile.length}张`;
                    }
                }, delay);
                
                // 每张牌之间间隔150毫秒
                delay += 150;
            }
        }

        // 更新战斗UI
        function updateBattleUI() {
            const enemy = gameState.currentEnemy;
            const enemyElement = document.querySelector('.enemy');
            
            // 添加BOSS样式
            if (enemy.isBoss) {
                enemyElement.classList.add('boss');
            } else {
                enemyElement.classList.remove('boss');
            }
            
            document.getElementById('enemyArt').innerHTML = createEnemyArt(enemy.name);
            document.getElementById('enemyName').textContent = enemy.name;
            document.getElementById('enemyHp').textContent = enemy.hp;
            document.getElementById('enemyMaxHp').textContent = enemy.maxHp;
            document.getElementById('enemyHealth').style.width = `${(enemy.hp / enemy.maxHp) * 100}%`;
            
            // 显示BOSS阶段信息
            if (enemy.isBoss && enemy.phases) {
                const currentPhase = enemy.phases[enemy.currentPhase];
                let phaseDisplay = document.getElementById('bossPhaseDisplay');
                if (!phaseDisplay) {
                    phaseDisplay = document.createElement('div');
                    phaseDisplay.id = 'bossPhaseDisplay';
                    phaseDisplay.className = 'boss-phase';
                    document.querySelector('.enemy-display').appendChild(phaseDisplay);
                }
                phaseDisplay.textContent = `${currentPhase.name} (${enemy.currentPhase + 1}/${enemy.phases.length})`;
            } else {
                const phaseDisplay = document.getElementById('bossPhaseDisplay');
                if (phaseDisplay) {
                    phaseDisplay.remove();
                }
            }
            
            // 更新敌人意图显示
            updateEnemyIntent(enemy);
            
            document.getElementById('playerHp').textContent = gameState.playerHp;
            document.getElementById('playerMaxHp').textContent = gameState.playerMaxHp;
            document.getElementById('playerHealth').style.width = `${(gameState.playerHp / gameState.playerMaxHp) * 100}%`;
            
            document.getElementById('energy').textContent = gameState.energy;
            
            updateHandDisplay();
            updateStatusEffectsDisplay();
            updateBattleLog();
        }
        
        // 更新敌人意图
        function updateEnemyIntent(enemy) {
            const intentIcon = document.getElementById('intentIcon');
            const intentText = document.getElementById('intentText');
            
            if (!enemy.currentIntent) {
                enemy.currentIntent = predictEnemyIntent(enemy);
            }
            
            const intentData = {
                'attack': { icon: '⚔️', color: '#ff4444' },
                'defend': { icon: '🛡️', color: '#4444ff' },
                'buff': { icon: '💪', color: '#44ff44' },
                'debuff': { icon: '💀', color: '#8844ff' },
                'heal': { icon: '❤️', color: '#44ff44' },
                'special': { icon: '✨', color: '#ffaa44' },
                'stealth': { icon: '👤', color: '#666666' }
            };
            
            const intent = intentData[enemy.currentIntent] || intentData['attack'];
            intentIcon.textContent = intent.icon;
            intentIcon.style.color = intent.color;
            
            let intentDescription = '';
            switch(enemy.currentIntent) {
                case 'attack':
                    const damage = enemy.attack + Math.floor((gameState.level - 1) * 1.2);
                    intentDescription = `准备攻击 (${damage}伤害)`;
                    break;
                case 'defend':
                    intentDescription = '准备防御';
                    break;
                case 'buff':
                    intentDescription = '准备强化自身';
                    break;
                case 'debuff':
                    intentDescription = '准备施加负面效果';
                    break;
                case 'heal':
                    intentDescription = '准备治疗';
                    break;
                case 'special':
                    intentDescription = '准备使用特殊能力';
                    break;
                case 'stealth':
                    intentDescription = '准备潜行';
                    break;
            }
            
            intentText.textContent = intentDescription;
        }
        
        // 预测敌人意图
        function predictEnemyIntent(enemy) {
            // 根据敌人类型和状态预测下回合行动
            // 添加安全检查确保abilities存在
            const abilities = enemy.abilities || [];
            
            if (abilities.includes('stealth') && Math.random() < 0.3) {
                return 'stealth';
            }
            
            if (abilities.includes('heal') && enemy.hp < enemy.maxHp * 0.3 && Math.random() < 0.4) {
                return 'heal';
            }
            
            if (abilities.includes('rage') && enemy.hp < enemy.maxHp * 0.5 && Math.random() < 0.3) {
                return 'buff';
            }
            
            if (abilities.includes('poison') && Math.random() < 0.25) {
                return 'debuff';
            }
            
            if (abilities.includes('armor') && Math.random() < 0.2) {
                return 'defend';
            }
            
            if (abilities.includes('summon_minions') && Math.random() < 0.2) {
                return 'special';
            }
            
            // 默认攻击
            return 'attack';
        }
        
        // 更新状态效果显示
        function updateStatusEffectsDisplay() {
            const playerEffectsContainer = document.getElementById('playerStatusEffects');
            const enemyEffectsContainer = document.getElementById('enemyStatusEffects');
            
            // 清空现有显示
            playerEffectsContainer.innerHTML = '';
            enemyEffectsContainer.innerHTML = '';
            
            // 玩家状态效果
            const playerEffects = [];
            
            if (gameState.playerBlock > 0) {
                playerEffects.push({ name: '护盾', value: gameState.playerBlock, color: '#4ecdc4', icon: '🛡️' });
            }
            
            if (gameState.stealthTurns > 0) {
                playerEffects.push({ name: '潜行', value: gameState.stealthTurns, color: '#666666', icon: '👤' });
            }
            
            if (gameState.playerThorns > 0) {
                playerEffects.push({ name: '荆棘', value: gameState.playerThorns, color: '#8B4513', icon: '🌿' });
            }
            
            if (gameState.counterDamage > 0) {
                playerEffects.push({ name: '反击', value: gameState.counterDamage, color: '#ff6b6b', icon: '⚔️' });
            }
            
            // 显示玩家状态效果
            playerEffects.forEach(effect => {
                const effectElement = document.createElement('div');
                effectElement.style.cssText = `
                    background: ${effect.color}33;
                    border: 1px solid ${effect.color};
                    border-radius: 4px;
                    padding: 2px 6px;
                    color: white;
                    font-weight: bold;
                `;
                effectElement.textContent = `${effect.icon} ${effect.name} ${effect.value}`;
                playerEffectsContainer.appendChild(effectElement);
            });
            
            // 敌人状态效果
            const enemyEffects = [];
            
            if (gameState.enemyPoison > 0) {
                enemyEffects.push({ name: '毒素', value: gameState.enemyPoison, color: '#9b59b6', icon: '☠️' });
            }
            
            if (gameState.enemyBurn > 0) {
                enemyEffects.push({ name: '燃烧', value: gameState.enemyBurn, color: '#e74c3c', icon: '🔥' });
            }
            
            if (gameState.enemyFrozen > 0) {
                enemyEffects.push({ name: '冰冻', value: gameState.enemyFrozen, color: '#3498db', icon: '❄️' });
            }
            
            if (gameState.enemyCursed > 0) {
                enemyEffects.push({ name: '诅咒', value: gameState.enemyCursed, color: '#8e44ad', icon: '💀' });
            }
            
            if (gameState.enemyStealth > 0) {
                enemyEffects.push({ name: '潜行', value: gameState.enemyStealth, color: '#666666', icon: '👤' });
            }
            
            // 显示敌人状态效果
            enemyEffects.forEach(effect => {
                const effectElement = document.createElement('div');
                effectElement.style.cssText = `
                    background: ${effect.color}33;
                    border: 1px solid ${effect.color};
                    border-radius: 4px;
                    padding: 2px 6px;
                    color: white;
                    font-weight: bold;
                `;
                effectElement.textContent = `${effect.icon} ${effect.name} ${effect.value}`;
                enemyEffectsContainer.appendChild(effectElement);
            });
            
            // 添加标签
            if (playerEffects.length > 0) {
                const label = document.createElement('div');
                label.textContent = '玩家状态:';
                label.style.cssText = 'width: 100%; color: #ffd700; font-weight: bold; margin-bottom: 4px;';
                playerEffectsContainer.insertBefore(label, playerEffectsContainer.firstChild);
            }
            
            if (enemyEffects.length > 0) {
                const label = document.createElement('div');
                label.textContent = '敌人状态:';
                label.style.cssText = 'width: 100%; color: #ff6b6b; font-weight: bold; margin-bottom: 4px;';
                enemyEffectsContainer.insertBefore(label, enemyEffectsContainer.firstChild);
            }
        }

        // 更新手牌显示
        function updateHandDisplay() {
            const handContainer = document.getElementById('hand');
            handContainer.innerHTML = '';
            
            // 立即更新牌库信息
            if (document.getElementById('drawPileInfo')) {
                document.getElementById('drawPileInfo').textContent = `🃏 牌库: ${gameState.drawPile.length}张 | 弃牌堆: ${gameState.discardPile.length}张`;
            }
            
            // 使用定时器创建卡牌逐一出现的效果
            let delay = 0;
            gameState.hand.forEach((cardName, index) => {
                setTimeout(() => {
                    const cardElement = createCardElement(cardName, () => playCard(index));
                    const card = cardDatabase[cardName];
                    if (gameState.energy < card.cost) {
                        // 添加能量不足时的样式效果
                        cardElement.style.opacity = '0.5';
                        cardElement.style.cursor = 'not-allowed';
                        // 使用CSS滤镜使颜色变暗
                        cardElement.style.filter = 'brightness(0.7) grayscale(0.3)';
                    } else {
                        // 确保能量充足时恢复正常样式
                        cardElement.style.opacity = '1';
                        cardElement.style.cursor = 'pointer';
                        cardElement.style.filter = 'none';
                    }
                    
                    // 为每张卡牌添加动画
                    cardElement.style.animation = 'fadeIn 0.3s ease-out forwards';
                    cardElement.style.opacity = '0';
                    cardElement.style.transform = 'translateY(20px)';
                    
                    handContainer.appendChild(cardElement);
                }, delay);
                
                // 每张牌之间间隔50毫秒
                delay += 50;
            });
        }

        // 打出卡牌
        function playCard(handIndex) {
            const cardName = gameState.hand[handIndex];
            const card = cardDatabase[cardName];
            
            let actualCost = card.cost;
            
            // 现实重构效果：本回合所有牌费用-1
            if (gameState.realityRewrite) {
                actualCost = Math.max(0, actualCost - 1);
            }
            
            if (gameState.energy < actualCost) {
                addLog('能量不足！');
                return;
            }
            
            // 检查恐惧状态
            if (gameState.fearThisTurn && card.type === 'attack') {
                addLog('恐惧状态下无法使用攻击牌！');
                return;
            }
            
            gameState.energy -= actualCost;
            gameState.cardsPlayedThisTurn = (gameState.cardsPlayedThisTurn || 0) + 1;
            
            // 风暴之心效果：每打出一张牌获得1点能量
            if (gameState.stormCore > 0) {
                gameState.energy += 1;
                gameState.stormCore--;
                addLog('风暴之心：获得1点能量！');
            }
            const playedCard = gameState.hand.splice(handIndex, 1)[0];
            
            // 将打出的卡牌放入弃牌堆（除非是消耗卡牌）
            if (card.exhaust) {
                // 消耗卡牌被永久移除，记录到exhaustedCards中
                gameState.exhaustedCards = gameState.exhaustedCards || [];
                gameState.exhaustedCards.push(playedCard);
            } else {
                // 普通卡牌放入弃牌堆
                gameState.discardPile.push(playedCard);
            }
            
            // 执行卡牌效果
            executeCardEffect(cardName, card);
            
            updateBattleUI();
            
            // 传奇卡牌特殊效果
            if (card.rarity === 'legendary') {
                executeLegendaryCardEffect(cardName, card);
            }
            
            // 检查BOSS阶段转换
            checkBossPhaseTransition();
            
            // 检查敌人是否死亡
            if (gameState.currentEnemy.hp <= 0) {
                // 源初魔龙特殊处理：第一条命结束后复活进入第4阶段
                if (gameState.currentEnemy.name === '源初魔龙尼伯罗根' && (!gameState.currentEnemy.rebirthCount || gameState.currentEnemy.rebirthCount === 0)) {
                    // 第一条命结束，复活进入第4阶段（死亡轮回）
                    gameState.currentEnemy.hp = Math.floor(gameState.currentEnemy.maxHp * 0.6);
                    gameState.currentEnemy.currentPhase = 3;
                    gameState.currentEnemy.phaseTransitioned = true;
                    gameState.currentEnemy.rebirthCount = 1;
                    gameState.currentEnemy.phase4Turns = 0;
                    addLog(`💀 ${gameState.currentEnemy.name} 死亡后复活！进入死亡轮回阶段！`);
                    addLog(`源初魔龙获得了新的力量，生命恢复至60%！`);
                    updateEnemyUI();
                } else if (gameState.currentEnemy.abilities && gameState.currentEnemy.abilities.includes('revive') && !gameState.currentEnemy.hasRevived) {
                    // 骷髅战士重生特性：死亡后以20%生命值复活一次
                    gameState.currentEnemy.hp = Math.floor(gameState.currentEnemy.maxHp * 0.2);
                    gameState.currentEnemy.hasRevived = true;
                    addLog(`💀 ${gameState.currentEnemy.name} 触发了重生！以20%生命值复活！`);
                    updateEnemyUI();
                } else {
                    victory();
                }
            }
        }

        // 显示伤害数字
        function showDamageNumber(damage, isHeal = false, target = 'enemy') {
            const targetElement = target === 'enemy' ? 
                document.querySelector('.enemy-display') : 
                document.querySelector('.player-status');
            
            if (!targetElement) return;
            
            const damageElement = document.createElement('div');
            damageElement.className = isHeal ? 'heal-number' : 'damage-number';
            damageElement.textContent = isHeal ? `+${damage}` : `-${damage}`;
            
            const rect = targetElement.getBoundingClientRect();
            damageElement.style.left = `${rect.left + rect.width / 2 - 20}px`;
            damageElement.style.top = `${rect.top + rect.height / 2}px`;
            
            document.body.appendChild(damageElement);
            
            setTimeout(() => {
                if (damageElement.parentNode) {
                    damageElement.parentNode.removeChild(damageElement);
                }
            }, 1000);
        }
        
        // 添加震动效果
        function addShakeEffect(target = 'enemy') {
            const targetElement = target === 'enemy' ? 
                document.querySelector('.enemy') : 
                document.querySelector('.player-status');
            
            if (targetElement) {
                targetElement.classList.add('shake-animation');
                setTimeout(() => {
                    targetElement.classList.remove('shake-animation');
                }, 500);
            }
        }
        
        // 添加闪红效果
        function addFlashEffect(target = 'enemy') {
            const targetElement = target === 'enemy' ? 
                document.querySelector('.enemy') : 
                document.querySelector('.player-status');
            
            if (targetElement) {
                targetElement.classList.add('flash-red');
                setTimeout(() => {
                    targetElement.classList.remove('flash-red');
                }, 300);
            }
        }

        // 检查BOSS阶段转换
        function checkBossPhaseTransition() {
            const enemy = gameState.currentEnemy;
            if (!enemy.isBoss || !enemy.phases) return;
            
            const currentHpRatio = enemy.hp / enemy.maxHp;
            const currentPhase = enemy.phases[enemy.currentPhase];
            
            // 检查是否需要进入下一阶段
            for (let i = enemy.currentPhase + 1; i < enemy.phases.length; i++) {
                const nextPhase = enemy.phases[i];
                if (currentHpRatio <= nextPhase.hpThreshold) {
                    enemy.currentPhase = i;
                    enemy.phaseTransitioned = true;
                    addLog(`🔥 ${enemy.name} 进入 ${nextPhase.name}！`);
                    addLog(`${nextPhase.description}`);
                    
                    // 阶段转换特殊效果
                    executeBossPhaseTransition(enemy, nextPhase);
                    break;
                }
            }
        }
        
        // 执行BOSS阶段转换效果
        function executeBossPhaseTransition(enemy, phase) {
            // 根据不同BOSS和阶段执行特殊效果
            if (enemy.name === '暗影龙王') {
                if (phase.name === '愤怒阶段') {
                    addLog('暗影龙王召唤了暗影分身！');
                    gameState.shadowClones = 2;
                } else if (phase.name === '绝望阶段') {
                    addLog('现实开始扭曲！时间变得不稳定！');
                    gameState.timeDistortion = true;
                }
            } else if (enemy.name === '元素领主') {
                if (phase.name === '冰霜形态') {
                    addLog('战场被冰霜覆盖！');
                    gameState.frozenField = 3;
                } else if (phase.name === '雷电形态') {
                    addLog('雷电风暴降临！');
                    gameState.stormField = 3;
                }
            } else if (enemy.name === '虚空君主') {
                if (phase.name === '能量形态') {
                    addLog('虚空君主变为纯能量体！物理攻击效果减半！');
                    gameState.energyForm = true;
                } else if (phase.name === '终极形态') {
                    addLog('现实开始崩塌！每回合受到虚空伤害！');
                    gameState.realityCollapse = true;
                }
            } else if (enemy.name === '创世神') {
                if (phase.name === '试炼阶段') {
                    addLog('创世神展现创造之力！获得强大护盾！');
                    gameState.divineShield = 50;
                } else if (phase.name === '终极试炼') {
                    addLog('生死轮回开始！战斗进入最终阶段！');
                    gameState.rebirthCycle = true;
                }
            } else if (enemy.name === '源初魔龙尼伯罗根') {
                if (phase.name === '元素融合') {
                    addLog('四大元素之力融合！源初魔龙获得元素强化！');
                    enemy.attack = Math.floor(enemy.attack * 1.2); // 攻击力提升20%
                } else if (phase.name === '世界末日') {
                    addLog('世界末日降临！源初魔龙进入失控状态！');
                    gameState.apocalypseAura = true; // 每回合结束时对玩家造成伤害
                } else if (phase.name === '死亡轮回') {
                    addLog('死亡轮回激活！源初魔龙获得死亡之力！');
                    enemy.attack = Math.floor(enemy.attack * 1.5); // 攻击力提升50%
                    gameState.undeadDragon = true; // 获得不死特性
                } else if (phase.name === '终焉时刻') {
                    addLog('终焉时刻到来！源初魔龙成为无敌的龙神！');
                    enemy.attack = Math.floor(enemy.attack * 2); // 攻击力翻倍
                    gameState.dragonGodInvincible = 1; // 第一回合无敌
                }
            }
        }

        // 执行传奇卡牌效果
        function executeLegendaryCardEffect(cardName, card) {
            switch(cardName) {
                case '暗影支配':
                    gameState.shadowClones = (gameState.shadowClones || 0) + 1;
                    addLog('召唤了暗影分身协助战斗！');
                    break;
                case '龙王之怒':
                    addLog('龙息席卷战场！');
                    break;
                case '时空扭曲':
                    gameState.extraTurn = true;
                    addLog('时空扭曲！获得额外回合！');
                    break;
                case '元素掌控':
                    const elementalDamage = (gameState.enemyBurn || 0) * 5 + (gameState.enemyFrozen || 0) * 8 + (gameState.enemyPoison || 0) * 3;
                    if (elementalDamage > 0) {
                        gameState.currentEnemy.hp -= elementalDamage;
                        addLog(`元素掌控造成了 ${elementalDamage} 点额外伤害！`);
                    }
                    break;
                case '风暴之心':
                    gameState.stormCore = 5; // 本回合最多获得5点额外能量
                    addLog('风暴之心激活！每打出一张牌获得1点能量！');
                    break;
                case '永恒冰晶':
                    gameState.eternalIce = true;
                    gameState.playerBlock = (gameState.playerBlock || 0) + 10;
                    addLog('永恒冰晶激活！获得永久护盾效果！');
                    break;
                case '虚空掌握':
                    const removedEffects = (gameState.enemyPoison || 0) + (gameState.enemyBurn || 0) + (gameState.enemyFrozen || 0);
                    gameState.enemyPoison = 0;
                    gameState.enemyBurn = 0;
                    gameState.enemyFrozen = 0;
                    gameState.currentEnemy.hp -= removedEffects * 3;
                    addLog(`虚空掌握移除了敌人所有效果并造成 ${removedEffects * 3} 点伤害！`);
                    break;
                case '现实重构':
                    // 重新洗牌并抽牌
                    gameState.discardPile.push(...gameState.hand);
                    gameState.hand = [];
                    gameState.drawPile.push(...gameState.discardPile);
                    gameState.discardPile = [];
                    // 洗牌
                    for (let i = gameState.drawPile.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [gameState.drawPile[i], gameState.drawPile[j]] = [gameState.drawPile[j], gameState.drawPile[i]];
                    }
                    drawCards(5);
                    gameState.realityRewrite = true; // 本回合所有牌费用-1
                    addLog('现实重构！重新洗牌并抽5张牌，本回合所有牌费用-1！');
                    break;
                case '存在湮灭':
                    const eraseDamage = Math.floor(gameState.currentEnemy.hp * 0.5);
                    gameState.currentEnemy.hp -= eraseDamage;
                    addLog(`存在湮灭造成了 ${eraseDamage} 点真实伤害！`);
                    break;
                case '创世之力':
                    gameState.playerHp = gameState.playerMaxHp;
                    // 获得所有正面效果
                    let strengthBuff = gameState.buffs.find(b => b.name === '力量');
                    if (strengthBuff) strengthBuff.stacks += 3;
                    else gameState.buffs.push({ name: '力量', stacks: 3, type: 'power' });
                    
                    let armorBuff = gameState.buffs.find(b => b.name === '护甲');
                    if (armorBuff) armorBuff.stacks += 2;
                    else gameState.buffs.push({ name: '护甲', stacks: 2, type: 'armor' });
                    
                    addLog('创世之力！完全恢复并获得强大增益！');
                    break;
                case '神圣审判':
                    const judgmentDamage = gameState.currentEnemy.maxHp - gameState.currentEnemy.hp;
                    gameState.currentEnemy.hp -= judgmentDamage;
                    addLog(`神圣审判造成了 ${judgmentDamage} 点审判伤害！`);
                    break;
                case '永恒轮回':
                    gameState.eternalCycle = true;
                    addLog('永恒轮回激活！死亡时将复活并获得所有传奇卡牌！');
                    break;
                case '自然之力':
                    // 基础伤害
                    let natureDamage = card.base_damage || 10;
                    // 计算自然效果（流血和毒素）的总层数
                    const naturalEffects = (gameState.enemyBleed || 0) + (gameState.enemyPoison || 0);
                    // 每层自然效果造成额外伤害
                    const bonusDamage = naturalEffects * (card.dot_multiplier || 2);
                    // 总伤害
                    const totalNatureDamage = natureDamage + bonusDamage;
                    
                    gameState.currentEnemy.hp -= totalNatureDamage;
                    addLog(`自然之力：造成${natureDamage}点基础伤害，每层自然效果(${naturalEffects层})造成${bonusDamage}点额外伤害，总计${totalNatureDamage}点伤害！`);
                    
                    // 同时获得护盾和法术强度加成
                    const shieldBonus = Math.floor(naturalEffects * 2);
                    gameState.playerBlock = (gameState.playerBlock || 0) + shieldBonus;
                    addLog(`自然之力：获得${shieldBonus}点护盾！`);
                    
                    const spellPowerBonus = Math.min(3, Math.floor(naturalEffects / 3));
                    if (spellPowerBonus > 0) {
                        gameState.buffs.push({ name: '法术强度', stacks: spellPowerBonus, type: 'spellpower' });
                        addLog(`自然之力：获得${spellPowerBonus}层法术强度！`);
                    }
                    break;
                case '战争之神':
                    // 基础伤害
                    let warDamage = card.base_damage || 15;
                    // 获取当前力量层数
                    const warStrengthBuff = gameState.buffs.find(b => b.name === '力量' || b.type === 'strength');
                    const strengthStacks = warStrengthBuff ? warStrengthBuff.stacks : 0;
                    // 每层力量造成额外伤害
                    const strengthBonus = strengthStacks * (card.strength_multiplier || 3);
                    // 总伤害
                    const totalWarDamage = warDamage + strengthBonus;
                    
                    gameState.currentEnemy.hp -= totalWarDamage;
                    addLog(`战争之神：造成${warDamage}点基础伤害，每层力量(${strengthStacks层})造成${strengthBonus}点额外伤害，总计${totalWarDamage}点伤害！`);
                    
                    // 消耗所有力量层数
                    if (warStrengthBuff) {
                        warStrengthBuff.stacks = 0;
                        // 但保留buff对象以便后续添加新的力量加成
                    }
                    
                    // 对所有其他敌人造成溅射伤害
                    if (gameState.enemies && gameState.enemies.length > 1) {
                        const splashDamage = Math.floor(totalWarDamage / 3);
                        let splashTargets = 0;
                        for (let i = 0; i < gameState.enemies.length; i++) {
                            if (gameState.enemies[i].hp > 0 && gameState.enemies[i] !== gameState.currentEnemy) {
                                gameState.enemies[i].hp -= splashDamage;
                                splashTargets++;
                            }
                        }
                        if (splashTargets > 0) {
                            addLog(`战争之神：对其他${splashTargets}个敌人造成${splashDamage}点溅射伤害！`);
                        }
                    }
                    break;
            }
        }

        // 执行卡牌效果
        function executeCardEffect(cardName, card) {
            let damage = 0;
            
            // 诅咒卡牌效果
            if (card.type === 'curse') {
                if (card.self_damage) {
                    gameState.playerHp -= card.self_damage;
                    showDamageNumber(card.self_damage, false, 'player');
                    addShakeEffect('player');
                    addFlashEffect('player');
                    addLog(`${cardName} 对自己造成了 ${card.self_damage} 点伤害！`);
                }
                if (card.weakness) {
                    let weaknessBuff = gameState.buffs.find(b => b.name === '虚弱');
                    if (weaknessBuff) {
                        weaknessBuff.stacks += card.weakness;
                    } else {
                        gameState.buffs.push({ name: '虚弱', stacks: card.weakness, type: 'debuff' });
                    }
                    addLog(`${cardName} 使你虚弱了 ${card.weakness} 点！`);
                }
                if (card.random_cost) {
                    const extraCost = Math.floor(Math.random() * 3) + 1;
                    gameState.energy = Math.max(0, gameState.energy - extraCost);
                    addLog(`${cardName} 额外消耗了 ${extraCost} 点能量！`);
                }
                if (card.fear) {
                    gameState.fearThisTurn = true;
                    addLog(`${cardName} 让你恐惧，无法使用攻击牌！`);
                }
                if (card.cost > 0 && !card.self_damage && !card.weakness && !card.random_cost) {
                    addLog(`${cardName} 浪费了 ${card.cost} 点能量！`);
                }
                return;
            }
            
            // 处理所有类型卡牌的self_damage效果（非诅咒卡牌）
            if (card.self_damage) {
                gameState.playerHp -= card.self_damage;
                showDamageNumber(card.self_damage, false, 'player');
                addShakeEffect('player');
                addFlashEffect('player');
                addLog(`${cardName} 对自己造成了 ${card.self_damage} 点伤害！`);
            }
            
            // 处理陷阱卡牌
            if (card.trap) {
                gameState.trapActive = true;
                gameState.trapType = card.id || cardName;
                addLog(`你设置了一个${cardName}！`);
                // 陷阱卡牌不立即执行伤害和效果，而是在敌人回合触发
                return;
            }
            
            // 角色被动技能处理
            if (gameState.passiveAbility === 'combo_mastery' && gameState.firstCardThisTurn) {
                gameState.energy += 1; // 返还1点能量
                gameState.firstCardThisTurn = false;
                addLog('连击精通：第一张牌消耗-1！');
            }
            
            if (gameState.passiveAbility === 'arcane_intellect' && card.type === 'magic') {
                // 使用局部变量进行计数，避免状态不一致
                const currentSpellCount = gameState.spellsPlayedThisTurn + 1;
                
                // 立即更新游戏状态中的计数
                gameState.spellsPlayedThisTurn = currentSpellCount;
                
                // 检查是否需要抽牌（每2张魔法牌）
                if (currentSpellCount % 2 === 0) {
                    // 使用一个临时变量来存储抽牌前的手牌数量，用于后续验证
                    const handSizeBeforeDraw = gameState.hand.length;
                    
                    // 立即执行抽牌逻辑
                    let cardDrawn = false;
                    let drawnCardName = null;
                    
                    // 1. 处理牌库为空的情况
                    if (gameState.drawPile.length === 0) {
                        if (gameState.discardPile.length > 0) {
                            // 将弃牌堆洗入牌库
                            gameState.drawPile = [...gameState.discardPile];
                            gameState.discardPile = [];
                            
                            // 洗牌
                            for (let j = gameState.drawPile.length - 1; j > 0; j--) {
                                const k = Math.floor(Math.random() * (j + 1));
                                [gameState.drawPile[j], gameState.drawPile[k]] = [gameState.drawPile[k], gameState.drawPile[j]];
                            }
                            addLog('牌库已重置并洗牌！');
                        } else {
                            addLog('没有更多卡牌可抽！');
                        }
                    }
                    
                    // 2. 执行抽牌
                    if (gameState.drawPile.length > 0) {
                        drawnCardName = gameState.drawPile.shift();
                        gameState.hand.push(drawnCardName);
                        cardDrawn = true;
                    }
                    
                    // 3. 强制同步更新UI，确保状态和显示完全一致
                    if (cardDrawn) {
                        // 确保手牌UI元素存在
                        const handContainer = document.getElementById('hand');
                        if (handContainer) {
                            // 清空手牌容器，确保没有残留元素
                            handContainer.innerHTML = '';
                            
                            // 重新创建所有手牌元素
                            for (let i = 0; i < gameState.hand.length; i++) {
                                const handCardName = gameState.hand[i];
                                const cardElement = createCardElement(handCardName, () => playCard(i));
                                const card = cardDatabase[handCardName];
                                
                                // 设置卡牌可用性状态
                                if (gameState.energy < card.cost) {
                                    cardElement.style.opacity = '0.5';
                                    cardElement.style.cursor = 'not-allowed';
                                }
                                
                                // 为新抽到的卡牌添加动画
                                if (handCardName === drawnCardName) {
                                    cardElement.style.animation = 'fadeIn 0.5s ease-out forwards';
                                    cardElement.style.opacity = '0';
                                    cardElement.style.transform = 'translateY(20px)';
                                }
                                
                                handContainer.appendChild(cardElement);
                            }
                        }
                        
                        // 更新牌库信息
                        if (document.getElementById('drawPileInfo')) {
                            document.getElementById('drawPileInfo').textContent = `🃏 牌库: ${gameState.drawPile.length}张 | 弃牌堆: ${gameState.discardPile.length}张`;
                        }
                        
                        addLog('奥术智慧：抽1张牌！');
                    }
                }
            }
            
            if (gameState.passiveAbility === 'precision_shot' && card.range && gameState.firstRangedAttackThisTurn) {
                damage = Math.floor(damage * 1.5);
                gameState.firstRangedAttackThisTurn = false;
                addLog('精准射击：这发远程攻击造成1.5倍伤害！');
            }
            
            // 术士被动：邪能增幅
            if (gameState.passiveAbility === 'demonic_amplification' && card.self_damage) {
                gameState.demonicEnergy = (gameState.demonicEnergy || 0) + 1;
                addLog(`邪能增幅：获得1层邪能，当前${gameState.demonicEnergy}层！`);
            }
            
            if (card.damage) {
                damage = card.damage;
                
                // 应用角色加成
                if (card.type === 'attack' && gameState.selectedCharacter === 'warrior') {
                    damage += characters.warrior.attackBonus;
                }
                if (card.type === 'magic' && gameState.selectedCharacter === 'mage') {
                    damage += characters.mage.spellPower;
                }
                if (card.range && gameState.selectedCharacter === 'hunter') {
                    damage += characters.hunter.rangeBonus;
                    
                    // 应用精准效果（鹰眼）
                    if (gameState.precisionStacks > 0) {
                        const precisionBonus = gameState.precisionStacks * 4;
                        damage += precisionBonus;
                        gameState.precisionStacks = 0;
                        addLog(`精准效果：额外造成${precisionBonus}点伤害！`);
                    }
                }
                
                // 应用猎人标记效果
                if (gameState.enemyMarked && card.type === 'attack') {
                    damage += 3;
                    addLog(`猎人标记：额外造成3点伤害！`);
                    
                    // 瞄准射击特殊效果：对标记的敌人伤害翻倍
                    if (card.precision) {
                        damage *= 2;
                        addLog(`瞄准射击：对标记的敌人伤害翻倍！`);
                    }
                }
                // 骑士神圣伤害加成
                if (card.holy && gameState.selectedCharacter === 'knight' && characters.knight) {
                    damage += (characters.knight.holyBonus || 0);
                    
                    // 应用神圣之力增益效果（虔诚卡牌）
                    const holyStrengthBuff = gameState.buffs.find(b => b.type === 'holy_strength' || b.name === '神圣之力');
                    if (holyStrengthBuff) {
                        const holyBonus = holyStrengthBuff.stacks * 4;
                        damage += holyBonus;
                        // 消耗神圣之力buff
                        gameState.buffs = gameState.buffs.filter(b => !(b.type === 'holy_strength' || b.name === '神圣之力'));
                        addLog(`神圣之力：额外造成${holyBonus}点伤害！`);
                    }
                }
                // 全局邪能伤害加成
                if (gameState.felPower && gameState.selectedCharacter === 'warlock') {
                    const felBonus = Math.floor(damage * gameState.felPower);
                    damage += felBonus;
                    addLog(`邪能增幅：额外造成${felBonus}点伤害！`);
                }
                // 术士邪能伤害加成
                if (gameState.selectedCharacter === 'warlock' && gameState.demonicEnergy > 0) {
                    damage += gameState.demonicEnergy;
                }
                
                // 应用buff加成 - 同时处理name为'力量'和type为'strength'的buff
                const strengthBuff = gameState.buffs.find(b => b.name === '力量' || b.type === 'strength');
                if (strengthBuff && (card.type === 'attack' || card.type === 'magic')) {
                    damage += strengthBuff.stacks * 2;
                }
                
                // 应用虚弱减益
                const weaknessBuff = gameState.buffs.find(b => b.name === '虚弱');
                if (weaknessBuff && card.type === 'attack') {
                    damage = Math.max(1, damage - weaknessBuff.stacks);
                }
                
                // 全局暴击几率
                if (gameState.critChance && Math.random() < gameState.critChance) {
                    damage = Math.floor(damage * 1.5);
                    addLog('暴击！');
                }
                
                // 盗贼暴击几率
                else if (gameState.selectedCharacter === 'rogue' && Math.random() < characters.rogue.critChance) {
                    damage = Math.floor(damage * 1.5);
                    addLog('暴击！');
                }
                
                // 特殊暴击效果
                if (card.crit_bonus && Math.random() < card.crit_bonus) {
                    damage *= 2;
                    addLog('致命暴击！');
                }
                
                // 潜行加成
                if (card.stealth_bonus && gameState.stealthTurns > 0) {
                    damage *= 2;
                    addLog('潜行攻击！伤害翻倍！');
                }
                
                // 闪电链效果
                if (card.chain) {
                    const spellsInHand = gameState.hand.filter(cardName => cardDatabase[cardName].type === 'magic').length;
                    damage += spellsInHand * 2;
                    addLog(`闪电链：手牌中有${spellsInHand}张法术牌，额外造成${spellsInHand * 2}点伤害！`);
                }
                
                // 连击效果
                if (card.combo) {
                    const comboCount = gameState.comboThisTurn || 0;
                    const comboBonus = gameState.comboBonus || 0;
                    
                    if (card.type === 'attack') {
                        const damageBonus = Math.floor(3 * (1 + comboBonus));
                        damage += damageBonus; // 连击攻击牌额外伤害
                        addLog(`连击：额外造成${damageBonus}点伤害${comboBonus > 0 ? '（连击大师增强）' : ''}！`);
                    } else if (card.type === 'defense') {
                        const blockBonus = Math.floor(4 * (1 + comboBonus));
                        card.block = (card.block || 0) + blockBonus; // 连击防御牌额外护盾
                        addLog(`连击：额外获得${blockBonus}点护盾${comboBonus > 0 ? '（连击大师增强）' : ''}！`);
                    }
                    gameState.comboThisTurn = comboCount + 1;
                }
                
                // 暴击效果
                if (card.crit && Math.random() < 0.5) {
                    damage *= 2;
                    addLog('暴击！');
                }
                
                // 厄运效果：减半所有效果
                let actualDamage = damage;
                if (gameState.badLuckActive > 0) {
                    actualDamage = Math.floor(actualDamage / 2);
                }
                
                // 法术强度加成
                const spellPowerBuff = gameState.buffs.find(b => b.type === 'spellpower');
                if (spellPowerBuff && card.type === 'magic') {
                    actualDamage += spellPowerBuff.stacks;
                }
                
                // 全局法术精通加成
                if (gameState.spellPower && card.type === 'magic') {
                    const spellBonus = Math.floor(actualDamage * gameState.spellPower);
                    actualDamage += spellBonus;
                    addLog(`法术精通：额外造成${spellBonus}点伤害！`);
                }
                
                // 附加目标最大生命值百分比伤害
                if (card.maxHealthBonus && gameState.currentEnemy) {
                    const healthBonus = Math.floor(gameState.currentEnemy.maxHp * card.maxHealthBonus);
                    actualDamage += healthBonus;
                    addLog(`附加伤害：造成目标最大生命值${Math.round(card.maxHealthBonus * 100)}%的额外伤害(${healthBonus}点)！`);
                }
                
                // 源初魔龙鳞片护甲减伤效果
                const enemy = gameState.currentEnemy;
                if (enemy && enemy.name === '源初魔龙尼伯罗根' && gameState.scaleArmor > 0) {
                    const armorReduction = Math.min(actualDamage, gameState.scaleArmor * 3);
                    actualDamage = Math.max(1, actualDamage - armorReduction);
                    addLog(`源初魔龙的鳞片护甲减少了 ${armorReduction} 点伤害！`);
                }
                
                // 骨甲减伤效果
                if (enemy && enemy.abilities && enemy.abilities.includes('bone_armor')) {
                    const boneArmorReduction = Math.min(actualDamage, 3);
                    actualDamage = Math.max(1, actualDamage - boneArmorReduction);
                    addLog(`骨甲减少了 ${boneArmorReduction} 点伤害！`);
                }
                
                // 冰甲减伤效果
                if (enemy && enemy.abilities && enemy.abilities.includes('ice_armor')) {
                    const iceArmorReduction = Math.min(actualDamage, 5);
                    actualDamage = Math.max(1, actualDamage - iceArmorReduction);
                    addLog(`冰甲减少了 ${iceArmorReduction} 点伤害！`);
                }
                
                // 火盾效果：受到伤害时反弹燃烧伤害
                if (enemy && enemy.abilities && enemy.abilities.includes('fire_shield')) {
                    const fireShieldDamage = 2;
                    gameState.enemyBurn = (gameState.enemyBurn || 0) + fireShieldDamage;
                    addLog(`火盾触发！对玩家造成 ${fireShieldDamage} 点燃烧伤害！`);
                }
                
                // 穿刺效果（无视护盾）
                if (card.pierce) {
                    gameState.currentEnemy.hp -= actualDamage;
                    showDamageNumber(actualDamage);
                    addShakeEffect('enemy');
                    addFlashEffect('enemy');
                    addLog(`${cardName} 穿刺攻击造成了 ${actualDamage} 点伤害！`);
                    
                    // 灵魂链接效果
                    if (gameState.soulLinkActive) {
                        const sharedDamage = Math.floor(actualDamage / 3);
                        gameState.playerHp -= sharedDamage;
                        addLog(`灵魂链接：你受到了 ${sharedDamage} 点共享伤害！`);
                    }
                } else {
                    // 多段攻击
                    const hits = card.hits || 1;
                    let totalDamage = 0;
                    for (let i = 0; i < hits; i++) {
                        gameState.currentEnemy.hp -= actualDamage;
                        totalDamage += actualDamage;
                        if (hits > 1) {
                            addLog(`${cardName} 第${i+1}击造成了 ${actualDamage} 点伤害！`);
                        }
                        
                        // 灵魂链接效果
                        if (gameState.soulLinkActive) {
                            const sharedDamage = Math.floor(actualDamage / 3);
                            gameState.playerHp -= sharedDamage;
                            if (hits === 1) {
                                addLog(`灵魂链接：你受到了 ${sharedDamage} 点共享伤害！`);
                            }
                        }
                    }
                    showDamageNumber(totalDamage);
                    addShakeEffect('enemy');
                    addFlashEffect('enemy');
                    if (hits === 1) {
                        addLog(`${cardName} 对敌人造成了 ${actualDamage} 点伤害！`);
                    }
                }
                
                // 斩首效果
                if (card.execute && gameState.currentEnemy.hp / gameState.currentEnemy.maxHp <= card.execute) {
                    gameState.currentEnemy.hp = 0;
                    showDamageNumber(9999);
                    addShakeEffect('enemy');
                    addLog(`${cardName} 触发斩首效果！敌人被秒杀！`);
                }
                
                // 吸血效果
                if (card.lifesteal || (gameState.relics && gameState.relics.includes('吸血鬼之牙'))) {
                    let healAmount;
                    if (card.lifesteal && (gameState.relics && gameState.relics.includes('吸血鬼之牙'))) {
                        // 同时有卡牌吸血和吸血鬼之牙，卡牌吸血效果保持不变
                        healAmount = Math.min(damage, gameState.playerMaxHp - gameState.playerHp);
                    } else if (card.lifesteal) {
                        // 只有卡牌吸血效果
                        healAmount = Math.min(damage, gameState.playerMaxHp - gameState.playerHp);
                    } else {
                        // 只有吸血鬼之牙，效果削弱至50%
                        healAmount = Math.min(Math.floor(damage * 0.5), gameState.playerMaxHp - gameState.playerHp);
                    }
                    gameState.playerHp += healAmount;
                    showDamageNumber(healAmount, true, 'player');
                    if (card.lifesteal) {
                        addLog(`吸血恢复了 ${healAmount} 点生命值！`);
                    } else {
                        addLog(`吸血鬼之牙：恢复了 ${healAmount} 点生命值！`);
                    }
                }
                
                // 溅射伤害
                if (card.splash && gameState.enemies && gameState.enemies.length > 1) {
                    let splashTargets = 0;
                    for (let i = 0; i < gameState.enemies.length; i++) {
                        if (gameState.enemies[i].hp > 0 && gameState.enemies[i] !== gameState.currentEnemy) {
                            gameState.enemies[i].hp -= card.splash;
                            splashTargets++;
                        }
                    }
                    if (splashTargets > 0) {
                        addLog(`${cardName} 造成了 ${card.splash} 点溅射伤害！`);
                    }
                }
                
                // 眩晕效果
                if (card.stun) {
                    // 检查眩晕疲劳机制
                    const isBoss = gameState.currentEnemy && gameState.currentEnemy.isBoss;
                    const maxStunCount = isBoss ? 2 : 3;
                    
                    if (gameState.stunCount < maxStunCount) {
                        gameState.enemyStunned = card.stun;
                        gameState.stunCount++;
                        addLog(`${cardName} 眩晕了敌人 ${card.stun} 回合！`);
                    } else {
                        addLog(`控制疲劳！${cardName} 的眩晕效果对敌人无效！`);
                    }
                }
            }
            
            if (card.block) {
                gameState.playerBlock = (gameState.playerBlock || 0) + card.block;
                addLog(`${cardName} 获得了 ${card.block} 点护盾！`);
            }
            
            if (card.heal) {
                let healAmount = card.heal;
                // 应用牧师的治疗加成
                if (gameState.selectedCharacter === 'priest' && characters.priest) {
                    healAmount += (characters.priest.healingPower || 0);
                }
                healAmount = Math.min(healAmount, gameState.playerMaxHp - gameState.playerHp);
                gameState.playerHp += healAmount;
                showDamageNumber(healAmount, true, 'player');
                addLog(`${cardName} 恢复了 ${healAmount} 点生命值！`);
            }
            
            if (card.poison) {
                gameState.enemyPoison = (gameState.enemyPoison || 0) + card.poison;
                addLog(`${cardName} 给敌人施加了 ${card.poison} 层毒素！`);
            }
            
            // 流血效果
            if (card.bleed) {
                gameState.enemyBleed = (gameState.enemyBleed || 0) + card.bleed;
                addLog(`${cardName} 给敌人施加了 ${card.bleed} 层流血！`);
            }
            
            if (card.burn) {
                gameState.enemyBurn = (gameState.enemyBurn || 0) + card.burn;
                addLog(`${cardName} 给敌人施加了 ${card.burn} 层燃烧！`);
            }
            
            if (card.freeze) {
                // 检查冰冻疲劳机制
                const isBoss = gameState.currentEnemy && gameState.currentEnemy.isBoss;
                const maxFreezeCount = isBoss ? 2 : 3;
                
                if (gameState.freezeCount < maxFreezeCount) {
                    gameState.enemyFrozen = card.freeze;
                    gameState.freezeCount++;
                    addLog(`${cardName} 冰冻了敌人 ${card.freeze} 回合！`);
                } else {
                    addLog(`控制疲劳！${cardName} 的冰冻效果对敌人无效！`);
                }
            }
            
            if (card.stealth) {
                // 增加潜行使用次数
                gameState.stealthCount = (gameState.stealthCount || 0) + 1;
                
                // 计算失败概率：使用超过2次后，每多使用一次增加20%失败概率
                let failChance = 0;
                if (gameState.stealthCount > 2) {
                    failChance = Math.min(0.8, (gameState.stealthCount - 2) * 0.2);
                }
                
                // 检查是否成功
                if (Math.random() >= failChance) {
                    gameState.stealthTurns = 1;
                    addLog(`${cardName} 进入潜行状态！`);
                    
                    // 如果已经有较高的失败概率，提醒玩家
                    if (failChance > 0) {
                        addLog(`⚠️ 潜行疲劳：下次尝试有 ${Math.floor(failChance * 100)}% 概率失败！`);
                    }
                } else {
                    addLog(`${cardName} 尝试进入潜行状态，但失败了！`);
                    addLog(`⚠️ 潜行疲劳：当前有 ${Math.floor(failChance * 100)}% 概率失败！`);
                }
            }
            
            if (card.counter) {
                gameState.counterDamage = (gameState.counterDamage || 0) + card.counter;
                addLog(`${cardName} 获得了 ${card.counter} 点反击伤害！`);
            }
            
            if (card.thorns) {
                gameState.playerThorns = (gameState.playerThorns || 0) + card.thorns;
                addLog(`${cardName} 获得了 ${card.thorns} 层荆棘！`);
            }
            
            // 无敌效果
            if (card.invulnerable) {
                gameState.playerInvulnerable = card.invulnerable;
                addLog(`${cardName} 获得了 ${card.invulnerable} 回合无敌效果！`);
                
                // 如果卡牌有exhaust属性，使用后消耗
                if (card.exhaust) {
                    addLog(`${cardName} 使用后被消耗！`);
                }
            }
            
            // 嘲讽效果
            if (card.taunt) {
                gameState.tauntActive = true;
                addLog(`${cardName} 吸引敌人攻击！`);
            }
            
            // 恐惧效果
            if (card.fear && card.type !== 'curse') {
                // 检查恐惧疲劳机制
                const isBoss = gameState.currentEnemy && gameState.currentEnemy.isBoss;
                const maxFearCount = isBoss ? 2 : 3;
                
                if (gameState.fearCount < maxFearCount) {
                    gameState.enemyFear = 1; // 使敌人恐惧1回合
                    gameState.fearCount++;
                    addLog(`${cardName} 使敌人恐惧，跳过下回合！`);
                } else {
                    addLog(`控制疲劳！${cardName} 的恐惧效果对敌人无效！`);
                }
            }
            
            // 厄运效果
            if (card.bad_luck) {
                const badLuckDuration = card.duration || 1;
                gameState.badLuckActive = badLuckDuration;
                addLog(`${cardName} 带来了厄运，${badLuckDuration}回合内所有效果减半！`);
            }
            
            // Buff效果
            if (card.buff) {
                // 特殊处理精准buff（鹰眼效果）
                if (card.buff === 'precision') {
                    gameState.precisionStacks += (card.stacks || 1);
                    addLog(`${cardName} 获得了 ${card.stacks || 1} 层精准！下次远程攻击+${(card.stacks || 1) * 4} 伤害！`);
                } else {
                    let buff = gameState.buffs.find(b => b.name === card.buff);
                    const stacks = card.stacks || 1;
                    if (buff) {
                        buff.stacks += stacks;
                    } else {
                        const buffNames = {
                            'rage': '狂怒',
                            'armor': '护甲',
                            'frenzy': '狂热',
                            'power': '力量',
                            'strength': '力量',
                            'spellpower': '法术强度',
                            'holy_strength': '神圣之力'
                        };
                        gameState.buffs.push({ name: buffNames[card.buff] || card.buff, stacks: stacks, type: card.buff });
                    }
                    addLog(`${cardName} 增加了${card.buff === 'strength' ? '力量' : card.buff === 'spellpower' ? '法术强度' : card.buff}效果！`);
                }
            }
            
            // 处理猎人标记效果
            if (card.mark) {
                gameState.enemyMarked = true;
                addLog(`${cardName} 标记了敌人！所有对其的攻击+3伤害！`);
            }
            
            if (card.draw) {
                drawCards(card.draw);
                addLog(`${cardName} 抽了 ${card.draw} 张牌！`);
            }
            
            if (card.energy_gain) {
                gameState.energy += card.energy_gain;
                addLog(`${cardName} 获得了 ${card.energy_gain} 点能量！`);
            }
            
            if (card.curse) {
                gameState.enemyCursed = (gameState.enemyCursed || 0) + card.curse;
                addLog(`${cardName} 诅咒了敌人 ${card.curse} 回合！`);
            }
            
            if (card.cleanse) {
                gameState.buffs = gameState.buffs.filter(b => b.type !== 'debuff');
                addLog(`${cardName} 净化了所有负面效果！`);
            }
            
            if (card.sacrifice) {
                gameState.playerHp -= card.sacrifice;
                addLog(`${cardName} 献祭了 ${card.sacrifice} 点生命值！`);
            }
            
            if (card.dodge_next) {
                gameState.dodgeNext = true;
                addLog(`${cardName} 下次攻击必定闪避！`);
            }
            
            if (card.clone) {
                gameState.cloneNext = true;
                addLog(`${cardName} 下张攻击牌将打出两次！`);
            }
            
            if (card.discard_hand) {
                const discardedCount = gameState.hand.length;
                gameState.discardPile.push(...gameState.hand);
                gameState.hand = [];
                addLog(`${cardName} 弃掉了 ${discardedCount} 张手牌！`);
                updateHandDisplay();
            }
            
            // 灵魂链接效果
            if (card.link) {
                gameState.soulLinkActive = true;
                gameState.soulLinkTurns = card.link_duration || 2;
                addLog(`${cardName} 建立了灵魂链接，${gameState.soulLinkTurns}回合内双方伤害共享！`);
            }
            
            // 元素融合效果
            if (card.combine_elements) {
                // 计算敌人身上的负面效果总数
                const totalEffects = (gameState.enemyBurn || 0) + (gameState.enemyFrozen || 0) + (gameState.enemyPoison || 0) + (gameState.enemyBleed || 0);
                
                // 基础伤害和每层效果的伤害倍率
                const baseDamage = card.base_damage || 5;
                const effectMultiplier = card.effect_multiplier || 3;
                
                // 总伤害 = 基础伤害 × (1 + 效果数量 × 倍率)
                const fusionDamage = Math.round(baseDamage * (1 + totalEffects * effectMultiplier));
                
                gameState.currentEnemy.hp -= fusionDamage;
                addLog(`${cardName} 融合了 ${totalEffects} 种负面效果，造成 ${fusionDamage} 点伤害！`);
            }
            
            // 无限循环效果
            if (card.loop && gameState.hand.length > 0) {
                const randomCard = gameState.hand[Math.floor(Math.random() * gameState.hand.length)];
                gameState.drawPile.unshift(randomCard);
                addLog(`${cardName} 将 ${randomCard} 放回牌库顶部！`);
            }
            
            if (card.lucky) {
                const effects = ['heal', 'energy', 'draw', 'buff'];
                const randomEffect = effects[Math.floor(Math.random() * effects.length)];
                switch(randomEffect) {
                    case 'heal':
                        gameState.playerHp = Math.min(gameState.playerMaxHp, gameState.playerHp + 10);
                        addLog('幸运效果：恢复10点生命值！');
                        break;
                    case 'energy':
                        gameState.energy += 2;
                        addLog('幸运效果：获得2点能量！');
                        break;
                    case 'draw':
                        drawCards(2);
                        addLog('幸运效果：抽2张牌！');
                        break;
                    case 'buff':
                        let buff = gameState.buffs.find(b => b.name === '力量');
                        if (buff) {
                            buff.stacks++;
                        } else {
                            gameState.buffs.push({ name: '力量', stacks: 1, type: 'power' });
                        }
                        addLog('幸运效果：获得1层力量！');
                        break;
                }
            }
            
            if (card.exhaust) {
                // 使用后移除的卡牌逻辑
                addLog(`${cardName} 使用后被移除！`);
            }
        }

        // 结束回合
        function endTurn() {
            // 将手牌放入弃牌堆（排除诅咒卡等不可移除的卡牌）
            gameState.hand.forEach(cardName => {
                const card = cardDatabase[cardName];
                if (!card.unremovable) {
                    gameState.discardPile.push(cardName);
                }
            });
            gameState.hand = [];
            
            // 敌人回合
            enemyTurn();
            
            // 检查敌人是否死亡（在敌人回合后）
            if (gameState.currentEnemy.hp <= 0) {
                victory();
                return;
            }
            
            // 检查玩家是否死亡
            if (gameState.playerHp <= 0) {
                gameOver();
                return;
            }
            
            // 牧师被动：神圣治疗
            if (gameState.passiveAbility === 'holy_healing' && gameState.playerHp < gameState.playerMaxHp * 0.5) {
                const healAmount = 6;
                gameState.playerHp = Math.min(gameState.playerMaxHp, gameState.playerHp + healAmount);
                showDamageNumber(healAmount, true, 'player');
                addLog('神圣治疗：恢复6点生命值！');
            }
            
            // 开始新的玩家回合
            startPlayerTurn();
        }
        
        // 开始玩家回合
        function startPlayerTurn() {
            // 玩家回合开始
            gameState.energy = gameState.maxEnergy;
            gameState.playerBlock = 0; // 护盾在回合结束时消失
            gameState.comboThisTurn = 0; // 重置连击计数
            gameState.spellsPlayedThisTurn = 0; // 重置法术计数
            gameState.firstCardThisTurn = true; // 重置首张牌标记
            gameState.fearThisTurn = false; // 重置恐惧状态
            gameState.cardsPlayedThisTurn = 0; // 重置本回合打牌计数
            gameState.realityRewrite = false; // 重置现实重构效果
            gameState.tauntActive = false; // 重置嘲讽效果
            gameState.enemyBleed = 0; // 重置流血效果
            
            // 减少无敌状态持续时间
            if (gameState.playerInvulnerable > 0) {
                gameState.playerInvulnerable--;
                if (gameState.playerInvulnerable === 0) {
                    addLog('无敌状态消失！');
                }
            }
            
            // 处理厄运效果持续时间
            if (gameState.badLuckActive > 0) {
                gameState.badLuckActive--;
                if (gameState.badLuckActive <= 0) {
                    addLog('厄运效果消失！');
                } else {
                    addLog(`厄运效果持续中...剩余 ${gameState.badLuckActive} 回合`);
                }
            }
            
            // 处理灵魂链接持续时间
            if (gameState.soulLinkActive) {
                gameState.soulLinkTurns--;
                if (gameState.soulLinkTurns <= 0) {
                    gameState.soulLinkActive = false;
                    addLog('灵魂链接效果消失！');
                } else {
                    addLog(`灵魂链接持续中...剩余 ${gameState.soulLinkTurns} 回合`);
                }
            }
            
            // 战士被动：护甲精通
            if (gameState.passiveAbility === 'armor_mastery') {
                gameState.playerBlock += 2;
                addLog('护甲精通：获得2点护盾！');
            }
            
            // 骑士被动：神圣守护
            if (gameState.passiveAbility === 'holy_guardian') {
                if (Math.random() < 0.5) {
                    gameState.energy += 1;
                    gameState.playerBlock += 2;
                    addLog('神圣守护：获得1点能量和2点护盾！');
                }
            }
            
            // 永恒冰晶效果
            if (gameState.eternalIce) {
                gameState.playerBlock += 3;
                addLog('永恒冰晶：获得3点护盾！');
            }
            
            // 神器效果处理
            if (gameState.relics) {
                if (gameState.relics.includes('幸运硬币') && Math.random() < 0.25) {
                    gameState.energy += 1;
                    addLog('幸运硬币：获得1点额外能量！');
                }
                
                if (gameState.relics.includes('荆棘护符')) {
                    gameState.playerThorns = (gameState.playerThorns || 0) + 3;
                    addLog('荆棘护符：获得3层荆棘！');
                }
            }
            
            // 处理潜行
            if (gameState.stealthTurns > 0) {
                gameState.stealthTurns--;
            }
            
            // 重置猎人的第一发远程攻击标记
            if (gameState.firstRangedAttackThisTurn === false) {
                gameState.firstRangedAttackThisTurn = true;
            }
            
            // 移除术士的邪能效果
            if (gameState.demonicEnergy > 0) {
                gameState.demonicEnergy = 0;
                addLog('邪能效果消失！');
            }
            
            // 处理BOSS战斗特殊状态
            if (gameState.currentEnemy && gameState.currentEnemy.isBoss) {
                // 处理火焰光环
                if (gameState.fireAura > 0) {
                    const fireDamage = 5;
                    gameState.playerHp -= fireDamage;
                    addLog(`火焰光环造成了 ${fireDamage} 点伤害！`);
                    gameState.fireAura--;
                }
                
                // 处理现实崩塌
                if (gameState.realityCollapse) {
                    const voidDamage = 8;
                    gameState.playerHp -= voidDamage;
                    addLog(`现实崩塌造成了 ${voidDamage} 点虚空伤害！`);
                }
                
                // 处理玩家诅咒状态
                if (gameState.playerCursed > 0) {
                    gameState.playerCursed--;
                    addLog(`诅咒效果持续中...剩余 ${gameState.playerCursed} 回合`);
                }
                
                // 处理时间扭曲（暗影龙王绝望阶段）
                if (gameState.timeDistortion) {
                    if (Math.random() < 0.3) {
                        addLog('时间扭曲！回合顺序混乱，你失去了一张手牌！');
                        if (gameState.hand.length > 0) {
                            gameState.discardPile.push(gameState.hand.pop());
                            updateHandDisplay();
                        }
                    }
                }
                
                // 处理冰冻战场（元素领主冰霜形态）
                if (gameState.frozenField > 0) {
                    const freezeChance = 0.3;
                    if (Math.random() < freezeChance) {
                        addLog('冰冻战场：你被冻住了，本回合少抽一张牌！');
                        gameState.frozenDrawPenalty = true;
                    }
                    gameState.frozenField--;
                }
                
                // 处理雷电风暴（元素领主雷电形态）
                if (gameState.stormField > 0) {
                    const lightningDamage = 4;
                    gameState.playerHp -= lightningDamage;
                    addLog(`雷电风暴击中了你，造成了 ${lightningDamage} 点伤害！`);
                    gameState.stormField--;
                }
                
                // 处理神圣护盾（创世神试炼阶段）
                if (gameState.divineShield > 0) {
                    addLog(`神圣护盾保护着敌人，减少所有伤害 ${Math.floor(gameState.divineShield * 0.2)} 点！`);
                }
            }
            
            // 处理狂热buff
            const frenzyBuff = gameState.buffs.find(b => b.name === '狂热');
            if (frenzyBuff) {
                drawCards(frenzyBuff.stacks);
                addLog(`狂热效果：抽了 ${frenzyBuff.stacks} 张牌！`);
            }
            
            // 抽卡（修复：确保每回合都抽牌）
            const baseDrawCount = 5;
            const rogueBonus = (gameState.selectedCharacter === 'rogue') ? 1 : 0;
            const totalDrawCount = baseDrawCount + rogueBonus;
            
            drawCards(totalDrawCount);
            addLog(`新回合开始！抽了 ${totalDrawCount} 张牌。`);
            
            updateBattleUI();
        }

        // 敌人回合
        function enemyTurn() {
            const enemy = gameState.currentEnemy;
            
            // 检查并触发陷阱效果
            if (gameState.trapActive) {
                const trapType = gameState.trapType;
                let trapDamage = 0;
                let stunDuration = 0;
                let poisonStacks = 0;
                
                // 根据陷阱类型设置效果
                switch(trapType) {
                    case 'trap':
                        trapDamage = 8;
                        stunDuration = 1;
                        break;
                    case 'explosive-trap':
                        trapDamage = 12;
                        // 爆炸陷阱的溅射伤害在executeCardEffect中已经处理
                        break;
                    case 'snake-trap':
                        trapDamage = 6;
                        poisonStacks = 3;
                        break;
                }
                
                // 造成陷阱伤害
                gameState.currentEnemy.hp -= trapDamage;
                showDamageNumber(trapDamage);
                addShakeEffect('enemy');
                addFlashEffect('enemy');
                addLog(`陷阱触发！敌人受到了 ${trapDamage} 点伤害！`);
                
                // 应用眩晕效果（如果有）并检查眩晕疲劳机制
                if (stunDuration > 0) {
                    const isBoss = gameState.currentEnemy && gameState.currentEnemy.isBoss;
                    const maxStunCount = isBoss ? 2 : 3;
                    
                    if (gameState.stunCount < maxStunCount) {
                        gameState.enemyStunned = stunDuration;
                        gameState.stunCount++;
                        addLog(`陷阱触发了眩晕效果！敌人被眩晕 ${stunDuration} 回合！`);
                    } else {
                        addLog(`控制疲劳！陷阱的眩晕效果对敌人无效！`);
                    }
                }
                
                // 应用毒素效果（如果有）
                if (poisonStacks > 0) {
                    gameState.enemyPoison = (gameState.enemyPoison || 0) + poisonStacks;
                    addLog(`陷阱触发了毒素效果！敌人被施加了 ${poisonStacks} 层毒素！`);
                }
                
                // 重置陷阱状态
                gameState.trapActive = false;
                gameState.trapType = null;
                
                // 检查敌人是否因陷阱伤害而死亡
                if (gameState.currentEnemy.hp <= 0) {
                    victory();
                    return;
                }
            }
            
            // 检查恐惧状态
            if (gameState.enemyFear > 0) {
                gameState.enemyFear--;
                addLog(`敌人被恐惧，无法行动！`);
                // 重置意图为下回合准备
                enemy.currentIntent = predictEnemyIntent(enemy);
                return;
            }
            
            // 检查冰冻状态
            if (gameState.enemyFrozen > 0) {
                gameState.enemyFrozen--;
                addLog(`敌人被冰冻，跳过回合！`);
                // 重置意图为下回合准备
                enemy.currentIntent = predictEnemyIntent(enemy);
                return;
            }
            
            // 检查眩晕状态
            if (gameState.enemyStunned > 0) {
                addLog(`敌人被眩晕，无法行动！`);
                // 重置意图为下回合准备
                enemy.currentIntent = predictEnemyIntent(enemy);
                return;
            }
            
            // 敌人AI行为
            executeEnemyAI(enemy);
            
            // 处理敌人状态效果
            processEnemyStatusEffects();
            
            // 为下回合生成新的意图
            enemy.currentIntent = predictEnemyIntent(enemy);
            
            // 增加回合计数
            enemy.turnCount = (enemy.turnCount || 0) + 1;
            
            // 源初魔龙特殊处理：第4阶段5回合后进入第5阶段
            if (enemy.name === '源初魔龙尼伯罗根' && enemy.currentPhase === 3) {
                enemy.phase4Turns = (enemy.phase4Turns || 0) + 1;
                
                // 显示第4阶段剩余回合数
                if (enemy.phase4Turns < 5) {
                    addLog(`源初魔龙死亡轮回阶段剩余回合：${5 - enemy.phase4Turns}`);
                } else {
                    // 进入第5阶段（终焉时刻）
                    enemy.currentPhase = 4;
                    enemy.phaseTransitioned = true;
                    addLog(`🔥 ${enemy.name} 进入终焉时刻！完全觉醒为龙神形态！`);
                    addLog(`源初魔龙的力量达到了顶点！世界末日即将来临！`);
                    
                    // 执行第5阶段转换效果
                    executeBossPhaseTransition(enemy, enemy.phases[4]);
                }
            }
        }
        
        // 执行敌人AI
        function executeEnemyAI(enemy) {
            let damage = enemy.attack;
            let willAttack = true;
            
            // BOSS特殊AI逻辑
            if (enemy.isBoss) {
                executeBossAI(enemy);
                return;
            }
            
            // 普通敌人AI逻辑
            // 根据敌人能力执行特殊行为
            if (enemy.abilities.includes('stealth') && Math.random() < 0.3) {
                gameState.enemyStealth = 1;
                addLog(`${enemy.name} 进入潜行状态！`);
                willAttack = false;
            }
            
            if (enemy.abilities.includes('rage') && enemy.hp < enemy.maxHp * 0.5) {
                damage = Math.floor(damage * 1.5);
                addLog(`${enemy.name} 进入狂怒状态！攻击力提升！`);
            }
            
            if (enemy.abilities.includes('heal') && enemy.hp < enemy.maxHp * 0.3 && Math.random() < 0.4) {
                const healAmount = Math.floor(enemy.maxHp * 0.2);
                enemy.hp = Math.min(enemy.maxHp, enemy.hp + healAmount);
                addLog(`${enemy.name} 恢复了 ${healAmount} 点生命值！`);
                willAttack = false;
            }
            
            if (enemy.abilities.includes('summon_minions') && Math.random() < 0.2) {
                addLog(`${enemy.name} 召唤了小怪！下回合攻击力翻倍！`);
                gameState.enemyNextTurnDouble = true;
                willAttack = false;
            }
            
            // 新增特性实现
            // 闪避特性 - 毒蛇
            if (enemy.abilities.includes('dodge') && Math.random() < 0.25) {
                gameState.enemyDodge = true;
                addLog(`${enemy.name} 进入闪避状态！本次攻击有30%几率闪避！`);
            }
            
            // 精准射击特性 - 哥布林弓手
            if (enemy.abilities.includes('precise_shot')) {
                damage = Math.floor(damage * 1.2);
                addLog(`${enemy.name} 发动精准射击！攻击力提升20%！`);
            }
            
            // 骨甲特性 - 骷髅战士
            if (enemy.abilities.includes('bone_armor') && !enemy.boneArmorActive) {
                enemy.boneArmorActive = true;
                gameState.enemyArmor = (gameState.enemyArmor || 0) + 3;
                addLog(`${enemy.name} 激活了骨甲！获得3点护甲！`);
            }
            
            // 冰甲特性 - 冰霜法师
            if (enemy.abilities.includes('ice_armor') && !enemy.iceArmorActive) {
                enemy.iceArmorActive = true;
                gameState.enemyArmor = (gameState.enemyArmor || 0) + 5;
                addLog(`${enemy.name} 激活了冰甲！获得5点护甲！`);
            }
            
            // 火盾特性 - 火焰恶魔
            if (enemy.abilities.includes('fire_shield') && !enemy.fireShieldActive) {
                enemy.fireShieldActive = true;
                gameState.enemyFireShield = (gameState.enemyFireShield || 0) + 2;
                addLog(`${enemy.name} 激活了火盾！每次受到攻击会造成2点燃烧伤害！`);
            }
            
            if (willAttack) {
                executeEnemyAttack(damage);
            }
        }
        
        // 执行BOSS AI
        function executeBossAI(enemy) {
            const currentPhase = enemy.phases[enemy.currentPhase];
            const abilities = currentPhase.abilities;
            
            // 根据当前阶段的能力执行行动
            const selectedAbility = abilities[Math.floor(Math.random() * abilities.length)];
            
            switch(selectedAbility) {
                case 'shadow_breath':
                    const breathDamage = enemy.attack + 5;
                    executeEnemyAttack(breathDamage);
                    addLog(`${enemy.name} 释放了暗影吐息！`);
                    break;
                    
                case 'wing_attack':
                    executeEnemyAttack(enemy.attack);
                    addLog(`${enemy.name} 使用翅膀攻击！`);
                    break;
                    
                case 'shadow_clone':
                    gameState.shadowClones = (gameState.shadowClones || 0) + 1;
                    addLog(`${enemy.name} 召唤了暗影分身！下回合将受到额外攻击！`);
                    break;
                    
                case 'curse_aura':
                    gameState.playerCursed = 2;
                    addLog(`${enemy.name} 释放诅咒光环！你被诅咒了2回合！`);
                    break;
                    
                case 'reality_tear':
                    const tearDamage = Math.floor(enemy.attack * 1.5);
                    executeEnemyAttack(tearDamage);
                    gameState.hand.splice(0, 1); // 移除一张手牌
                    addLog(`${enemy.name} 撕裂现实！造成强大伤害并破坏了一张手牌！`);
                    break;
                    
                case 'time_distortion':
                    gameState.energy = Math.max(0, gameState.energy - 1);
                    addLog(`${enemy.name} 扭曲时间！你失去了1点能量！`);
                    break;
                    
                case 'final_judgment':
                    const judgmentDamage = Math.floor(gameState.playerMaxHp * 0.3);
                    executeEnemyAttack(judgmentDamage);
                    addLog(`${enemy.name} 释放最终审判！造成巨额伤害！`);
                    break;
                    
                case 'meteor_strike':
                    executeEnemyAttack(enemy.attack + 8);
                    gameState.enemyBurn = (gameState.enemyBurn || 0) + 2;
                    addLog(`${enemy.name} 召唤流星打击！你被燃烧了！`);
                    break;
                    
                case 'fire_aura':
                    gameState.fireAura = 3;
                    addLog(`${enemy.name} 激活火焰光环！接下来3回合你每回合受到火焰伤害！`);
                    break;
                    
                case 'blizzard':
                    executeEnemyAttack(enemy.attack);
                    gameState.enemyFrozen = 1;
                    addLog(`${enemy.name} 召唤暴风雪！你被冰冻了1回合！`);
                    break;
                    
                case 'chain_lightning':
                    executeEnemyAttack(enemy.attack);
                    gameState.energy = Math.max(0, gameState.energy - 2);
                    addLog(`${enemy.name} 释放连锁闪电！你失去了2点能量！`);
                    break;
                     
                // 源初魔龙能力 - 第一阶段
                case 'primal_flame_breath':
                    const flameDamage = enemy.attack + 10;
                    executeEnemyAttack(flameDamage);
                    gameState.enemyBurn = (gameState.enemyBurn || 0) + 3;
                    addLog(`${enemy.name} 释放原始火焰吐息！造成高额伤害并让你燃烧3回合！`);
                    break;
                     
                case 'dragon_roar':
                    gameState.playerSilenced = 2;
                    gameState.energy = Math.max(0, gameState.energy - 2);
                    addLog(`${enemy.name} 发出震天龙吟！你被沉默2回合并失去2点能量！`);
                    break;
                     
                case 'scale_armor':
                    gameState.scaleArmor = (gameState.scaleArmor || 0) + 2;
                    addLog(`${enemy.name} 激活鳞片护甲！获得2层护甲，每层减少3点受到的伤害！`);
                    break;
                     
                // 源初魔龙能力 - 第二阶段
                case 'elemental_chaos':
                    const chaosDamage = Math.floor(enemy.attack * 1.3);
                    executeEnemyAttack(chaosDamage);
                    // 随机施加一个负面效果
                    const negativeEffects = ['enemyBurn', 'enemyFrozen', 'enemyPoison'];
                    const randomEffect = negativeEffects[Math.floor(Math.random() * negativeEffects.length)];
                    gameState[randomEffect] = (gameState[randomEffect] || 0) + 2;
                    const effectNames = {
                        'enemyBurn': '燃烧',
                        'enemyFrozen': '冰冻',
                        'enemyPoison': '中毒'
                    };
                    addLog(`${enemy.name} 引发元素混乱！造成伤害并让你${effectNames[randomEffect]}2回合！`);
                    break;
                     
                case 'reality_fracture':
                    const fractureDamage = Math.floor(enemy.attack * 1.5);
                    executeEnemyAttack(fractureDamage);
                    if (gameState.hand.length > 0) {
                        const randomIndex = Math.floor(Math.random() * gameState.hand.length);
                        gameState.hand.splice(randomIndex, 1);
                        addLog(`${enemy.name} 断裂现实！造成伤害并摧毁了一张随机手牌！`);
                    }
                    break;
                     
                case 'time_eclipse':
                    gameState.timeEclipse = 2;
                    gameState.nextDrawCount = Math.max(1, gameState.nextDrawCount - 1);
                    addLog(`${enemy.name} 引发时间日食！接下来2回合你每回合少抽1张牌！`);
                    break;
                     
                // 源初魔龙能力 - 第三阶段
                case 'cataclysm':
                    const cataclysmDamage = Math.floor(enemy.attack * 2);
                    executeEnemyAttack(cataclysmDamage);
                    gameState.playerMaxHp -= 10;
                    gameState.playerHp = Math.min(gameState.playerHp, gameState.playerMaxHp);
                    addLog(`${enemy.name} 释放大灾变！造成巨额伤害并永久降低你的最大生命值！`);
                    break;
                     
                case 'void_absorption':
                    const absorptionDamage = enemy.attack;
                    executeEnemyAttack(absorptionDamage);
                    // 吸收造成伤害的30%作为生命值
                    const absorbedHp = Math.floor(absorptionDamage * 0.3);
                    if (gameState.currentEnemy) {
                        gameState.currentEnemy.hp = Math.min(gameState.currentEnemy.hp + absorbedHp, gameState.currentEnemy.maxHp);
                    }
                    addLog(`${enemy.name} 吸收虚空能量！造成伤害并恢复了${absorbedHp}点生命值！`);
                    break;
                     
                case 'dragon_madness':
                    gameState.dragonMadness = 2;
                    addLog(`${enemy.name} 陷入疯狂！接下来2回合会连续攻击2次！`);
                    break;
                     
                // 源初魔龙能力 - 第四阶段（复活后）
                case 'resurrection_flame':
                    executeEnemyAttack(enemy.attack + 5);
                    gameState.playerHp = Math.max(1, Math.floor(gameState.playerHp * 0.8)); // 燃烧生命值上限
                    addLog(`${enemy.name} 释放复活火焰！造成伤害并燃烧你的生命上限！`);
                    break;
                     
                case 'eternal_agony':
                    gameState.eternalAgony = 3;
                    addLog(`${enemy.name} 施加永恒痛苦！接下来3回合每回合受到8点伤害！`);
                    break;
                     
                case 'life_drain':
                    const drainDamage = 10;
                    gameState.playerHp = Math.max(1, gameState.playerHp - drainDamage);
                    if (gameState.currentEnemy) {
                        gameState.currentEnemy.hp = Math.min(gameState.currentEnemy.hp + drainDamage, gameState.currentEnemy.maxHp);
                    }
                    addLog(`${enemy.name} 汲取你的生命能量！你失去10点生命值，敌人恢复10点生命值！`);
                    break;
                     
                // 源初魔龙能力 - 第五阶段（龙神形态）
                case 'apocalypse_beam':
                    const beamDamage = Math.floor(gameState.playerMaxHp * 0.4);
                    executeEnemyAttack(beamDamage);
                    addLog(`${enemy.name} 发射启示录光束！造成相当于你生命值上限40%的伤害！`);
                    break;
                     
                case 'primal_annihilation':
                    // 摧毁玩家所有手牌和一半牌库
                    gameState.hand = [];
                    const deckHalf = Math.ceil(gameState.deck.length / 2);
                    gameState.deck = gameState.deck.slice(0, deckHalf);
                    addLog(`${enemy.name} 释放原始湮灭！摧毁了你所有手牌和一半牌库！`);
                    break;
                     
                case 'dragon_god_form':
                    gameState.dragonGodForm = true;
                    addLog(`${enemy.name} 完全觉醒为龙神形态！攻击力提升30%，并且免疫所有负面效果！`);
                    break;
                     
                default:
                    // 默认攻击
                    executeEnemyAttack(enemy.attack);
                    addLog(`${enemy.name} 进行了普通攻击！`);
                    break;
            }
            
            // 处理暗影分身攻击
            if (gameState.shadowClones > 0) {
                const cloneDamage = Math.floor(enemy.attack * 0.5);
                executeEnemyAttack(cloneDamage);
                addLog(`暗影分身攻击造成了 ${cloneDamage} 点额外伤害！`);
                gameState.shadowClones--;
            }
        }
        
        // 执行敌人攻击
        function executeEnemyAttack(damage) {
            // 检查玩家无敌状态
            if (gameState.playerInvulnerable > 0) {
                addLog('无敌状态！完全免疫了敌人的攻击！');
                return;
            }
            
            // 检查敌人精准射击特性
            const enemy = gameState.currentEnemy;
            if (enemy && enemy.abilities && enemy.abilities.includes('precise_shot')) {
                // 精准射击：敌人攻击必定命中，无视玩家闪避
                damage = Math.floor(damage * 1.2); // 精准射击提升20%攻击力
                addLog('敌人发动精准射击！攻击力提升且无视闪避！');
            } else {
                // 检查玩家闪避
                if (gameState.dodgeNext) {
                    gameState.dodgeNext = false;
                    addLog('完美闪避了敌人的攻击！');
                    return;
                }
                
                // 检查玩家闪避几率
                if (gameState.dodgeChance && Math.random() < gameState.dodgeChance) {
                    addLog('成功闪避了敌人的攻击！');
                    return;
                }
            }
            
            if (gameState.stealthTurns > 0) {
                addLog('敌人的攻击被潜行躲避了！');
                return;
            }
            
            // 虚空君主能量形态：物理攻击减半
            if (gameState.energyForm) {
                const reducedDamage = Math.floor(damage * 0.5);
                const damageReduction = damage - reducedDamage;
                damage = reducedDamage;
                addLog('虚空君主处于能量形态！物理攻击伤害减少了' + damageReduction + '点！');
            }
            
            // 创世神生死轮回和永恒轮回：死亡时有几率复活
            if ((gameState.rebirthCycle || gameState.eternalCycle) && gameState.playerHp - damage <= 0) {
                let triggerChance = gameState.eternalCycle ? 0.4 : 0.3; // 永恒轮回有更高的触发几率
                
                if (Math.random() < triggerChance) {
                    gameState.playerHp = Math.floor(gameState.playerMaxHp * 0.2);
                    
                    if (gameState.eternalCycle) {
                        // 永恒轮回额外效果：获得所有传奇卡牌
                        const allLegendaryCards = availableCards.filter(card => card.rarity === 'legendary');
                        gameState.hand = gameState.hand.concat(allLegendaryCards);
                        gameState.eternalCycle = false; // 消耗永恒轮回效果
                        addLog('创世神的永恒轮回触发！你以20%生命值复活并获得了所有传奇卡牌！');
                    } else {
                        addLog('创世神的生死轮回触发！你以20%生命值复活！');
                    }
                    
                    return; // 跳过本次伤害
                }
            }
            
            // 应用诅咒效果
            if (gameState.enemyCursed > 0) {
                damage += 3;
                addLog('诅咒增加了敌人受到的伤害！');
            }
            
            // 应用护甲减伤
            const armorBuff = gameState.buffs.find(b => b.name === '护甲');
            if (armorBuff) {
                damage = Math.max(1, damage - armorBuff.stacks);
                addLog(`护甲减少了 ${armorBuff.stacks} 点伤害！`);
            }
            
            // 护盾减伤
            if (gameState.playerBlock > 0) {
                const blockedDamage = Math.min(damage, gameState.playerBlock);
                damage -= blockedDamage;
                gameState.playerBlock -= blockedDamage;
                addLog(`护盾抵挡了 ${blockedDamage} 点伤害！`);
            }
            
            // 应用最终伤害
            if (damage > 0) {
                // 检查是否为神圣伤害（创世神的攻击）
                let isHolyDamage = false;
                const enemy = gameState.currentEnemy;
                if (enemy && (enemy.name === '创世神' || 
                    (enemy.abilities && (enemy.abilities.includes('divine_judgment') || enemy.abilities.includes('holy_light'))))) {
                    isHolyDamage = true;
                }
                
                // 应用神圣伤害减免
                let finalDamage = damage;
                if (isHolyDamage && gameState.holyResistance) {
                    const reducedDamage = Math.floor(damage * (1 - gameState.holyResistance));
                    const damageReduction = damage - reducedDamage;
                    finalDamage = reducedDamage;
                    addLog(`神圣守护：减少了 ${damageReduction} 点神圣伤害！`);
                }
                
                gameState.playerHp -= finalDamage;
                showDamageNumber(damage, false, 'player');
                addShakeEffect('player');
                addFlashEffect('player');
                addLog(`敌人攻击造成了 ${damage} 点伤害！`);
                
                // 灵魂链接效果
                if (gameState.soulLinkActive) {
                    const sharedDamage = Math.floor(damage / 3);
                    gameState.currentEnemy.hp -= sharedDamage;
                    addLog(`灵魂链接：敌人受到了 ${sharedDamage} 点共享伤害！`);
                }
                
                // 反击伤害
                if (gameState.counterDamage > 0) {
                    gameState.currentEnemy.hp -= gameState.counterDamage;
                    showDamageNumber(gameState.counterDamage);
                    addShakeEffect('enemy');
                    addLog(`反击造成了 ${gameState.counterDamage} 点伤害！`);
                    gameState.counterDamage = 0;
                }
                
                // 荆棘伤害
                if (gameState.playerThorns > 0) {
                    gameState.currentEnemy.hp -= gameState.playerThorns;
                    showDamageNumber(gameState.playerThorns);
                    addShakeEffect('enemy');
                    addLog(`荆棘造成了 ${gameState.playerThorns} 点伤害！`);
                }
            }
            
            // 检查玩家是否死亡
            if (gameState.playerHp <= 0) {
                // 检查重生效果
                const reviveBuff = gameState.buffs.find(b => b.name === '重生');
                if (reviveBuff) {
                    gameState.playerHp = Math.floor(gameState.playerMaxHp * 0.5);
                    gameState.buffs = gameState.buffs.filter(b => b.name !== '重生');
                    addLog('重生效果触发！复活并恢复50%生命值！');
                } else {
                    gameOver();
                }
            }
        }
        
        // 处理敌人状态效果
        function processEnemyStatusEffects() {
            // 毒素伤害
            if (gameState.enemyPoison > 0) {
                gameState.currentEnemy.hp -= gameState.enemyPoison;
                addLog(`敌人受到 ${gameState.enemyPoison} 点毒素伤害！`);
                gameState.enemyPoison = Math.max(0, gameState.enemyPoison - 1);
            }
            
            // 燃烧伤害
            if (gameState.enemyBurn > 0) {
                gameState.currentEnemy.hp -= gameState.enemyBurn * 2;
                addLog(`敌人受到 ${gameState.enemyBurn * 2} 点燃烧伤害！`);
                gameState.enemyBurn = Math.max(0, gameState.enemyBurn - 1);
            }
            
            // 流血伤害
            if (gameState.enemyBleed > 0) {
                const bleedDamage = Math.floor(gameState.enemyBleed * 0.75); // 使用0.75的倍率降低流血伤害
                gameState.currentEnemy.hp -= bleedDamage;
                addLog(`敌人受到 ${bleedDamage} 点流血伤害！`);
                // 流血效果不递减
            }
            
            // 诅咒持续时间
            if (gameState.enemyCursed > 0) {
                gameState.enemyCursed--;
            }
            
            // 眩晕持续时间
            if (gameState.enemyStunned > 0) {
                gameState.enemyStunned--;
            }
            
            // 源初魔龙特殊状态效果处理
            const enemy = gameState.currentEnemy;
            if (enemy && enemy.name === '源初魔龙尼伯罗根') {
                // 处理永恒痛苦状态（玩家持续受到伤害）
                if (gameState.eternalPain > 0) {
                    const painDamage = 5;
                    gameState.playerHp = Math.max(0, gameState.playerHp - painDamage);
                    showDamageNumber(painDamage);
                    addFlashEffect('player');
                    addLog(`永恒痛苦！你受到 ${painDamage} 点伤害！`);
                    gameState.eternalPain--;
                }
                
                // 处理死亡轮回阶段的不死特性
                if (enemy.currentPhase === 3 && gameState.deathImmunity > 0) {
                    // 死亡轮回阶段结束，清除不死特性
                    if (enemy.phase4Turns >= 5) {
                        gameState.deathImmunity = 0;
                        addLog(`源初魔龙的不死特性消失！现在可以真正消灭它了！`);
                    }
                }
                
                // 处理终焉时刻阶段的无敌状态
                if (enemy.currentPhase === 4 && gameState.eternalShield > 0) {
                    gameState.eternalShield--;
                    if (gameState.eternalShield === 0) {
                        addLog(`源初魔龙的无敌护盾消失了！现在是击败它的最佳时机！`);
                    }
                }
            }
        }

        // 撤退
        function retreat() {
            gameState.playerHp = Math.max(1, gameState.playerHp - 10);
            addLog('撤退成功，但损失了10点生命值！');
            showScreen('deckScreen');
            updateDeckDisplay();
            updateUI();
        }

        // 检查成就
        function checkAchievements() {
            // 初次胜利
            if (!achievements.first_victory.unlocked && gameState.level >= 2) {
                unlockAchievement('first_victory');
            }
            
            // BOSS杀手
            if (!achievements.boss_slayer.unlocked && gameState.currentEnemy && gameState.currentEnemy.isBoss) {
                unlockAchievement('boss_slayer');
            }
            
            // 传奇收藏家
            if (!achievements.legendary_collector.unlocked) {
                const hasLegendary = gameState.playerDeck.some(card => cardDatabase[card] && cardDatabase[card].rarity === 'legendary');
                if (hasLegendary) {
                    unlockAchievement('legendary_collector');
                }
            }
            
            // 连击大师
            if (!achievements.combo_master.unlocked && gameState.cardsPlayedThisTurn >= 5) {
                unlockAchievement('combo_master');
            }
            
            // 幸存者
            if (!achievements.survivor.unlocked && gameState.playerHp <= 10 && gameState.currentEnemy && gameState.currentEnemy.hp <= 0) {
                unlockAchievement('survivor');
            }
            
            // 完美主义者
            if (!achievements.perfectionist.unlocked && gameState.battleStartHp && gameState.playerHp >= gameState.battleStartHp) {
                unlockAchievement('perfectionist');
            }
            
            // 囤积者
            if (!achievements.hoarder.unlocked && gameState.gold >= 100) {
                unlockAchievement('hoarder');
            }
            
            // 飞升者
            if (!achievements.ascension.unlocked && gameState.difficultyMultiplier && gameState.difficultyMultiplier > 1) {
                unlockAchievement('ascension');
            }
        }

        // 解锁成就
        function unlockAchievement(achievementId) {
            if (!achievements[achievementId].unlocked) {
                achievements[achievementId].unlocked = true;
                const achievement = achievements[achievementId];
                addLog(`🏆 成就解锁: ${achievement.name} - ${achievement.description}`);
                
                // 成就奖励
                gameState.gold += 25;
                addLog('获得成就奖励：25金币！');
            }
        }

        // 显示成就列表
        function displayAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = '';
            
            Object.entries(achievements).forEach(([id, achievement]) => {
                const achievementCard = document.createElement('div');
                achievementCard.className = 'reward-card';
                achievementCard.style.cssText = `
                    background: ${achievement.unlocked ? 'linear-gradient(135deg, #ffd700, #ffb347)' : 'rgba(255,255,255,0.1)'};
                    border: 2px solid ${achievement.unlocked ? '#ffd700' : '#666'};
                    border-radius: 15px;
                    padding: 20px;
                    text-align: center;
                    color: ${achievement.unlocked ? '#333' : 'white'};
                    cursor: default;
                `;
                
                achievementCard.innerHTML = `
                    <h3>${achievement.unlocked ? '🏆' : '🔒'} ${achievement.name}</h3>
                    <p>${achievement.description}</p>
                    <p style="font-size: 0.9rem; opacity: 0.8;">${achievement.unlocked ? '已解锁' : '未解锁'}</p>
                `;
                
                achievementsList.appendChild(achievementCard);
            });
        }

        // 胜利
        function victory() {
            const enemy = gameState.currentEnemy;
            
            // 重置猎人标记状态
            gameState.enemyMarked = false;
            
            // 记录战斗结束时的生命值用于成就检查
            gameState.battleEndHp = gameState.playerHp;
            
            // 检查成就
            checkAchievements();
            
            // 检查是否击败了BOSS
            if (enemy.isBoss) {
                addLog(`🏆 恭喜！你击败了守关BOSS：${enemy.name}！`);
                
                // BOSS通关奖励
                gameState.gold += 100 + gameState.level * 10;
                addLog('获得了丰厚的金币奖励！');
                
                // 显示通关界面
                document.getElementById('victoryLevel').textContent = gameState.level;
                generateBossRewards();
                showScreen('victoryScreen');
                return;
            }
            
            // 普通敌人胜利
            gameState.gold += 20 + gameState.level * 5;
            addLog('胜利！获得了金币奖励！');
            
            // 神器效果：战士之魂
            if (gameState.relics && gameState.relics.includes('战士之魂')) {
                const healAmount = Math.min(10, gameState.playerMaxHp - gameState.playerHp);
                gameState.playerHp += healAmount;
                addLog(`战士之魂：击杀敌人后恢复了 ${healAmount} 点生命值！`);
            }
            
            // 生成奖励
            generateRewards();
            showScreen('rewardScreen');
        }

        // 生成BOSS奖励
        function generateBossRewards() {
            const rewardsContainer = document.getElementById('victoryRewards');
            rewardsContainer.innerHTML = '';
            
            const boss = bosses[gameState.level];
            const legendaryCards = boss.rewards;
            
            // 显示传奇卡牌奖励
            legendaryCards.forEach(cardName => {
                const cardElement = createCardElement(cardName, () => {
                    gameState.playerDeck.push(cardName);
                    addLog(`获得了传奇卡牌: ${cardName}！`);
                    document.querySelectorAll('.reward-card').forEach(card => {
                        card.style.pointerEvents = 'none';
                        card.style.opacity = '0.5';
                    });
                });
                cardElement.classList.add('reward-card');
                cardElement.style.margin = '10px';
                rewardsContainer.appendChild(cardElement);
            });
            
            // 添加传奇BUFF奖励选项
            const legendaryBuff = document.createElement('div');
            legendaryBuff.className = 'reward-card';
            legendaryBuff.style.cssText = `
                background: linear-gradient(135deg, #ffd700, #ff8c00);
                border: 3px solid #ffff00;
                border-radius: 15px;
                padding: 20px;
                margin: 10px;
                text-align: center;
                cursor: pointer;
                color: #333;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(255, 215, 0, 0.8);
            `;
            
            // 初始化传奇强化计数器
            if (!gameState.legendaryBuffCount) gameState.legendaryBuffCount = 0;
            
            // 计算递减的强化效果
            const hpBonus = Math.max(20, 40 - gameState.legendaryBuffCount * 5);
            const energyBonus = Math.max(1, 2 - Math.floor(gameState.legendaryBuffCount / 2));
            const strengthBonus = Math.max(1, 3 - Math.floor(gameState.legendaryBuffCount / 1));
            
            legendaryBuff.innerHTML = `
                <h3>🌟 传奇强化</h3>
                <p>最大生命值 +${hpBonus}</p>
                <p>最大能量 +${energyBonus}</p>
                <p>永久获得${strengthBonus}层力量</p>
                ${gameState.legendaryBuffCount > 0 ? `<p style="color:#ff6666;">已获得${gameState.legendaryBuffCount}次，效果递减</p>` : ''}
            `;
            
            addTouchAndClickEvent(legendaryBuff, () => {
                gameState.playerMaxHp += hpBonus;
                gameState.playerHp += hpBonus;
                gameState.maxEnergy += energyBonus;
                let strengthBuff = gameState.buffs.find(b => b.name === '力量');
                if (strengthBuff) strengthBuff.stacks += strengthBonus;
                else gameState.buffs.push({ name: '力量', stacks: strengthBonus, type: 'power' });
                
                // 增加传奇强化计数
                gameState.legendaryBuffCount++;
                
                addLog(`获得了传奇强化！生命值+${hpBonus}，能量+${energyBonus}，力量+${strengthBonus}！`);
                document.querySelectorAll('.reward-card').forEach(card => {
                    card.style.pointerEvents = 'none';
                    card.style.opacity = '0.5';
                });
            });
            rewardsContainer.appendChild(legendaryBuff);
        }

        // 生成奖励
        function generateRewards() {
            const rewardsContainer = document.getElementById('rewards');
            rewardsContainer.innerHTML = '';
            
            // 根据关卡生成不同品质的奖励
            const rewardTypes = ['card', 'buff', 'heal', 'relic', 'curse_removal'];
            const selectedTypes = [];
            
            // 确保至少有一张卡牌奖励
            selectedTypes.push('card');
            
            // 随机选择另外两个奖励
            while (selectedTypes.length < 3) {
                const randomType = rewardTypes[Math.floor(Math.random() * rewardTypes.length)];
                if (!selectedTypes.includes(randomType)) {
                    selectedTypes.push(randomType);
                }
            }
            
            selectedTypes.forEach(type => {
                const rewardCard = document.createElement('div');
                rewardCard.className = 'reward-card';
                
                if (type === 'card') {
                    // 根据关卡提供更好的卡牌，高关卡更容易获得稀有卡牌
                    const rarityWeights = {
                        'common': Math.max(20, 70 - gameState.level * 5),
                        'uncommon': Math.min(50, 20 + gameState.level * 3),
                        'rare': Math.min(30, gameState.level * 2)
                    };
                    
                    const totalWeight = Object.values(rarityWeights).reduce((a, b) => a + b, 0);
                    let random = Math.random() * totalWeight;
                    let selectedRarity = 'common';
                    
                    for (const [rarity, weight] of Object.entries(rarityWeights)) {
                        random -= weight;
                        if (random <= 0) {
                            selectedRarity = rarity;
                            break;
                        }
                    }
                    
                    const availableCards = Object.keys(cardDatabase).filter(name => {
                        const card = cardDatabase[name];
                        return card.type !== 'curse' && card.rarity === selectedRarity && card.rarity !== 'legendary';
                    });
                    
                    const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
                    const rarityText = {
                        'common': '普通',
                        'uncommon': '罕见',
                        'rare': '稀有'
                    };
                    
                    rewardCard.innerHTML = `
                        <h3>🃏 ${rarityText[selectedRarity]}卡牌</h3>
                        <div class="card-art">${createStickmanArt(cardDatabase[randomCard].art)}</div>
                        <p><strong>${randomCard}</strong></p>
                        <p>${cardDatabase[randomCard].description}</p>
                    `;
                    addTouchAndClickEvent(rewardCard, () => {
                        if (safeAddCardToDeck(randomCard, false)) {
                            addLog(`获得了${rarityText[selectedRarity]}卡牌: ${randomCard}！`);
                        } else {
                            addLog(`牌库中已拥有3张${randomCard}，无法添加更多！`);
                        }
                        selectReward();
                    });
                } else if (type === 'buff') {
                    const buffOptions = [
                        { name: '生命强化', desc: '最大生命值 +15', effect: () => { gameState.playerMaxHp += 15; gameState.playerHp += 15; } },
                        { name: '能量提升', desc: '最大能量 +1', effect: () => { gameState.maxEnergy += 1; } },
                        { name: '力量祝福', desc: '永久获得2层力量', effect: () => { 
                            let buff = gameState.buffs.find(b => b.name === '力量');
                            if (buff) buff.stacks += 2;
                            else gameState.buffs.push({ name: '力量', stacks: 2, type: 'power' });
                        }},
                        { name: '护甲强化', desc: '永久获得1层护甲', effect: () => {
                            let buff = gameState.buffs.find(b => b.name === '护甲');
                            if (buff) buff.stacks += 1;
                            else gameState.buffs.push({ name: '护甲', stacks: 1, type: 'armor' });
                        }},
                        { name: '闪避增强', desc: '获得5%闪避几率', effect: () => {
                            gameState.dodgeChance = (gameState.dodgeChance || 0) + 0.05;
                        }},
                        { name: '法术精通', desc: '法术伤害增加10%', effect: () => {
                            gameState.spellPower = (gameState.spellPower || 0) + 0.1;
                        }},
                        { name: '连击大师', desc: '连击效果增强50%', effect: () => {
                            gameState.comboBonus = (gameState.comboBonus || 0) + 0.5;
                        }},
                        { name: '幸运之星', desc: '暴击几率增加5%', effect: () => {
                            gameState.critChance = (gameState.critChance || 0) + 0.05;
                        }},
                        { name: '神圣守护', desc: '神圣伤害减免15%', effect: () => {
                            gameState.holyResistance = (gameState.holyResistance || 0) + 0.15;
                        }},
                        { name: '邪能增幅', desc: '邪能伤害增加15%', effect: () => {
                            gameState.felPower = (gameState.felPower || 0) + 0.15;
                        }}
                    ];
                    const selectedBuff = buffOptions[Math.floor(Math.random() * buffOptions.length)];
                    rewardCard.innerHTML = `
                        <h3>💪 ${selectedBuff.name}</h3>
                        <p>${selectedBuff.desc}</p>
                        <p>永久效果</p>
                    `;
                    addTouchAndClickEvent(rewardCard, () => {
                        selectedBuff.effect();
                        addLog(`获得了${selectedBuff.name}！`);
                        selectReward();
                    });
                } else if (type === 'heal') {
                    rewardCard.innerHTML = `
                        <h3>❤️ 完全治疗</h3>
                        <p>恢复所有生命值</p>
                        <p>移除所有负面效果</p>
                    `;
                    addTouchAndClickEvent(rewardCard, () => {
                        gameState.playerHp = gameState.playerMaxHp;
                        gameState.buffs = gameState.buffs.filter(b => b.type !== 'debuff');
                        addLog('生命值完全恢复，负面效果被清除！');
                        selectReward();
                    });
                } else if (type === 'relic') {
                    const relics = [
                        { name: '吸血鬼之牙', desc: '所有攻击都有吸血效果' },
                        { name: '荆棘护符', desc: '永久获得3层荆棘' },
                        { name: '幸运硬币', desc: '每回合开始时有25%几率获得1点能量' },
                        { name: '战士之魂', desc: '每次击杀敌人后恢复10点生命值' }
                    ];
                    const selectedRelic = relics[Math.floor(Math.random() * relics.length)];
                    rewardCard.innerHTML = `
                        <h3>🏺 ${selectedRelic.name}</h3>
                        <p>${selectedRelic.desc}</p>
                        <p>神器效果</p>
                    `;
                    addTouchAndClickEvent(rewardCard, () => {
                        gameState.relics = gameState.relics || [];
                        gameState.relics.push(selectedRelic.name);
                        addLog(`获得了神器: ${selectedRelic.name}！`);
                        selectReward();
                    });
                } else if (type === 'curse_removal') {
                    const curseCards = gameState.playerDeck.filter(card => cardDatabase[card].type === 'curse');
                    if (curseCards.length > 0) {
                        rewardCard.innerHTML = `
                            <h3>✨ 净化仪式</h3>
                            <p>移除一张诅咒卡牌</p>
                            <p>净化你的牌组</p>
                        `;
                        addTouchAndClickEvent(rewardCard, () => {
                            const curseToRemove = curseCards[0];
                            const index = gameState.playerDeck.indexOf(curseToRemove);
                            gameState.playerDeck.splice(index, 1);
                            addLog(`移除了诅咒卡牌: ${curseToRemove}！`);
                            selectReward();
                        });
                    } else {
                        // 如果没有诅咒卡，提供金币奖励
                        rewardCard.innerHTML = `
                            <h3>💰 金币奖励</h3>
                            <p>获得50金币</p>
                            <p>用于商店购买</p>
                        `;
                        addTouchAndClickEvent(rewardCard, () => {
                            gameState.gold += 50;
                            addLog('获得了50金币！');
                            selectReward();
                        });
                    }
                }
                
                rewardsContainer.appendChild(rewardCard);
            });
        }

        // 选择奖励
        function selectReward() {
            document.querySelectorAll('.reward-card').forEach(card => {
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.5';
            });
            document.getElementById('nextLevel').style.display = 'block';
        }

        // 下一关
        function nextLevel() {
            gameState.level++;
            // 重置控制疲劳状态和敌人状态
            gameState.fearCount = 0;
            gameState.enemyFear = 0;
            gameState.stunCount = 0;
            gameState.freezeCount = 0;
            gameState.stealthCount = 0;
            gameState.enemyMarked = false; // 重置猎人标记状态
            gameState.precisionStacks = 0; // 重置精准层数（鹰眼效果）
            
            updateUI();
            showScreen('deckScreen');
            updateDeckDisplay();
        }

        // 游戏结束
        function gameOver() {
            document.getElementById('finalLevel').textContent = gameState.level;
            
            // 显示本次游戏解锁的成就
            const gameOverAchievements = document.getElementById('gameOverAchievements');
            const unlockedCount = Object.values(achievements).filter(a => a.unlocked).length;
            gameOverAchievements.innerHTML = `
                <p>已解锁成就: ${unlockedCount}/${Object.keys(achievements).length}</p>
            `;
            
            // 更新成就显示
            displayAchievements();
            
            showScreen('gameOverScreen');
        }

        // 继续冒险（难度提升）
        function continueAdventure() {
            // 检查是否已通关第25关
            if (gameState.level >= 25) {
                // 通关第25关后，开始新周目（重置到第1关并提高难度）
                gameState.difficultyMultiplier = (gameState.difficultyMultiplier || 1) + 0.5;
                gameState.level = 1;
                addLog(`🏆 恭喜通关所有关卡！新周目开始！难度倍数: ${gameState.difficultyMultiplier}`);
            } else {
                // 未通关第25关，继续下一关
                gameState.level++;
                addLog(`继续冒险！当前为第${gameState.level}关`);
            }
            
            // 重置控制疲劳状态和敌人状态
            gameState.fearCount = 0;
            gameState.enemyFear = 0;
            gameState.stunCount = 0;
            gameState.freezeCount = 0;
            gameState.stealthCount = 0;
            
            updateUI();
            showScreen('deckScreen');
            updateDeckDisplay();
        }
        
        // 返回主页
        function backToMenu() {
            // 完全重置游戏状态
            restartGame();
        }

        // 重新开始
        function restartGame() {
            gameState = {
                level: 1,
                gold: 50,
                selectedCharacter: null,
                playerDeck: [],
                playerHp: 100,
                playerMaxHp: 100,
                energy: 3,
                maxEnergy: 3,
                hand: [],
                buffs: [],
                legendaryBuffCount: 0,
                currentEnemy: null,
                battleLog: [],
                // 新卡牌效果相关状态
                enemyBleed: 0,
                enemyStunned: 0,
                enemyFear: 0,
                enemyMarked: false, // 猎人标记状态
                precisionStacks: 0, // 精准层数（鹰眼效果）
                tauntActive: false,
                soulLinkActive: false,
                soulLinkTurns: 0,
                firstRangedAttackThisTurn: true,
                badLuckThisTurn: false,
                // 控制效果疲劳计数器
                stunCount: 0,
                freezeCount: 0,
                fearCount: 0,
                // 潜行效果疲劳计数器
                stealthCount: 0,
                badLuckActive: 0,
                // 源初魔龙特殊状态
                scaleArmor: 0,
                eternalPain: 0,
                deathReincarnationCount: 0,
                // 新角色相关属性
                passiveAbility: '',
                spellsPlayedThisTurn: 0,
                firstCardThisTurn: true,
                demonicEnergy: 0,
                // 陷阱相关状态
                trapActive: false,
                trapType: null
            };
            
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('startGame').disabled = true;
            
            showScreen('characterScreen');
            updateUI();
        }

        // 显示屏幕
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // 控制游戏统计信息和标题的显示和隐藏
            const gameStats = document.querySelector('.game-stats');
            const gameTitle = document.querySelector('.game-title');
            
            if (gameStats && gameTitle) {
                if (screenId === 'homeScreen') {
                    gameStats.style.display = 'none';
                    gameTitle.style.display = 'none';
                } else {
                    gameStats.style.display = 'flex';
                    gameTitle.style.display = 'block';
                }
            }
            
            // 如果显示的是角色选择界面，重新为所有角色卡片添加事件监听器
            if (screenId === 'characterScreen') {
                document.querySelectorAll('.character-card').forEach(card => {
                    // 先移除所有现有的点击事件监听器
                    const newCard = card.cloneNode(true);
                    card.parentNode.replaceChild(newCard, card);
                    // 添加新的点击事件监听器
                    addTouchAndClickEvent(newCard, () => selectCharacter(newCard.dataset.character));
                });
            }
        }

        // 添加日志
        function addLog(message) {
            gameState.battleLog.push(message);
            updateBattleLog();
        }

        // 更新战斗日志
        function updateBattleLog() {
            // 确保即使在BOSS关卡中也能正确找到战斗日志元素
            let logContainer = document.getElementById('battleLog');
            
            // 如果找不到，尝试重新获取元素（处理动态加载的情况）
            if (!logContainer) {
                // 检查battleScreen是否已经显示
                const battleScreen = document.getElementById('battleScreen');
                if (battleScreen && battleScreen.classList.contains('active')) {
                    // 创建日志容器元素如果不存在
                    logContainer = document.createElement('div');
                    logContainer.id = 'battleLog';
                    logContainer.className = 'log';
                    
                    // 添加到battleScreen中
                    const battleScreenContent = battleScreen.querySelector('div');
                    if (battleScreenContent) {
                        battleScreenContent.appendChild(logContainer);
                    }
                }
            }
            
            if (logContainer) {
                logContainer.innerHTML = '';
                gameState.battleLog.slice(-10).forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.textContent = log;
                    
                    // 根据日志内容添加不同的CSS类，应用不同的颜色样式
                    if (log.includes('伤害') || log.includes('攻击') || log.includes('杀死')) {
                        logEntry.classList.add('damage');
                    } else if (log.includes('恢复') || log.includes('治疗') || log.includes('生命')) {
                        logEntry.classList.add('heal');
                    } else if (log.includes('获得') || log.includes('增强') || log.includes('护盾') || log.includes('能量')) {
                        logEntry.classList.add('buff');
                    } else if (log.includes('虚弱') || log.includes('中毒') || log.includes('减益') || log.includes('诅咒')) {
                        logEntry.classList.add('debuff');
                    } else {
                        logEntry.classList.add('system');
                    }
                    
                    logContainer.appendChild(logEntry);
                });
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // 启动游戏
        initGame();
        
        // 教程系统逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 使用class选择器选择右上角的教程按钮，避免id重复问题
            const tutorialButton = document.querySelector('.tutorial-button');
            const tutorialModal = document.getElementById('tutorialModal');
            const closeTutorial = document.getElementById('closeTutorial');
            const tutorialClose = document.querySelector('.tutorial-close');
            
            // 显示教程弹窗
            function showTutorial() {
                tutorialModal.style.display = 'block';
                // 添加淡入动画
                setTimeout(() => {
                    tutorialModal.querySelector('.tutorial-content').style.opacity = '1';
                }, 10);
            }
            
            // 隐藏教程弹窗
            function hideTutorial() {
                const tutorialContent = tutorialModal.querySelector('.tutorial-content');
                tutorialContent.style.opacity = '0';
                // 添加淡出动画
                setTimeout(() => {
                    tutorialModal.style.display = 'none';
                }, 300);
            }
            
            // 点击教程按钮显示弹窗
            addTouchAndClickEvent(tutorialButton, showTutorial);
            
            // 点击关闭按钮隐藏弹窗
            addTouchAndClickEvent(closeTutorial, hideTutorial);
            addTouchAndClickEvent(tutorialClose, hideTutorial);
            
            // 添加教程选项卡的触摸和点击事件
            document.querySelectorAll('.tutorial-tab').forEach(tab => {
                addTouchAndClickEvent(tab, (event) => {
                    openTutorialTab(event, tab.dataset.tab);
                });
            });
            
            // 点击弹窗外部关闭弹窗
            window.addEventListener('click', function(event) {
                if (event.target === tutorialModal) {
                    hideTutorial();
                }
            });
            
            // 键盘Escape键关闭弹窗
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && tutorialModal.style.display === 'block') {
                    hideTutorial();
                }
            });
        });
        
        // 教程标签页切换功能
        function openTutorialTab(evt, tabName) {
            // 获取所有标签页内容和按钮
            const tabContent = document.getElementsByClassName('tutorial-tab-content');
            const tabLinks = document.getElementsByClassName('tutorial-tab');
            
            // 隐藏所有标签页内容
            for (let i = 0; i < tabContent.length; i++) {
                tabContent[i].classList.remove('active');
            }
            
            // 移除所有标签页按钮的活动状态
            for (let i = 0; i < tabLinks.length; i++) {
                tabLinks[i].classList.remove('active');
            }
            
            // 显示当前标签页内容并激活当前按钮
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            // 滚动到标签页顶部
            document.getElementById(tabName).scrollTop = 0;
        }
        
        // 怪物图鉴功能
        document.addEventListener('DOMContentLoaded', function() {
            const monsterPediaButton = document.getElementById('monsterPediaButton');
            const monsterPediaModal = document.getElementById('monsterPediaModal');
            const closeMonsterPedia = document.getElementById('closeMonsterPedia');
            const monsterPediaClose = document.querySelector('.monster-pedia-close');
            
            // 显示怪物图鉴弹窗
            function showMonsterPedia() {
                monsterPediaModal.style.display = 'block';
                // 添加淡入动画
                setTimeout(() => {
                    monsterPediaModal.querySelector('.monster-pedia-content').style.opacity = '1';
                }, 10);
            }
            
            // 隐藏怪物图鉴弹窗
            function hideMonsterPedia() {
                const monsterPediaContent = monsterPediaModal.querySelector('.monster-pedia-content');
                monsterPediaContent.style.opacity = '0';
                // 添加淡出动画
                setTimeout(() => {
                    monsterPediaModal.style.display = 'none';
                }, 300);
            }
            
            // 点击怪物图鉴按钮显示弹窗
            addTouchAndClickEvent(monsterPediaButton, showMonsterPedia);
            
            // 点击关闭按钮隐藏弹窗
            addTouchAndClickEvent(closeMonsterPedia, hideMonsterPedia);
            addTouchAndClickEvent(monsterPediaClose, hideMonsterPedia);
            
            // 添加怪物图鉴选项卡的触摸和点击事件
            document.querySelectorAll('.monster-pedia-tab').forEach(tab => {
                addTouchAndClickEvent(tab, (event) => {
                    openMonsterPediaTab(event, tab.dataset.tab);
                });
            });
            
            // 点击弹窗外部关闭弹窗
            window.addEventListener('click', function(event) {
                if (event.target === monsterPediaModal) {
                    hideMonsterPedia();
                }
            });
            
            // 键盘Escape键关闭弹窗
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && monsterPediaModal.style.display === 'block') {
                    hideMonsterPedia();
                }
            });
        });
        
        // 怪物图鉴标签页切换功能
        function openMonsterPediaTab(evt, tabName) {
            // 获取所有标签页内容和按钮
            const tabContent = document.getElementsByClassName('monster-pedia-tab-content');
            const tabLinks = document.getElementsByClassName('monster-pedia-tab');
            
            // 隐藏所有标签页内容
            for (let i = 0; i < tabContent.length; i++) {
                tabContent[i].classList.remove('active');
            }
            
            // 移除所有标签页按钮的活动状态
            for (let i = 0; i < tabLinks.length; i++) {
                tabLinks[i].classList.remove('active');
            }
            
            // 显示当前标签页内容并激活当前按钮
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            // 滚动到标签页顶部
            document.getElementById(tabName).scrollTop = 0;
        }
    </script>
</body>
</html>
